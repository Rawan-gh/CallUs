<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Choose a Template - Presentation Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyDPzRqV-_hGNedZoeGNtorLTGWTBMmqdkc",
        authDomain: "prj-adc-gcp-coop-test.firebaseapp.com",
        projectId: "prj-adc-gcp-coop-test",
        storageBucket: "prj-adc-gcp-coop-test.firebasestorage.app",
        messagingSenderId: "472242813268",
        appId: "1:472242813268:web:4e7b4650015fd473d4f0c1",
        measurementId: "G-RGEPGD1T9T"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app, 'bettercallus');
      const auth = getAuth(app);
      
      // Make available globally
      window.firebaseApp = app;
      window.firebaseAnalytics = analytics;
      window.firebaseDb = db;
      window.firebaseAuth = auth;

      const storedUserId = localStorage.getItem('pm-user-id');
      if (storedUserId) {
        window.currentUserId = storedUserId;
      }

      let lastDispatchedUserId = null;
      const dispatchUserReady = (userId) => {
        if (!userId || userId === lastDispatchedUserId) {
          return;
        }
        lastDispatchedUserId = userId;
        window.dispatchEvent(new CustomEvent('pm-user-ready', { detail: { userId } }));
      };

      if (storedUserId) {
        window.setTimeout(() => dispatchUserReady(storedUserId), 0);
      }
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.currentUserId = user.uid;
          localStorage.setItem('pm-user-id', user.uid);
          if (user.email) {
            localStorage.setItem('pm-user-email', user.email);
          }
          localStorage.setItem('pm-logged-in', 'true');
          dispatchUserReady(user.uid);
          console.log('User authenticated in templates:', user.uid);
        } else if (storedUserId) {
          window.currentUserId = storedUserId;
          dispatchUserReady(storedUserId);
          console.log('Using stored user ID in templates:', storedUserId);
        } else {
          localStorage.removeItem('pm-logged-in');
          window.location.replace('login.html');
        }
      });
      
      console.log('Firebase initialized in templates with database: bettercallus');
    </script>
    <script>
      if (localStorage.getItem('pm-logged-in') !== 'true') {
        window.location.replace('login.html')
      }
    </script>
    <style>
      /* AI Template Animations */
      @keyframes gradient-shimmer {
        0%, 100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      @keyframes pulse-glow {
        0%, 100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4),
                      0 0 20px -5px rgba(16, 185, 129, 0.3);
        }
        50% {
          box-shadow: 0 0 0 8px rgba(16, 185, 129, 0),
                      0 0 30px -2px rgba(16, 185, 129, 0.5);
        }
      }

      @keyframes float {
        0%, 100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      @keyframes shimmer-slide {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      @keyframes badge-pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.9;
        }
      }

      @keyframes text-shimmer {
        0%, 100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      @keyframes button-glow {
        0%, 100% {
          box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.3),
                      0 0 0 0 rgba(16, 185, 129, 0.4);
        }
        50% {
          box-shadow: 0 4px 20px 0 rgba(16, 185, 129, 0.5),
                      0 0 0 4px rgba(16, 185, 129, 0.1);
        }
      }

      .ai-template-gradient {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(255, 255, 255, 0.5) 25%,
          rgba(14, 165, 233, 0.1) 50%,
          rgba(255, 255, 255, 0.5) 75%,
          rgba(16, 185, 129, 0.1) 100%
        );
        background-size: 200% 200%;
        animation: gradient-shimmer 4s ease-in-out infinite;
      }

      .ai-template-card {
        animation: pulse-glow 3s ease-in-out infinite;
      }

      .ai-template-badge {
        animation: badge-pulse 2s ease-in-out infinite;
      }

      .ai-template-element {
        animation: float 4s ease-in-out infinite;
      }

      .ai-template-element-delayed {
        animation: float 4s ease-in-out infinite;
        animation-delay: 1s;
      }

      .ai-template-shimmer {
        position: relative;
        overflow: hidden;
      }

      .ai-template-shimmer::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: shimmer-slide 3s ease-in-out infinite;
      }

      .ai-template-title {
        background: linear-gradient(
          90deg,
          #1e293b 0%,
          #10b981 50%,
          #1e293b 100%
        );
        background-size: 200% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: text-shimmer 3s ease-in-out infinite;
      }

      .ai-template-use-btn {
        animation: button-glow 2s ease-in-out infinite;
      }
    </style>
  </head>
  <body class="bg-white text-slate-900 antialiased">
    <link rel="stylesheet" href="./templates.css">
    <div class="flex min-h-screen bg-white text-slate-900">
      <aside class="hidden w-44 flex-shrink-0 flex-col justify-between border-r border-slate-200 bg-white py-5 text-slate-700 md:flex">
        <div>
          <div class="px-3">
            <div class="flex items-center gap-3">
              <div class="flex h-9 w-9 items-center justify-center rounded-full bg-emerald-500/10 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-500/40" data-user-initials>RA</div>
              <div>
                <p class="text-sm font-semibold uppercase tracking-wide text-slate-900" data-user-name>Renad Alm.</p>
                <p class="text-xs text-slate-400">Workspace</p>
              </div>
            </div>
          </div>
          <nav class="mt-6 space-y-1.5 px-1.5">
            <a href="index.html" class="flex items-center gap-2.5 rounded-lg px-3 py-2 text-sm font-medium text-slate-600 transition hover:bg-emerald-50 hover:text-emerald-700" data-nav-link="home">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 1.293a1 1 0 0 0-1.414 0l-7 7a1 1 0 0 0 1.414 1.414L4 8.414V17a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-3h2v3a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1V8.414l.293.293a1 1 0 0 0 1.414-1.414l-7-7Z"/>
              </svg>
              Home
            </a>
            <a href="editor-blank.html" class="flex items-center gap-2.5 rounded-lg px-3 py-2 text-sm font-medium text-slate-600 transition hover:bg-emerald-50 hover:text-emerald-700" data-nav-link="new">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
              </svg>
              New
            </a>
            <a href="#recent" class="flex items-center gap-2.5 rounded-lg px-3 py-2 text-sm font-medium text-slate-600 transition hover:bg-emerald-50 hover:text-emerald-700" data-nav-link="recent">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h6"/>
                <circle cx="12" cy="12" r="9"/>
              </svg>
              Recent
            </a>
            <a href="#shared" class="flex items-center gap-2.5 rounded-lg px-3 py-2 text-sm font-medium text-slate-600 transition hover:bg-emerald-50 hover:text-emerald-700" data-nav-link="shared">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              Shared
            </a>
          </nav>
        </div>
      </aside>
      <div class="flex flex-1 flex-col">
        <header class="mx-auto w-full max-w-7xl px-4 py-6 flex items-center justify-start">
      <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:58px;" />
    </header>

        <main class="relative isolate flex-1">
      <div class="absolute inset-x-0 -top-20 -z-10 blur-3xl opacity-40" aria-hidden="true">
        <div class="mx-auto aspect-[4/1] max-w-4xl bg-gradient-to-r from-emerald-400 via-teal-300 to-sky-400"></div>
      </div>

      <section class="mx-auto max-w-6xl px-6 pb-16">
        <div class="mb-10 flex flex-col gap-6" id="recent">
          <div class="relative overflow-hidden rounded-3xl border border-emerald-100 bg-white px-8 py-10 text-slate-900 shadow-xl shadow-emerald-500/10">
            <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\"140\" height=\"140\" viewBox=\"0 0 160 160\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Ccircle cx=\"40\" cy=\"40\" r=\"1\" fill=\"rgba(16,185,129,0.08)\"/%3E%3Ccircle cx=\"120\" cy=\"120\" r=\"1\" fill=\"rgba(20,184,166,0.08)\"/%3E%3Ccircle cx=\"40\" cy=\"120\" r=\"1\" fill=\"rgba(14,165,233,0.04)\"/%3E%3Ccircle cx=\"120\" cy=\"40\" r=\"1\" fill=\"rgba(16,185,129,0.05)\"/%3E%3C/svg%3E')] opacity-70"></div>
            <div class="absolute -top-24 -right-16 h-56 w-56 rounded-full bg-gradient-to-br from-emerald-200/60 via-teal-100/50 to-sky-200/30 blur-3xl"></div>
            <div class="absolute bottom-0 left-0 h-32 w-full bg-gradient-to-r from-emerald-100/40 via-transparent to-sky-100/40"></div>
            <div class="relative flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between">
              <div>
                <p class="text-sm font-semibold uppercase tracking-[0.3em] text-emerald-500">Welcome back</p>
                <h1 class="mt-3 text-3xl sm:text-4xl font-semibold tracking-tight text-slate-900" data-dashboard-greeting>Pick a template to get started</h1>
                <div class="mt-5 flex h-2 w-28 items-center overflow-hidden rounded-full bg-emerald-500/15">
                  <span class="h-full w-1/2 rounded-full bg-gradient-to-r from-emerald-500 via-teal-400 to-sky-500"></span>
                </div>
                <p class="mt-4 max-w-xl text-base text-slate-600" data-dashboard-subtitle>Letâ€™s craft something remarkable today.</p>
              </div>
              <div class="flex flex-col items-start gap-4 rounded-2xl border border-emerald-100/70 bg-emerald-50/70 px-5 py-4 backdrop-blur">
                <div class="inline-flex items-center gap-2 rounded-full bg-emerald-100 px-4 py-1 text-sm font-semibold text-emerald-700">
                  <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                  <span data-active-count-label>0 active decks</span>
                </div>
                <div class="space-y-2 text-sm text-slate-700">
                  <div class="flex items-center gap-3 rounded-2xl bg-white px-4 py-3 shadow-sm shadow-emerald-500/10">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/10 text-base font-semibold text-emerald-600">1</span>
                    <div>
                      <p class="font-semibold leading-tight text-slate-900">New template this week</p>
                      <p class="text-xs text-slate-500">Blank canvas refreshed with exec branding.</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-3 rounded-2xl bg-white px-4 py-3 shadow-sm shadow-emerald-500/10">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-sky-500/10 text-base font-semibold text-sky-600">2</span>
                    <div>
                      <p class="font-semibold leading-tight text-slate-900">Feedback requests</p>
                      <p class="text-xs text-slate-500">Slide notes awaiting review today.</p>
                    </div>
                  </div>
                  <div class="flex items-center gap-3 rounded-2xl bg-white px-4 py-3 shadow-sm shadow-emerald-500/10">
                    <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/10 text-base font-semibold text-amber-600">Fri</span>
                    <div>
                      <p class="font-semibold leading-tight text-slate-900">Next deadline</p>
                      <p class="text-xs text-slate-500">Sustainability briefing due Friday 4 PM.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-emerald-100 bg-white/80 px-4 py-3 shadow-sm backdrop-blur" data-quick-actions>
            <div class="text-sm font-semibold text-emerald-700 uppercase tracking-[0.25em]">Quick actions</div>
            <div class="flex flex-wrap items-center gap-2">
              <button class="group inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-4 py-2 text-sm font-medium text-emerald-700 shadow-sm transition hover:border-emerald-400 hover:shadow-md" data-action="import">
                <span class="h-2 w-2 rounded-full bg-emerald-500 group-hover:scale-125 transition"></span>
                Import PowerPoint
              </button>
              <button class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-400" data-action="share">
                <span class="h-2 w-2 rounded-full bg-white/80"></span>
                Share with team
              </button>
            </div>
            <input id="quick-import-input" type="file" accept=".ppt,.pptx,.pdf" class="hidden" />
          </div>

          <div class="mt-3 hidden items-center gap-2 rounded-xl border px-4 py-3 text-sm shadow-sm" data-action-message>
            <span class="h-2 w-2 rounded-full" data-action-indicator></span>
            <span data-action-message-text></span>
          </div>
        </div>

        <!-- Custom Templates Section -->
        <div class="mt-12">
          <h2 class="text-xl font-semibold text-slate-900 mb-4">Create New Presentation</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
          <!-- Aramco Style 1 -->
          <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md">
            <div class="aspect-[16/10] relative">
              <div class="absolute inset-0 bg-white"></div>
              <!-- Three simple gray lines representing text content -->
              <div class="absolute left-4 top-8 h-2 w-24 bg-slate-300 rounded"></div>
              <div class="absolute left-4 top-12 h-2 w-20 bg-slate-200 rounded"></div>
              <div class="absolute left-4 top-16 h-2 w-28 bg-slate-200/70 rounded"></div>
            </div>
            <div class="border-t border-slate-200"></div>
            <div class="p-4 flex items-center justify-between gap-4">
              <div class="flex-1">
                <h3 class="font-semibold">Blank</h3>
                <p class="mt-1 text-xs text-slate-500">Start from scratch with a clean slate.</p>
              </div>
              <a href="editor-blank.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500">Use</a>
            </div>
          </div>

          <!-- Aramco Style 2 -->
          <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md">
            <div class="aspect-[16/10] relative">
              <div class="absolute inset-0 bg-gradient-to-br from-emerald-50/30 to-sky-50/30"></div>
              <!-- Slide preview with dashed border -->
              <div class="absolute inset-x-3 inset-y-3 rounded-lg bg-white border-2 border-dashed border-emerald-200/60">
                <!-- Logo -->
                <div class="absolute left-3 top-2">
                  <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:24px; opacity:0.8;" />
                </div>
                <!-- Two simple gray lines representing text content -->
                <div class="absolute left-3 top-8 h-2 w-20 bg-slate-300/60 rounded"></div>
                <div class="absolute left-3 top-11 h-2 w-16 bg-slate-200/60 rounded"></div>
              </div>
              <!-- Gradient bar at bottom -->
              <div class="absolute bottom-0 left-0 right-0 h-2 bg-gradient-to-r from-emerald-500 via-teal-400 to-sky-500 rounded-b-lg"></div>
            </div>
            <div class="p-4 flex items-center justify-between gap-4">
              <div class="flex-1">
                <h3 class="font-semibold">AD Template</h3>
              </div>
              <a href="editor-ad.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500">Use</a>
            </div>
          </div>

          <!-- AI Storytelling Template -->
          <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md ai-template-card">
            <div class="aspect-[16/10] relative ai-template-shimmer">
              <div class="absolute inset-0 ai-template-gradient"></div>
              <div class="absolute inset-0 rounded-[20px] border border-emerald-100/70"></div>
              <div class="absolute top-4 left-4 h-3 w-20 rounded bg-emerald-100 ai-template-element"></div>
              <div class="absolute top-8 left-4 h-2 w-32 rounded bg-emerald-50 ai-template-element-delayed"></div>
              <div class="absolute inset-x-8 bottom-6 h-16 rounded-3xl border border-emerald-100/70 bg-white/80 shadow-[0_14px_36px_-24px_rgba(16,185,129,0.55)] ai-template-element"></div>
              <!-- Preview elements showing AI editor structure -->
              <div class="absolute left-4 top-14 h-2 w-24 rounded bg-emerald-50/80 ai-template-element-delayed"></div>
              <div class="absolute left-4 top-18 h-2 w-16 rounded bg-emerald-50/60 ai-template-element"></div>
              <div class="absolute left-4 top-22 h-2 w-20 rounded bg-emerald-50/40 ai-template-element-delayed"></div>
              <div class="absolute top-6 right-6 flex items-center gap-2 rounded-full border border-emerald-200 bg-white/90 px-3 py-1.5 text-[0.7rem] font-bold uppercase tracking-[0.2em] text-emerald-600 ai-template-badge">
                AI
              </div>
            </div>
            <div class="p-4 flex items-center justify-between gap-4">
              <div class="flex-1">
                <h3 class="font-semibold ai-template-title">AI Template</h3>
                <p class="mt-1 text-xs text-slate-500">Jump-start insights-driven storytelling.</p>
              </div>
              <a href="editor-ai.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500 ai-template-use-btn">Use</a>
            </div>
          </div>
        </div>

        <!-- Aramco Digital Standard Templates Section -->
        <div class="mt-12">
          <h2 class="text-xl font-semibold text-slate-900 mb-4">Aramco Digital Standard Templates</h2>
          <p class="text-sm text-slate-600 mb-6">Ready-to-use templates for common Aramco Digital presentations</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4">
            <!-- ADOS Project Update Template -->
            <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md">
              <div class="aspect-[16/10] relative">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-50/50 to-indigo-50/50"></div>
                <!-- Template preview -->
                <div class="absolute inset-x-3 inset-y-3 rounded-lg bg-white border border-slate-200">
                  <!-- Header section -->
                  <div class="absolute top-2 left-2 right-2 h-6 bg-gradient-to-r from-blue-500 to-indigo-500 rounded"></div>
                  <!-- Title line -->
                  <div class="absolute left-2 top-4 h-2 w-32 bg-slate-400 rounded"></div>
                  <!-- Content lines -->
                  <div class="absolute left-2 top-7 h-1.5 w-28 bg-slate-300 rounded"></div>
                  <div class="absolute left-2 top-9 h-1.5 w-24 bg-slate-200 rounded"></div>
                  <!-- Project status indicator -->
                  <div class="absolute bottom-2 left-2 right-2 h-4 bg-slate-100 rounded border border-slate-200"></div>
                </div>
              </div>
              <div class="p-4 flex items-center justify-between gap-4">
                <div class="flex-1">
                  <h3 class="font-semibold text-sm">ADOS Project Update</h3>
                  <p class="mt-1 text-xs text-slate-500">Project status and updates template</p>
                </div>
                <a href="editor-1.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500">Use</a>
              </div>
            </div>

            <!-- SA SCDT - AD Governance Process Template -->
            <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md">
              <div class="aspect-[16/10] relative">
                <div class="absolute inset-0 bg-gradient-to-br from-emerald-50/50 to-teal-50/50"></div>
                <!-- Template preview -->
                <div class="absolute inset-x-3 inset-y-3 rounded-lg bg-white border border-slate-200">
                  <!-- Logo area -->
                  <div class="absolute top-2 left-2">
                    <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:20px; opacity:0.8;" />
                  </div>
                  <!-- Title -->
                  <div class="absolute left-2 top-5 h-2 w-36 bg-slate-500 rounded"></div>
                  <!-- Process flow indicators -->
                  <div class="absolute left-2 top-9 flex gap-2">
                    <div class="h-3 w-3 rounded-full bg-emerald-400"></div>
                    <div class="h-3 w-3 rounded-full bg-slate-300"></div>
                    <div class="h-3 w-3 rounded-full bg-slate-300"></div>
                  </div>
                  <!-- Content lines -->
                  <div class="absolute left-2 top-13 h-1.5 w-28 bg-slate-300 rounded"></div>
                  <div class="absolute left-2 top-15 h-1.5 w-24 bg-slate-200 rounded"></div>
                </div>
              </div>
              <div class="p-4 flex items-center justify-between gap-4">
                <div class="flex-1">
                  <h3 class="font-semibold text-sm">SA SCDT - AD Governance</h3>
                  <p class="mt-1 text-xs text-slate-500">Governance process template</p>
                </div>
                <a href="editor-2.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500">Use</a>
              </div>
            </div>

            <!-- SAO PowerPoint Master Template -->
            <div class="group rounded-xl bg-white ring-1 ring-slate-200 shadow-sm overflow-hidden w-full max-w-lg sm:max-w-md mx-auto transition transform duration-200 hover:-translate-y-1 hover:ring-emerald-400 hover:ring-2 hover:shadow-md">
              <div class="aspect-[16/10] relative">
                <div class="absolute inset-0 bg-gradient-to-br from-slate-50 to-white"></div>
                <!-- Template preview -->
                <div class="absolute inset-x-3 inset-y-3 rounded-lg bg-white border-2 border-slate-300">
                  <!-- Master header -->
                  <div class="absolute top-0 left-0 right-0 h-8 bg-slate-700 rounded-t"></div>
                  <!-- Logo in header -->
                  <div class="absolute top-1 left-2">
                    <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:18px; opacity:0.9;" />
                  </div>
                  <!-- Title area -->
                  <div class="absolute left-3 top-10 h-2.5 w-40 bg-slate-600 rounded"></div>
                  <!-- Subtitle -->
                  <div class="absolute left-3 top-13 h-1.5 w-32 bg-slate-400 rounded"></div>
                  <!-- Content section -->
                  <div class="absolute left-3 top-16 right-3 space-y-1">
                    <div class="h-1.5 w-full bg-slate-300 rounded"></div>
                    <div class="h-1.5 w-5/6 bg-slate-200 rounded"></div>
                    <div class="h-1.5 w-4/6 bg-slate-200 rounded"></div>
                  </div>
                  <!-- Footer -->
                  <div class="absolute bottom-0 left-0 right-0 h-4 bg-slate-100 border-t border-slate-300 rounded-b"></div>
                </div>
              </div>
              <div class="p-4 flex items-center justify-between gap-4">
                <div class="flex-1">
                  <h3 class="font-semibold text-sm">SAO Master Template</h3>
                  <p class="mt-1 text-xs text-slate-500">Official Aramco Digital master template</p>
                </div>
                <a href="editor-3.html" class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-medium text-white hover:bg-emerald-500">Use</a>
              </div>
            </div>
          </div>
        </div>

        <hr class="mt-8 border-t border-emerald-200" />

        <section class="mt-12 rounded-2xl bg-slate-50 p-6 sm:p-8 ring-1 ring-slate-200">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-2xl font-semibold text-slate-900">Recent Work</h2>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <button
                id="selectModeBtn"
                class="inline-flex items-center gap-1.5 rounded-full border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 11 12 14 22 4"></polyline>
                  <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
                Select
              </button>
              <div id="selectionActions" class="hidden flex items-center gap-2 flex-wrap">
                <button
                  id="selectAllPresentationsBtn"
                  class="inline-flex items-center gap-1.5 rounded-full border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                  </svg>
                  Select All
                </button>
                <button
                  id="deleteSelectedPresentationsBtn"
                  class="inline-flex items-center gap-1.5 rounded-full border border-red-300 bg-white px-3 py-1.5 text-xs font-medium text-red-600 shadow-sm hover:bg-red-50 hover:border-red-400 transition"
                  disabled
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                  Delete Selected (<span id="selectedCount">0</span>)
                </button>
                <button
                  id="deleteAllPresentationsBtn"
                  class="inline-flex items-center gap-1.5 rounded-full border border-red-300 bg-white px-3 py-1.5 text-xs font-medium text-red-600 shadow-sm hover:bg-red-50 hover:border-red-400 transition"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  </svg>
                  Delete All
                </button>
                <button
                  id="duplicateSelectedPresentationsBtn"
                  class="inline-flex items-center gap-1.5 rounded-full border border-sky-300 bg-white px-3 py-1.5 text-xs font-medium text-sky-600 shadow-sm hover:bg-sky-50 hover:border-sky-400 transition"
                  disabled
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  Duplicate Selected (<span id="duplicateSelectedCount">0</span>)
                </button>
              </div>
              <button
                id="shareAllPresentationsBtn"
                class="inline-flex items-center gap-1.5 rounded-full border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 shadow-sm hover:bg-slate-50 transition"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                  <polyline points="16 6 12 2 8 6"></polyline>
                  <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
                Share
              </button>
            </div>
          </div>

          <div class="mt-6 flex items-center gap-2 text-sm text-slate-500 hidden" data-user-presentations-loading>
            <span class="inline-flex h-2 w-2 animate-pulse rounded-full bg-emerald-500"></span>
            Loading your saved decks...
          </div>
          <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 hidden" data-user-presentations-list></div>
          <div class="mt-6 rounded-xl border border-dashed border-slate-300 bg-white p-6 text-center text-sm text-slate-500" data-user-presentations-empty>
            Saved presentations will appear here once you create your first deck.
          </div>
          <div class="mt-6 flex justify-center">
            <a
              href="#"
              class="inline-flex items-center gap-1.5 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-500"
            >
              View all decks
            </a>
          </div>
        </section>

        <section id="shared" class="mt-12 rounded-2xl bg-slate-50 p-6 sm:p-8 ring-1 ring-slate-200">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-2xl font-semibold text-slate-900">Shared with you</h2>
              <p class="mt-1 text-sm text-slate-600">
                Presentations shared with you by your team members. You can view and edit them collaboratively.
              </p>
            </div>
          </div>

          <div class="mt-6 flex items-center gap-2 text-sm text-slate-500 hidden" data-shared-presentations-loading>
            <span class="inline-flex h-2 w-2 animate-pulse rounded-full bg-emerald-500"></span>
            Loading shared presentations...
          </div>
          <div class="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 hidden" data-shared-presentations-list></div>
          <div class="mt-6 rounded-xl border border-dashed border-slate-300 bg-white p-6 text-center text-sm text-slate-500" data-shared-presentations-empty>
            Shared presentations will appear here once someone invites you to collaborate.
          </div>
        </section>

      </section>
    </main>
            </div>
          </div>

    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm" data-share-modal>
      <div class="relative mx-4 w-full max-w-md rounded-2xl bg-white shadow-2xl ring-1 ring-slate-200">
        <div class="absolute -top-24 -right-16 h-56 w-56 rounded-full bg-gradient-to-br from-emerald-200/60 via-teal-100/50 to-sky-200/30 blur-3xl"></div>
        <div class="relative p-6">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-slate-900" data-share-title>Share presentation</h3>
            <button class="rounded-lg p-1.5 text-slate-400 transition hover:bg-slate-100 hover:text-slate-600" data-share-close>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>

          <p class="mb-4 text-sm text-slate-600">
            Enter email addresses separated by commas or one per line. Everyone will be able to view and edit this presentation.
          </p>
          
          <div class="mb-4">
            <label class="mb-2 block text-sm font-medium text-slate-700">Email addresses</label>
            <textarea
              id="shareEmailsInput"
              rows="4"
              class="w-full rounded-lg border border-slate-300 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 shadow-sm transition focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/20"
              placeholder="user1@example.com, user2@example.com&#10;user3@example.com"
            ></textarea>
            <p class="mt-1.5 text-xs text-slate-500">You can add multiple emails separated by commas or new lines</p>
            </div>
          
          <div class="flex items-center gap-3">
            <button
              class="flex-1 rounded-lg border border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50"
              data-share-cancel
            >
              Cancel
            </button>
            <button
              class="flex-1 rounded-lg bg-emerald-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-600"
              data-share-submit
            >
              <span class="inline-flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                  <polyline points="16 6 12 2 8 6"></polyline>
                  <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
                Share
              </span>
            </button>
                </div>
                </div>
                </div>
          </div>

    <script>
      ;(() => {
        const storedName = localStorage.getItem('pm-user-name')
        const defaultName = 'Renad Alm.'
        const nameToShow = storedName && storedName.trim().length ? storedName : defaultName

        document.querySelectorAll('[data-user-name]').forEach((el) => {
          el.textContent = nameToShow
        })

        const initials = nameToShow
          .split(/\s+/)
          .filter(Boolean)
          .map((segment) => segment.charAt(0).toUpperCase())
          .join('')
          .slice(0, 2)

        document.querySelectorAll('[data-user-initials]').forEach((el) => {
          el.textContent = initials || 'RA'
        })

        const firstName = nameToShow.split(/\s+/).filter(Boolean)[0] || 'there'
        const hour = new Date().getHours()
        const greeting =
          hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening'

        document.querySelectorAll('[data-dashboard-greeting]').forEach((el) => {
          el.textContent = `${greeting}, ${firstName}.`
        })

        document.querySelectorAll('[data-dashboard-subtitle]').forEach((el) => {
          el.textContent = "Let's craft something remarkable today."
        })

        const navLinks = document.querySelectorAll('[data-nav-link]')
        const activeClasses = ['bg-emerald-500/10', 'text-emerald-700', 'ring-1', 'ring-emerald-500/30', 'font-semibold']
        const inactiveClasses = ['text-slate-600', 'font-medium']

        function applyNavState(link, isActive) {
          activeClasses.forEach((cls) => link.classList.toggle(cls, isActive))
          inactiveClasses.forEach((cls) => link.classList.toggle(cls, !isActive))
        }

        function activateNav(id) {
          navLinks.forEach((link) => {
            applyNavState(link, link.dataset.navLink === id)
          })
        }

        navLinks.forEach((link) => {
          const href = link.getAttribute('href') || ''
          if (href.startsWith('#')) {
            link.addEventListener('click', (event) => {
              event.preventDefault()
              const target = document.querySelector(href)
              if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' })
              }
              activateNav(link.dataset.navLink)
            })
          } else {
            link.addEventListener('click', () => activateNav(link.dataset.navLink))
          }
        })

        const quickActionsRoot = document.querySelector('[data-quick-actions]')
        const actionMessage = document.querySelector('[data-action-message]')
        const actionMessageText = document.querySelector('[data-action-message-text]')
        const actionIndicator = document.querySelector('[data-action-indicator]')
        const importInput = document.getElementById('quick-import-input')

        const messageVariants = {
          success: {
            container: ['bg-emerald-50', 'border-emerald-200', 'text-emerald-700'],
            indicator: 'bg-emerald-500',
          },
          info: {
            container: ['bg-sky-50', 'border-sky-200', 'text-sky-700'],
            indicator: 'bg-sky-500',
          },
          warning: {
            container: ['bg-amber-50', 'border-amber-200', 'text-amber-700'],
            indicator: 'bg-amber-500',
          },
        }

        function resetMessageState() {
          actionMessage?.classList.add('hidden')
          actionMessage?.classList.remove(
            'bg-emerald-50',
            'border-emerald-200',
            'text-emerald-700',
            'bg-sky-50',
            'border-sky-200',
            'text-sky-700',
            'bg-amber-50',
            'border-amber-200',
            'text-amber-700'
          )
        }

        function showActionMessage(type, text) {
          if (!actionMessage || !actionIndicator || !actionMessageText) return
          const variant = messageVariants[type] || messageVariants.info

          resetMessageState()
          actionMessage.classList.remove('hidden')
          actionMessage.classList.add('border')
          actionMessageText.textContent = text

          variant.container.forEach((cls) => actionMessage.classList.add(cls))
          actionIndicator.className = `h-2 w-2 rounded-full ${variant.indicator}`
        }

        // Make showActionMessage available globally
        window.showActionMessage = showActionMessage

        quickActionsRoot?.querySelectorAll('[data-action]').forEach((button) => {
          button.addEventListener('click', () => {
            const action = button.dataset.action

            if (action === 'import') {
              importInput?.click()
              return
            }

            if (action === 'share') {
              showActionMessage('info', 'Use the Share button on any presentation card to share it with others.')
              return
            }

          })
        })

        // Share All button
        const shareAllBtn = document.getElementById('shareAllPresentationsBtn');
        shareAllBtn?.addEventListener('click', () => {
          showActionMessage('info', 'Select presentations first, then use the Share button on each card to share them.')
        })

        importInput?.addEventListener('change', (event) => {
          const files = event.target.files
          if (files && files.length > 0) {
            const fileNames = Array.from(files)
              .map((file) => file.name)
              .join(', ')
            showActionMessage('success', `Imported ${fileNames}. Ready to upload.`)
            importInput.value = ''
          } else {
            showActionMessage('warning', 'No file selected for import.')
          }
        })

        activateNav('recent')

        // Share Modal functionality
        const shareModal = document.querySelector('[data-share-modal]');
        const shareTitle = document.querySelector('[data-share-title]');
        const shareEmailsInput = document.getElementById('shareEmailsInput');
        const shareClose = document.querySelector('[data-share-close]');
        const shareCancel = document.querySelector('[data-share-cancel]');
        const shareSubmit = document.querySelector('[data-share-submit]');
        
        let currentSharePresentationId = null;
        let currentSharePresentationTitle = null;

        function openShareModal(presentationId, presentationTitle) {
          console.log('openShareModal called', { presentationId, presentationTitle, hasShareModal: !!shareModal });
          
          if (!window.sharePresentation) {
            console.warn('sharePresentation not available');
            if (window.showActionMessage) {
              window.showActionMessage('warning', 'Share function not available. Please refresh the page.');
            }
            return;
          }

          currentSharePresentationId = presentationId;
          currentSharePresentationTitle = presentationTitle;
          // Also store in window for fallback access
          window.currentSharePresentationId = presentationId;
          window.currentSharePresentationTitle = presentationTitle;
          
          if (shareTitle) {
            shareTitle.textContent = `Share "${presentationTitle}"`;
          }
          
          if (shareEmailsInput) {
            shareEmailsInput.value = '';
            shareEmailsInput.focus();
          }
          
          if (shareModal) {
            console.log('Opening modal');
            shareModal.classList.remove('hidden');
            shareModal.classList.add('flex');
          } else {
            console.error('shareModal element not found!');
          }
        }

        function closeShareModal() {
          if (shareModal) {
            shareModal.classList.add('hidden');
            shareModal.classList.remove('flex');
          }
          currentSharePresentationId = null;
          currentSharePresentationTitle = null;
          window.currentSharePresentationId = null;
          window.currentSharePresentationTitle = null;
          if (shareEmailsInput) {
            shareEmailsInput.value = '';
          }
        }
        
        // Make closeShareModal available globally for fallback
        window.closeShareModal = closeShareModal;

        shareClose?.addEventListener('click', closeShareModal);
        shareCancel?.addEventListener('click', closeShareModal);

        // Close modal when clicking outside
        shareModal?.addEventListener('click', (e) => {
          if (e.target === shareModal) {
            closeShareModal();
          }
        });

        // Handle share submission
        shareSubmit?.addEventListener('click', async () => {
          // Get presentation ID from either local variable or window
          const presId = currentSharePresentationId || window.currentSharePresentationId;
          const presTitle = currentSharePresentationTitle || window.currentSharePresentationTitle;
          
          if (!presId || !shareEmailsInput) {
            return;
          }

          const emailsText = shareEmailsInput.value.trim();
          if (!emailsText) {
            if (window.showActionMessage) {
              window.showActionMessage('warning', 'Please enter at least one email address.');
            }
            return;
          }

          const emails = window.parseEmails ? window.parseEmails(emailsText) : [];
          if (emails.length === 0) {
            if (window.showActionMessage) {
              window.showActionMessage('warning', 'Please enter valid email addresses.');
            }
            return;
          }

          // Disable submit button during processing
          if (shareSubmit) {
            shareSubmit.disabled = true;
            shareSubmit.innerHTML = `
              <span class="inline-flex items-center gap-2">
                <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Sharing...
              </span>
            `;
          }

          try {
            // Support both old single email and new multiple emails
            const result = await window.sharePresentation(presId, emails);
            
            closeShareModal();
            
            if (window.showActionMessage) {
              if (result && typeof result === 'object' && result.added) {
                const message = result.added === 1
                  ? `"${presTitle}" shared with ${result.added} person.`
                  : `"${presTitle}" shared with ${result.added} people.`;
                window.showActionMessage('success', message);
              } else {
                window.showActionMessage('success', `"${presTitle}" shared successfully.`);
              }
            }
          } catch (error) {
            console.error('Share error:', error);
            const errorMsg = error.message || 'Failed to share presentation. Please try again.';
            if (window.showActionMessage) {
              window.showActionMessage('warning', errorMsg);
            }
          } finally {
            // Re-enable submit button
            if (shareSubmit) {
              shareSubmit.disabled = false;
              shareSubmit.innerHTML = `
                <span class="inline-flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                  </svg>
                  Share
                </span>
              `;
            }
          }
        });

        // Make openShareModal available globally
        window.openShareModal = openShareModal;
        
        // Debug: confirm modal is ready
        console.log('Share modal initialized', {
          shareModal: !!shareModal,
          shareTitle: !!shareTitle,
          shareEmailsInput: !!shareEmailsInput,
          openShareModal: typeof openShareModal
        });
      })()
    </script>
    <script type="module">
      import { collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      const presentationsListEl = document.querySelector('[data-user-presentations-list]');
      const emptyStateEl = document.querySelector('[data-user-presentations-empty]');
      const loadingStateEl = document.querySelector('[data-user-presentations-loading]');
      const activeCountLabel = document.querySelector('[data-active-count-label]');

      let unsubscribe = null;
      let subscriptionUserId = null;

      const toDate = (value) => {
        if (!value) return null;
        if (value.toDate) return value.toDate();
        if (value instanceof Date) return value;
        return null;
      };

      const formatRelativeTime = (date) => {
        if (!date) return 'Just now';
        const diffMs = Date.now() - date.getTime();
        const diffMinutes = Math.max(0, Math.round(diffMs / 60000));
        if (diffMinutes < 1) return 'Just now';
        if (diffMinutes < 60) return `${diffMinutes} min${diffMinutes === 1 ? '' : 's'} ago`;
        const diffHours = Math.round(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours} hr${diffHours === 1 ? '' : 's'} ago`;
        const diffDays = Math.round(diffHours / 24);
        if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
        return date.toLocaleDateString();
      };

      const updateActiveCount = (count) => {
        if (!activeCountLabel) return;
        const label = count === 1 ? '1 active deck' : `${count} active decks`;
        activeCountLabel.textContent = label;
      };

      const clearList = () => {
        if (!presentationsListEl) return;
        presentationsListEl.innerHTML = '';
        updateSelectedCount();
      };

      // Function to update selected count
      function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.presentation-checkbox:checked');
        const count = checkboxes.length;
        const selectedCountEl = document.getElementById('selectedCount');
        const deleteSelectedBtn = document.getElementById('deleteSelectedPresentationsBtn');
        const duplicateSelectedBtn = document.getElementById('duplicateSelectedPresentationsBtn');
        
        if (selectedCountEl) {
          selectedCountEl.textContent = count;
        }
        
        if (deleteSelectedBtn) {
          deleteSelectedBtn.disabled = count === 0;
        }
        
        if (duplicateSelectedBtn) {
          duplicateSelectedBtn.disabled = count === 0;
        }
      }

      const createPresentationCard = (docId, data) => {
        const title = (data?.title || '').trim() || 'Untitled presentation';
        const updatedAt = toDate(data?.updatedAt) || toDate(data?.createdAt);
        const updatedLabel = updatedAt ? formatRelativeTime(updatedAt) : 'Recently saved';
        const slideCount = Array.isArray(data?.slides) ? data.slides.length : 0;
        const slideLabel = slideCount === 1 ? 'slide' : 'slides';

        const card = document.createElement('div');
        card.className = 'group relative flex flex-col justify-between rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:-translate-y-1 hover:border-emerald-400 hover:shadow-md';
        card.dataset.presentationId = docId;

        // Checkbox for selection (hidden by default)
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'presentation-checkbox absolute top-4 right-4 h-5 w-5 rounded border-slate-300 text-emerald-600 focus:ring-2 focus:ring-emerald-500 cursor-pointer hidden';
        checkbox.dataset.presentationId = docId;
        checkbox.addEventListener('change', () => {
          updateSelectedCount();
          checkAndShowActions();
        });
        card.appendChild(checkbox);

        const header = document.createElement('div');
        header.className = 'flex flex-col gap-2';
        const titleEl = document.createElement('h3');
        titleEl.className = 'font-semibold leading-tight text-slate-900';
        titleEl.textContent = title;
        header.appendChild(titleEl);

        const metaEl = document.createElement('p');
        metaEl.className = 'text-xs text-slate-500';
        metaEl.textContent = `Updated ${updatedLabel}`;
        header.appendChild(metaEl);

        const pillRow = document.createElement('div');
        pillRow.className = 'mt-2 flex flex-wrap items-center gap-2';
        const slidesPill = document.createElement('span');
        slidesPill.className = 'inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700';
        slidesPill.textContent = `${slideCount} ${slideLabel}`;
        pillRow.appendChild(slidesPill);
        header.appendChild(pillRow);

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';
        
        const openBtn = document.createElement('a');
        // Determine which editor to use based on editorType, default to editor-1
        const editorType = data?.editorType || 'editor-1';
        const editorFile = editorType + '.html';
        openBtn.href = `${editorFile}?presentationId=${encodeURIComponent(docId)}`;
        openBtn.className = 'inline-flex items-center rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-400';
        openBtn.textContent = 'Open deck';
        footer.appendChild(openBtn);

        const shareBtn = document.createElement('button');
        shareBtn.className = 'inline-flex items-center gap-1.5 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-emerald-400 hover:bg-emerald-50 hover:text-emerald-700';
        shareBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
            <polyline points="16 6 12 2 8 6"></polyline>
            <line x1="12" y1="2" x2="12" y2="15"></line>
          </svg>
          Share
        `;
        shareBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('Share button clicked', { docId, title, hasOpenShareModal: !!window.openShareModal });
          
          // Try to use openShareModal if available
          if (window.openShareModal) {
            console.log('Using openShareModal');
            window.openShareModal(docId, title);
            return;
          }
          
          // Fallback: open modal directly
          console.log('Using fallback to open modal directly');
          const shareModalEl = document.querySelector('[data-share-modal]');
          const shareTitleEl = document.querySelector('[data-share-title]');
          const shareEmailsInputEl = document.getElementById('shareEmailsInput');
          const shareCloseEl = document.querySelector('[data-share-close]');
          const shareCancelEl = document.querySelector('[data-share-cancel]');
          const shareSubmitEl = document.querySelector('[data-share-submit]');
          
          if (!shareModalEl || !shareTitleEl || !shareEmailsInputEl) {
            console.error('Modal elements not found', { shareModalEl: !!shareModalEl, shareTitleEl: !!shareTitleEl, shareEmailsInputEl: !!shareEmailsInputEl });
            alert('Share feature is not ready. Please refresh the page.');
            return;
          }
          
          // Store presentation info
          window.currentSharePresentationId = docId;
          window.currentSharePresentationTitle = title;
          
          // Open modal
          shareTitleEl.textContent = `Share "${title}"`;
          shareEmailsInputEl.value = '';
          shareModalEl.classList.remove('hidden');
          shareModalEl.classList.add('flex');
          
          // Add event listeners for fallback (only if not already added)
          if (!shareModalEl.dataset.fallbackInitialized) {
            shareModalEl.dataset.fallbackInitialized = 'true';
            
            // Close handlers
            const closeHandler = () => {
              shareModalEl.classList.add('hidden');
              shareModalEl.classList.remove('flex');
              window.currentSharePresentationId = null;
              window.currentSharePresentationTitle = null;
            };
            
            if (shareCloseEl) {
              shareCloseEl.onclick = closeHandler;
            }
            if (shareCancelEl) {
              shareCancelEl.onclick = closeHandler;
            }
            
            // Close on outside click
            shareModalEl.onclick = (e) => {
              if (e.target === shareModalEl) {
                closeHandler();
              }
            };
            
            // Submit handler
            if (shareSubmitEl && !shareSubmitEl.dataset.fallbackHandler) {
              shareSubmitEl.dataset.fallbackHandler = 'true';
              shareSubmitEl.addEventListener('click', async () => {
                const emailsText = shareEmailsInputEl.value.trim();
                if (!emailsText) {
                  alert('Please enter at least one email address.');
                  return;
                }
                
                const emails = window.parseEmails ? window.parseEmails(emailsText) : emailsText.split(/[,\n]/).map(e => e.trim().toLowerCase()).filter(e => e.includes('@'));
                if (emails.length === 0) {
                  alert('Please enter valid email addresses.');
                  return;
                }
                
                if (window.sharePresentation) {
                  try {
                    shareSubmitEl.disabled = true;
                    shareSubmitEl.textContent = 'Sharing...';
                    
                    const result = await window.sharePresentation(window.currentSharePresentationId, emails);
                    closeHandler();
                    
                    if (window.showActionMessage) {
                      const message = result && typeof result === 'object' && result.added
                        ? `"${window.currentSharePresentationTitle}" shared with ${result.added} ${result.added === 1 ? 'person' : 'people'}.`
                        : `"${window.currentSharePresentationTitle}" shared successfully.`;
                      window.showActionMessage('success', message);
                    } else {
                      alert(`"${window.currentSharePresentationTitle}" shared successfully.`);
                    }
                  } catch (error) {
                    console.error('Share error:', error);
                    alert(error.message || 'Failed to share presentation. Please try again.');
                  } finally {
                    shareSubmitEl.disabled = false;
                    shareSubmitEl.innerHTML = `
                      <span class="inline-flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                          <polyline points="16 6 12 2 8 6"></polyline>
                          <line x1="12" y1="2" x2="12" y2="15"></line>
                        </svg>
                        Share
                      </span>
                    `;
                  }
                } else {
                  alert('Share function is not available. Please refresh the page.');
                }
              });
            }
          }
          
          shareEmailsInputEl.focus();
        });
        footer.appendChild(shareBtn);

        const duplicateBtn = document.createElement('button');
        duplicateBtn.className = 'inline-flex items-center gap-1.5 rounded-full border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:border-sky-400 hover:bg-sky-50 hover:text-sky-700';
        duplicateBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Duplicate
        `;
        duplicateBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (!window.duplicatePresentation) {
            alert('Duplicate function is not available. Please refresh the page.');
            return;
          }

          try {
            duplicateBtn.disabled = true;
            duplicateBtn.innerHTML = `
              <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Duplicating...
            `;

            await window.duplicatePresentation(docId);
            
            if (window.showActionMessage) {
              window.showActionMessage('success', `"${title}" duplicated successfully.`);
            } else {
              alert(`"${title}" duplicated successfully.`);
            }
          } catch (error) {
            console.error('Duplicate error:', error);
            if (window.showActionMessage) {
              window.showActionMessage('warning', error.message || 'Failed to duplicate presentation. Please try again.');
            } else {
              alert(error.message || 'Failed to duplicate presentation. Please try again.');
            }
          } finally {
            duplicateBtn.disabled = false;
            duplicateBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Duplicate
            `;
          }
        });
        footer.appendChild(duplicateBtn);

        card.appendChild(header);
        card.appendChild(footer);
        return card;
      };

      const renderSnapshot = (snapshot) => {
        updateActiveCount(snapshot?.size ?? 0);

        if (!presentationsListEl || !emptyStateEl) {
          return;
        }

        clearList();

        if (!snapshot || snapshot.empty) {
          presentationsListEl.classList.add('hidden');
          emptyStateEl.classList.remove('hidden');
          return;
        }

        emptyStateEl.classList.add('hidden');
        presentationsListEl.classList.remove('hidden');

        snapshot.forEach((docSnap) => {
          const card = createPresentationCard(docSnap.id, docSnap.data());
          presentationsListEl.appendChild(card);
        });
      };

      const ensureSubscription = (userId) => {
        if (!userId || subscriptionUserId === userId) {
          return;
        }
        if (!window.firebaseDb) {
          return;
        }

        if (unsubscribe) {
          unsubscribe();
          unsubscribe = null;
        }

        subscriptionUserId = userId;
        loadingStateEl?.classList.remove('hidden');
        presentationsListEl?.classList.add('hidden');
        emptyStateEl?.classList.add('hidden');

        const presentationsRef = collection(window.firebaseDb, 'users', userId, 'presentations');
        const q = query(presentationsRef, orderBy('updatedAt', 'desc'), limit(12));

        unsubscribe = onSnapshot(
          q,
          (snapshot) => {
            loadingStateEl?.classList.add('hidden');
            renderSnapshot(snapshot);
          },
          (error) => {
            console.error('Failed to load presentations:', error);
            loadingStateEl?.classList.add('hidden');
            if (emptyStateEl) {
              emptyStateEl.classList.remove('hidden');
              emptyStateEl.textContent = 'We could not load your decks right now. Please try again.';
            }
          }
        );
      };

      window.addEventListener('pm-user-ready', (event) => {
        const userId = event?.detail?.userId;
        if (userId) {
          ensureSubscription(userId);
        }
      });

      if (window.currentUserId) {
        ensureSubscription(window.currentUserId);
      }

      window.addEventListener('beforeunload', () => {
        if (unsubscribe) {
          unsubscribe();
        }
      });

      // Delete all presentations button
      const deleteAllBtn = document.getElementById('deleteAllPresentationsBtn');
      deleteAllBtn?.addEventListener('click', async () => {
        const count = presentationsListEl?.children.length || 0;
        if (count === 0) {
          if (window.showActionMessage) {
            window.showActionMessage('info', 'No presentations to delete.');
          } else {
            alert('No presentations to delete.');
          }
          return;
        }

        const confirmed = window.confirm(`Are you sure you want to delete all ${count} presentation${count === 1 ? '' : 's'}? This action cannot be undone.`);
        if (!confirmed) {
          return;
        }

        try {
          if (deleteAllBtn) {
            deleteAllBtn.disabled = true;
            deleteAllBtn.innerHTML = `
              <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Deleting...
            `;
          }

          const deletedCount = await window.deleteAllPresentations();
          
          if (window.showActionMessage) {
            window.showActionMessage('success', `Successfully deleted ${deletedCount} presentation${deletedCount === 1 ? '' : 's'}.`);
          } else {
            alert(`Successfully deleted ${deletedCount} presentation${deletedCount === 1 ? '' : 's'}.`);
          }
        } catch (error) {
          console.error('Delete error:', error);
          if (window.showActionMessage) {
            window.showActionMessage('warning', error.message || 'Failed to delete presentations. Please try again.');
          } else {
            alert(error.message || 'Failed to delete presentations. Please try again.');
          }
        } finally {
          if (deleteAllBtn) {
            deleteAllBtn.disabled = false;
            deleteAllBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              </svg>
              Delete All
            `;
          }
        }
      });

      // Select Mode button - toggle checkboxes visibility
      const selectModeBtn = document.getElementById('selectModeBtn');
      const selectionActions = document.getElementById('selectionActions');
      let isSelectMode = false;
      
      selectModeBtn?.addEventListener('click', () => {
        isSelectMode = !isSelectMode;
        const checkboxes = document.querySelectorAll('.presentation-checkbox');
        
        if (isSelectMode) {
          // Show checkboxes
          checkboxes.forEach(checkbox => {
            checkbox.classList.remove('hidden');
          });
          selectModeBtn.textContent = 'Cancel';
          selectModeBtn.classList.add('bg-emerald-50', 'border-emerald-400', 'text-emerald-700');
          selectModeBtn.classList.remove('border-slate-300', 'text-slate-700');
        } else {
          // Hide checkboxes and uncheck all
          checkboxes.forEach(checkbox => {
            checkbox.classList.add('hidden');
            checkbox.checked = false;
          });
          selectModeBtn.textContent = 'Select';
          selectModeBtn.classList.remove('bg-emerald-50', 'border-emerald-400', 'text-emerald-700');
          selectModeBtn.classList.add('border-slate-300', 'text-slate-700');
          selectionActions?.classList.add('hidden');
          updateSelectedCount();
          allSelected = false;
        }
      });

      // Function to check if any checkbox is selected and show actions
      function checkAndShowActions() {
        const checkboxes = document.querySelectorAll('.presentation-checkbox:checked');
        const count = checkboxes.length;
        const duplicateSelectedCount = document.getElementById('duplicateSelectedCount');
        
        if (duplicateSelectedCount) {
          duplicateSelectedCount.textContent = count;
        }
        
        if (count > 0 && selectionActions) {
          selectionActions.classList.remove('hidden');
        } else if (count === 0 && selectionActions) {
          selectionActions.classList.add('hidden');
        }
      }

      // Select All button
      const selectAllBtn = document.getElementById('selectAllPresentationsBtn');
      let allSelected = false;
      selectAllBtn?.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.presentation-checkbox');
        allSelected = !allSelected;
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = allSelected;
        });
        
        updateSelectedCount();
        checkAndShowActions();
        selectAllBtn.textContent = allSelected ? 'Deselect All' : 'Select All';
      });

      // Delete Selected button
      const deleteSelectedBtn = document.getElementById('deleteSelectedPresentationsBtn');
      deleteSelectedBtn?.addEventListener('click', async () => {
        const checkboxes = document.querySelectorAll('.presentation-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.presentationId);
        
        if (selectedIds.length === 0) {
          if (window.showActionMessage) {
            window.showActionMessage('info', 'No presentations selected.');
          }
          return;
        }

        const confirmed = window.confirm(`Are you sure you want to delete ${selectedIds.length} selected presentation${selectedIds.length === 1 ? '' : 's'}? This action cannot be undone.`);
        if (!confirmed) {
          return;
        }

        try {
          if (deleteSelectedBtn) {
            deleteSelectedBtn.disabled = true;
            deleteSelectedBtn.innerHTML = `
              <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Deleting...
            `;
          }

          const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
          const deletePromises = selectedIds.map(id => 
            deleteDoc(doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', id))
          );
          
          await Promise.all(deletePromises);
          
          if (window.showActionMessage) {
            window.showActionMessage('success', `Successfully deleted ${selectedIds.length} presentation${selectedIds.length === 1 ? '' : 's'}.`);
          } else {
            alert(`Successfully deleted ${selectedIds.length} presentation${selectedIds.length === 1 ? '' : 's'}.`);
          }
          
          allSelected = false;
          if (selectAllBtn) {
            selectAllBtn.textContent = 'Select All';
          }
          checkAndShowActions();
        } catch (error) {
          console.error('Delete error:', error);
          if (window.showActionMessage) {
            window.showActionMessage('warning', error.message || 'Failed to delete presentations. Please try again.');
          } else {
            alert(error.message || 'Failed to delete presentations. Please try again.');
          }
        } finally {
          if (deleteSelectedBtn) {
            deleteSelectedBtn.disabled = true;
            deleteSelectedBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
              </svg>
              Delete Selected (<span id="selectedCount">0</span>)
            `;
          }
        }
      });

      // Duplicate Selected button
      const duplicateSelectedBtn = document.getElementById('duplicateSelectedPresentationsBtn');
      duplicateSelectedBtn?.addEventListener('click', async () => {
        const checkboxes = document.querySelectorAll('.presentation-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.dataset.presentationId);
        
        if (selectedIds.length === 0) {
          if (window.showActionMessage) {
            window.showActionMessage('info', 'No presentations selected.');
          }
          return;
        }

        if (!window.duplicatePresentation) {
          alert('Duplicate function is not available. Please refresh the page.');
          return;
        }

        try {
          if (duplicateSelectedBtn) {
            duplicateSelectedBtn.disabled = true;
            duplicateSelectedBtn.innerHTML = `
              <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Duplicating...
            `;
          }

          // Duplicate all selected presentations
          for (const id of selectedIds) {
            await window.duplicatePresentation(id);
          }
          
          if (window.showActionMessage) {
            window.showActionMessage('success', `Successfully duplicated ${selectedIds.length} presentation${selectedIds.length === 1 ? '' : 's'}.`);
          } else {
            alert(`Successfully duplicated ${selectedIds.length} presentation${selectedIds.length === 1 ? '' : 's'}.`);
          }
          
          // Uncheck all after duplication
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });
          updateSelectedCount();
          checkAndShowActions();
          allSelected = false;
          if (selectAllBtn) {
            selectAllBtn.textContent = 'Select All';
          }
        } catch (error) {
          console.error('Duplicate error:', error);
          if (window.showActionMessage) {
            window.showActionMessage('warning', error.message || 'Failed to duplicate presentations. Please try again.');
          } else {
            alert(error.message || 'Failed to duplicate presentations. Please try again.');
          }
        } finally {
          if (duplicateSelectedBtn) {
            duplicateSelectedBtn.disabled = false;
            duplicateSelectedBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Duplicate Selected (<span id="duplicateSelectedCount">0</span>)
            `;
          }
        }
      });
    </script>
    <script type="module">
      import { collection, query, where, orderBy, limit, onSnapshot, doc, getDoc, updateDoc, arrayUnion, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      // Function to parse emails from text (supports comma and newline separated)
      function parseEmails(text) {
        if (!text || !text.trim()) return [];
        return text
          .split(/[,\n]/)
          .map(email => email.trim().toLowerCase())
          .filter(email => email.length > 0 && email.includes('@'));
      }

      // Function to share a presentation with multiple emails
      async function sharePresentation(presentationId, emails) {
        if (!window.currentUserId || !window.firebaseDb) {
          throw new Error('User not authenticated');
        }

        // Support both single email string and array of emails
        const emailList = Array.isArray(emails) ? emails : [emails];
        const emailLowers = emailList.map(e => e.toLowerCase().trim()).filter(e => e.includes('@'));

        if (emailLowers.length === 0) {
          throw new Error('No valid email addresses provided');
        }

        const presentationRef = doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', presentationId);
        const presentationSnap = await getDoc(presentationRef);

        if (!presentationSnap.exists()) {
          throw new Error('Presentation not found');
        }

        const currentData = presentationSnap.data();
        const sharedWith = currentData.sharedWith || [];
        
        // Filter out emails that are already shared
        const newEmails = emailLowers.filter(e => !sharedWith.includes(e));
        
        if (newEmails.length === 0) {
          throw new Error('All emails are already shared with this presentation');
        }

        await updateDoc(presentationRef, {
          sharedWith: arrayUnion(...newEmails),
          updatedAt: new Date()
        });

        return {
          success: true,
          added: newEmails.length,
          alreadyShared: emailLowers.length - newEmails.length
        };
      }

      // Function to parse emails from text (supports comma and newline separated)
      function parseEmails(text) {
        if (!text || !text.trim()) return [];
        return text
          .split(/[,\n]/)
          .map(email => email.trim().toLowerCase())
          .filter(email => email.length > 0 && email.includes('@'));
      }

      // Make functions available globally
      // Function to delete all presentations
      async function deleteAllPresentations() {
        if (!window.currentUserId || !window.firebaseDb) {
          throw new Error('User not authenticated');
        }

        const { collection, getDocs, doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const presentationsRef = collection(window.firebaseDb, 'users', window.currentUserId, 'presentations');
        const snapshot = await getDocs(presentationsRef);
        
        const deletePromises = [];
        snapshot.forEach((docSnap) => {
          deletePromises.push(deleteDoc(doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', docSnap.id)));
        });
        
        await Promise.all(deletePromises);
        return snapshot.size;
      }

      // Function to duplicate a presentation
      async function duplicatePresentation(presentationId) {
        if (!window.currentUserId || !window.firebaseDb) {
          throw new Error('User not authenticated');
        }

        const presentationRef = doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', presentationId);
        const presentationSnap = await getDoc(presentationRef);

        if (!presentationSnap.exists()) {
          throw new Error('Presentation not found');
        }

        const originalData = presentationSnap.data();
        const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        
        // Create new presentation with copied data
        const newPresentationData = {
          title: (originalData.title || 'Untitled presentation') + ' (Copy)',
          slides: originalData.slides || [],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          sharedWith: [] // Don't copy sharedWith
        };

        const presentationsRef = collection(window.firebaseDb, 'users', window.currentUserId, 'presentations');
        await addDoc(presentationsRef, newPresentationData);

        return true;
      }

      window.sharePresentation = sharePresentation;
      window.parseEmails = parseEmails;
      window.duplicatePresentation = duplicatePresentation;
      window.deleteAllPresentations = deleteAllPresentations;

      // Load and display shared presentations
      const sharedPresentationsListEl = document.querySelector('[data-shared-presentations-list]');
      const sharedEmptyStateEl = document.querySelector('[data-shared-presentations-empty]');
      const sharedLoadingStateEl = document.querySelector('[data-shared-presentations-loading]');

      let sharedUnsubscribe = null;
      let sharedSubscriptionEmail = null;

      const clearSharedList = () => {
        if (!sharedPresentationsListEl) return;
        sharedPresentationsListEl.innerHTML = '';
      };

      const createSharedPresentationCard = (docId, data, ownerId) => {
        const title = (data?.title || '').trim() || 'Untitled presentation';
        const updatedAt = toDate(data?.updatedAt) || toDate(data?.createdAt);
        const updatedLabel = updatedAt ? formatRelativeTime(updatedAt) : 'Recently saved';
        const slideCount = Array.isArray(data?.slides) ? data.slides.length : 0;
        const slideLabel = slideCount === 1 ? 'slide' : 'slides';

        const card = document.createElement('div');
        card.className = 'group relative flex flex-col justify-between rounded-xl border border-slate-200 bg-white p-4 shadow-sm transition hover:-translate-y-1 hover:border-emerald-400 hover:shadow-md';
        card.dataset.presentationId = docId;

        // Checkbox for selection (hidden by default)
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'presentation-checkbox absolute top-4 right-4 h-5 w-5 rounded border-slate-300 text-emerald-600 focus:ring-2 focus:ring-emerald-500 cursor-pointer z-10 hidden';
        checkbox.dataset.presentationId = docId;
        checkbox.addEventListener('change', () => {
          updateSelectedCount();
          checkAndShowActions();
        });
        card.appendChild(checkbox);

        const header = document.createElement('div');
        header.className = 'flex flex-col gap-2';
        const titleEl = document.createElement('h3');
        titleEl.className = 'font-semibold leading-tight text-slate-900';
        titleEl.textContent = title;
        header.appendChild(titleEl);

        const metaEl = document.createElement('p');
        metaEl.className = 'text-xs text-slate-500';
        metaEl.textContent = `Updated ${updatedLabel}`;
        header.appendChild(metaEl);

        const pillRow = document.createElement('div');
        pillRow.className = 'mt-2 flex flex-wrap items-center gap-2';
        const slidesPill = document.createElement('span');
        slidesPill.className = 'inline-flex items-center gap-1 rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700';
        slidesPill.textContent = `${slideCount} ${slideLabel}`;
        pillRow.appendChild(slidesPill);
        
        const sharedPill = document.createElement('span');
        sharedPill.className = 'inline-flex items-center gap-1 rounded-full bg-sky-50 px-3 py-1 text-xs font-medium text-sky-700';
        sharedPill.textContent = 'Shared';
        pillRow.appendChild(sharedPill);
        header.appendChild(pillRow);

        const footer = document.createElement('div');
        footer.className = 'mt-4 flex items-center justify-between gap-3';
        const openBtn = document.createElement('a');
        openBtn.href = `editor-ai.html?presentationId=${encodeURIComponent(docId)}&ownerId=${encodeURIComponent(ownerId)}`;
        openBtn.className = 'inline-flex items-center rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-400';
        openBtn.textContent = 'Open deck';
        footer.appendChild(openBtn);

        card.appendChild(header);
        card.appendChild(footer);
        return card;
      };

      const renderSharedSnapshot = (presentations) => {
        if (!sharedPresentationsListEl || !sharedEmptyStateEl) {
          return;
        }

        clearSharedList();

        if (!presentations || presentations.length === 0) {
          sharedPresentationsListEl.classList.add('hidden');
          sharedEmptyStateEl.classList.remove('hidden');
          return;
        }

        sharedEmptyStateEl.classList.add('hidden');
        sharedPresentationsListEl.classList.remove('hidden');

        presentations.forEach(({ docId, data, ownerId }) => {
          const card = createSharedPresentationCard(docId, data, ownerId);
          sharedPresentationsListEl.appendChild(card);
        });
      };

      const ensureSharedSubscription = async (userEmail) => {
        if (!userEmail || sharedSubscriptionEmail === userEmail) {
          return;
        }
        if (!window.firebaseDb) {
          return;
        }

        if (sharedUnsubscribe) {
          sharedUnsubscribe();
          sharedUnsubscribe = null;
        }

        sharedSubscriptionEmail = userEmail.toLowerCase().trim();
        sharedLoadingStateEl?.classList.remove('hidden');
        sharedPresentationsListEl?.classList.add('hidden');
        sharedEmptyStateEl?.classList.add('hidden');

        try {
          // Query all users' presentations where sharedWith contains the current user's email
          const usersRef = collection(window.firebaseDb, 'users');
          const usersSnapshot = await getDocs(usersRef);
          
          const sharedPresentations = [];
          
          for (const userDoc of usersSnapshot.docs) {
            const userId = userDoc.id;
            if (userId === window.currentUserId) continue; // Skip own presentations
            
            const presentationsRef = collection(window.firebaseDb, 'users', userId, 'presentations');
            const presentationsSnapshot = await getDocs(presentationsRef);
            
          presentationsSnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const sharedWith = data.sharedWith || [];
            if (sharedWith.includes(sharedSubscriptionEmail)) {
              sharedPresentations.push({
                docId: docSnap.id,
                data: data,
                ownerId: userId
              });
            }
          });
          }

          // Sort by updatedAt
          sharedPresentations.sort((a, b) => {
            const dateA = toDate(a.data.updatedAt) || toDate(a.data.createdAt) || new Date(0);
            const dateB = toDate(b.data.updatedAt) || toDate(b.data.createdAt) || new Date(0);
            return dateB.getTime() - dateA.getTime();
          });

          sharedLoadingStateEl?.classList.add('hidden');
          renderSharedSnapshot(sharedPresentations);
        } catch (error) {
          console.error('Failed to load shared presentations:', error);
          sharedLoadingStateEl?.classList.add('hidden');
          if (sharedEmptyStateEl) {
            sharedEmptyStateEl.classList.remove('hidden');
            sharedEmptyStateEl.textContent = 'We could not load shared presentations right now. Please try again.';
          }
        }
      };

      window.addEventListener('pm-user-ready', async (event) => {
        const userId = event?.detail?.userId;
        if (userId) {
          const userEmail = localStorage.getItem('pm-user-email');
          if (userEmail) {
            await ensureSharedSubscription(userEmail);
          }
        }
      });

      if (window.currentUserId) {
        const userEmail = localStorage.getItem('pm-user-email');
        if (userEmail) {
          ensureSharedSubscription(userEmail);
        }
      }

      window.addEventListener('beforeunload', () => {
        if (sharedUnsubscribe) {
          sharedUnsubscribe();
        }
      });
    </script>
  </body>
</html>


