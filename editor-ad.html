<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Presentation Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js'
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

      const firebaseConfig = {
        apiKey: 'AIzaSyDPzRqV-_hGNedZoeGNtorLTGWTBMmqdkc',
        authDomain: 'prj-adc-gcp-coop-test.firebaseapp.com',
        projectId: 'prj-adc-gcp-coop-test',
        storageBucket: 'prj-adc-gcp-coop-test.firebasestorage.app',
        messagingSenderId: '472242813268',
        appId: '1:472242813268:web:4e7b4650015fd473d4f0c1',
        measurementId: 'G-RGEPGD1T9T',
      }

      const firebaseApp = initializeApp(firebaseConfig)
      const analytics = getAnalytics(firebaseApp)
      const db = getFirestore(firebaseApp, 'bettercallus')
      const auth = getAuth(firebaseApp)

      window.firebaseApp = firebaseApp
      window.firebaseAnalytics = analytics
      window.firebaseDb = db
      window.firebaseAuth = auth

      const markLoggedOut = () => {
        localStorage.removeItem('pm-logged-in')
        localStorage.removeItem('pm-user-id')
      }

      // Get stored user ID if available
      const storedUserId = localStorage.getItem('pm-user-id')
      if (storedUserId) {
        window.currentUserId = storedUserId
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.currentUser = user
          window.currentUserId = user.uid
          localStorage.setItem('pm-logged-in', 'true')
          localStorage.setItem('pm-user-id', user.uid)
          if (user.email) {
            localStorage.setItem('pm-user-email', user.email)
          }
          if (user.displayName) {
            localStorage.setItem('pm-user-name', user.displayName)
          }
          window.dispatchEvent(new CustomEvent('pm-user-ready', { detail: { user } }))
        } else {
          window.currentUser = null
          window.currentUserId = storedUserId || null
          markLoggedOut()
          if (localStorage.getItem('pm-logged-in') !== 'true') {
            window.location.replace('login.html')
          }
        }
      })

      console.log('Firebase initialized in editor with database: bettercallus')
    </script>
<style>
        @font-face {
            font-family: 'Kraft Mono';
            src: url('assets/fonts/KraftMono.woff2') format('woff2'),
                 url('assets/fonts/KraftMono.woff') format('woff'),
                 url('assets/fonts/KraftMono.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ID Grotesk';
            src: url('assets/fonts/IDGrotesk-Regular.woff2') format('woff2'),
                 url('assets/fonts/IDGrotesk-Regular.woff') format('woff'),
                 url('assets/fonts/IDGrotesk-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ID Grotesk';
            src: url('assets/fonts/IDGrotesk-Medium.woff2') format('woff2'),
                 url('assets/fonts/IDGrotesk-Medium.woff') format('woff'),
                 url('assets/fonts/IDGrotesk-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ID Grotesk';
            src: url('assets/fonts/IDGrotesk-SemiBold.woff2') format('woff2'),
                 url('assets/fonts/IDGrotesk-SemiBold.woff') format('woff'),
                 url('assets/fonts/IDGrotesk-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'ID Grotesk';
            src: url('assets/fonts/IDGrotesk-Bold.woff2') format('woff2'),
                 url('assets/fonts/IDGrotesk-Bold.woff') format('woff'),
                 url('assets/fonts/IDGrotesk-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #ffffff, #ecfdf5);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.16), transparent 55%),
              radial-gradient(circle at top right, rgba(56, 189, 248, 0.15), transparent 45%),
              radial-gradient(circle at bottom, rgba(6, 95, 70, 0.15), transparent 60%);
            z-index: -2;
            pointer-events: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
            color: #0f172a;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
            position: relative;
            z-index: 200;
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 10px; }

        .templates-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            color: #64748b;
            padding: 6px 12px;
            border-radius: 9999px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .templates-btn:hover {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.4);
            color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-brand img {
            height: 32px;
            width: auto;
        }

        .header-brand-text {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.32em;
            color: #64748b;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            color: #1e293b;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .header-btn:hover { 
            background: rgba(16, 185, 129, 0.12); 
            border-color: rgba(16, 185, 129, 0.4);
            color: #047857;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }
        .header-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            color: #94a3b8;
        }

        .header-btn.grey-style {
            color: #94a3b8 !important;
            opacity: 0.5 !important;
        }

        .header-btn.grey-style:hover {
            color: #94a3b8 !important;
            opacity: 0.5 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(203, 213, 225, 0.9) !important;
            transform: none !important;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08) !important;
        }

        .title-input {
            background: rgba(255, 255, 255, 0.95);
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            color: #1e293b;
            font-size: 14px;
            font-weight: 500;
            padding: 9px 16px;
            border-radius: 8px;
            outline: none;
            min-width: 320px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .title-input::placeholder { color: rgba(100, 116, 139, 0.7); }
        .title-input:focus { 
            background: rgba(255, 255, 255, 0.95); 
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .share-btn {
            background: linear-gradient(to right, #10b981, #059669) !important;
            color: white !important;
            padding: 9px 24px;
            border: none !important;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .share-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            background: linear-gradient(to right, #059669, #047857) !important;
            color: white !important;
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none;
            min-width: 220px;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu.show { display: block; }

        .dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .dropdown-item:hover { background: rgba(16, 185, 129, 0.1); color: #059669; }

        /* Category Panel Dropdowns */
        .dropdown-wrapper {
            position: relative;
            display: inline-block;
        }

        .category-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.15);
            display: none;
            min-width: 180px;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .category-dropdown.show {
            display: block;
        }

        .category-dropdown-item {
            padding: 10px 14px;
            cursor: pointer;
            color: #374151;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.15s;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .category-dropdown-item:last-child {
            border-bottom: none;
        }

        .category-dropdown-item:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .dropdown-btn {
            position: relative;
            padding-right: 24px;
        }

        .dropdown-btn::after {
            display: none;
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            padding: 0;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
            position: relative;
            z-index: 200;
        }

        .toolbar-nav {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 24px;
        }

        .category-tab {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #475569;
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid rgba(226, 232, 240, 0.6);
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-tab:hover {
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .category-tab.active {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.5);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.15);
        }

        .category-tab .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #cbd5e1;
            transition: background 0.2s;
        }

        .category-tab.active .dot,
        .category-tab:hover .dot {
            background: #10b981;
        }

        .category-panel {
            display: none;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 10px 16px;
            opacity: 0;
            transform: translateY(-8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
        }

        .category-panel.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-panel-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            min-height: 36px;
        }

        .category-panel-group {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 0;
            visibility: visible;
            opacity: 1;
        }

        .category-panel-group + .category-panel-group::before {
            content: '';
            width: 1px;
            height: 24px;
            background: rgba(226, 232, 240, 0.6);
            margin-right: 6px;
        }

        .category-panel-label {
            font-size: 9.5px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #64748b;
            margin-right: 4px;
            white-space: nowrap;
        }

        .shape-pill {
            padding: 6px 12px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 8px;
            cursor: pointer;
            font-size: 9.5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #334155;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
            visibility: visible;
            opacity: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .shape-pill:hover {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.5);
            color: #047857;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25), 0 2px 6px rgba(16, 185, 129, 0.15);
        }

        .tool-btn-danger {
            color: #ef4444 !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .tool-btn-danger:hover {
            background: rgba(239, 68, 68, 0.1) !important;
            border-color: rgba(239, 68, 68, 0.5) !important;
            color: #dc2626 !important;
        }

        .tool-btn {
            padding: 6px 10px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 8px;
            cursor: pointer;
            font-size: 9.5px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #334155;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08), 0 1px 2px rgba(15, 23, 42, 0.04);
            position: relative;
            overflow: hidden;
            visibility: visible;
            opacity: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .tool-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .tool-btn:hover::before {
            left: 100%;
        }

        .tool-btn:hover { 
            background: rgba(16, 185, 129, 0.12); 
            border-color: rgba(16, 185, 129, 0.5); 
            color: #047857; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25), 0 2px 6px rgba(16, 185, 129, 0.15);
        }

        .tool-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.15);
        }

        .tool-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3), 0 2px 4px rgba(16, 185, 129, 0.2);
            font-size: 9.5px;
        }

        .tool-btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4), 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .tool-btn-icon {
            padding: 6px;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9.5px;
        }

        .tool-divider { width: 1px; height: 32px; background: #e5e7eb; margin: 0 6px; }

        select.tool-btn { 
            padding: 6px 10px; 
            padding-right: 28px;
            text-transform: none;
            letter-spacing: 0;
            font-size: 9.5px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23475569' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 10px;
        }
        input[type="number"].tool-btn { 
            width: 70px; 
            padding: 6px 10px; 
            text-transform: none;
            letter-spacing: 0;
            font-size: 9.5px;
        }
        input[type="color"] { 
            width: 44px; 
            height: 40px; 
            border: 1px solid rgba(226, 232, 240, 0.8); 
            border-radius: 10px; 
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);
            transition: all 0.2s;
        }
        input[type="color"]:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.2);
            transform: translateY(-1px);
        }

        .container { 
            display: flex; 
            height: calc(100vh - 112px);
            margin-top: 112px;
        }

        .properties-panel {
            width: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-left: none;
            display: flex;
            flex-direction: column;
            padding: 0;
            gap: 16px;
            overflow: hidden;
            box-shadow: none;
            transition: width 0.3s ease, padding 0.3s ease, padding-top 0.3s ease, border-left 0.3s ease, box-shadow 0.3s ease;
        }

        .properties-panel.visible {
            width: 280px;
            padding: 20px;
            padding-top: 60px;
            border-left: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: -2px 0 8px rgba(15, 23, 42, 0.05);
            overflow-y: auto;
            transition: padding-top 0.2s ease;
        }

        .properties-panel.visible.category-panel-open {
            padding-top: 100px;
        }

        .properties-panel-header {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: #64748b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .properties-panel-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .properties-action-btn {
            width: 28px;
            height: 28px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .properties-action-btn:hover {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        .properties-action-btn.delete {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .properties-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
            color: #dc2626;
        }

        .properties-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .properties-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .properties-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            color: #94a3b8;
        }

        .properties-input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 10px;
            font-size: 13px;
            color: #1e293b;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .properties-input:focus {
            outline: none;
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .properties-color-input {
            width: 100%;
            height: 48px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .properties-color-input:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        .properties-arrange-btn {
            width: 100%;
            height: 36px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 8px;
            font-size: 14px;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        }

        .properties-arrange-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.5);
            color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2);
        }

        .properties-arrange-btn:active {
            transform: translateY(0);
            background: rgba(16, 185, 129, 0.2);
        }

        .properties-empty {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
        }

        .properties-empty-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            color: #64748b;
            margin-bottom: 8px;
        }

        .properties-empty-text {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.6;
        }

        .sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            padding-top: 60px;
            gap: 12px;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(15, 23, 42, 0.05);
            scroll-behavior: smooth;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .sidebar-header {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 8px;
            margin-top: 20px;
        }

        .sidebar-slide {
            width: 100%;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .sidebar-slide:hover {
            border-color: rgba(16, 185, 129, 0.4);
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }

        .sidebar-slide.active {
            border-color: rgba(16, 185, 129, 0.7);
            border-width: 3px;
            background: rgba(16, 185, 129, 0.06);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.25);
        }

        .sidebar-slide-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: white;
            position: relative;
            font-size: 8px;
        }

        .sidebar-slide-number {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .sidebar-slide-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .sidebar-slide:hover .sidebar-slide-delete {
            display: flex;
        }

        .sidebar-add-slide {
            width: 100%;
            padding: 12px;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
        }

        .sidebar-add-slide:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.4);
            color: #059669;
        }

        .main-canvas {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            scroll-behavior: smooth;
        }

        .main-canvas::-webkit-scrollbar {
            width: 10px;
        }

        .main-canvas::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .main-canvas::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }

        .main-canvas::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .canvas-wrapper {
            transform-origin: center center;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 32px;
            padding: 20px;
        }

        .canvas-slide {
            width: 960px;
            height: 540px;
            background: white;
            position: relative;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .canvas-slide:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.18);
            transform: translateY(-2px);
        }

        .canvas-slide.active {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.5), 0 12px 40px rgba(16, 185, 129, 0.3);
        }

        .slide-number-badge {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 5;
            backdrop-filter: blur(10px);
        }

        .element {
            position: absolute;
            cursor: move;
            user-select: none;
        }

        .element.selected {
            outline: 2px solid rgba(16, 185, 129, 0.45);
            outline-offset: 2px;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.45), 0 20px 40px -25px rgba(16, 185, 129, 0.35);
        }

        .element.text-element {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .element.shape-element {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .element.image-element img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border: 2px solid rgba(16, 185, 129, 0.8);
            border-radius: 50%;
            display: none;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.3);
        }

        .element.selected .resize-handle { display: block; }

        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* Zoom Control Bar - Bottom Right */
        .zoom-control {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.15);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .zoom-divider {
            width: 1px;
            height: 32px;
            background: #e5e7eb;
        }

        .present-mode-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .present-mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .present-mode-btn:active {
            transform: translateY(0);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #475569;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        .zoom-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.4);
            color: #059669;
            transform: scale(1.05);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-slider {
            width: 120px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #e5e7eb;
            outline: none;
            border-radius: 2px;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #10b981;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zoom-slider::-webkit-slider-thumb:hover {
            background: #059669;
            transform: scale(1.2);
        }

        .zoom-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #10b981;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .zoom-slider::-moz-range-thumb:hover {
            background: #059669;
            transform: scale(1.2);
        }

        .zoom-value {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            min-width: 45px;
            text-align: center;
        }

        .zoom-reset {
            font-size: 11px;
            padding: 4px 8px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        .zoom-reset:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border-color: rgba(16, 185, 129, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 112px;
            left: 0;
            width: 100%;
            height: calc(100% - 112px);
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 24px;
            color: #1f2937;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: 300;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
            transition: all 0.2s;
        }

        .modal-close:hover { color: #ef4444; transform: rotate(90deg); }

        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .bg-option {
            aspect-ratio: 16/9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .bg-option:hover {
            transform: scale(1.05);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        .bg-color-item {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .bg-color-item:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
        }

        /* Range slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid #10b981;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 2px solid #10b981;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
        }

        .animation-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .animation-option {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
            color: #374151;
        }

        .animation-option:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.4);
            color: #059669;
            transform: translateY(-2px);
        }

        .present-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: black;
            z-index: 3000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .present-mode.active { display: flex; }

        .present-slide {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .present-canvas {
            background: white;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .present-controls {
            background: rgba(0,0,0,0.8);
            padding: 16px 24px;
            display: flex;
            gap: 16px;
            align-items: center;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .present-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .present-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .present-counter {
            color: white;
            font-weight: 600;
            font-size: 14px;
            padding: 0 16px;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideInDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
        .animate-slideInLeft { animation: slideInLeft 0.6s ease-out; }
        .animate-slideInRight { animation: slideInRight 0.6s ease-out; }
        .animate-slideInUp { animation: slideInUp 0.6s ease-out; }
        .animate-slideInDown { animation: slideInDown 0.6s ease-out; }
        .animate-zoomIn { animation: zoomIn 0.6s ease-out; }
        .animate-bounce { animation: bounce 0.8s ease-in-out; }

        .slide-transition-fade { animation: fadeIn 0.5s; }
        .slide-transition-slide { animation: slideInRight 0.5s; }
        .slide-transition-zoom { animation: zoomIn 0.5s; }

        /* Professional Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-text {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Professional Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s ease-out forwards;
        }

        [data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFadeIn 0.2s ease-out forwards;
        }

        @keyframes tooltipFadeIn {
            to { opacity: 1; }
        }

        /* Context Menu for Arrange */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 8px;
            z-index: 10000;
            display: none;
            min-width: 200px;
            border: 1px solid rgba(203, 213, 225, 0.5);
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-label {
            padding: 6px 14px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
        }

        .context-menu-item {
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            color: #475569;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .context-menu-separator {
            height: 1px;
            background: rgba(203, 213, 225, 0.5);
            margin: 4px 0;
        }

        .context-menu-arrange-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 4px;
        }

        .context-menu-arrange-btn {
            width: 100%;
            height: 32px;
            border: 1.5px solid rgba(203, 213, 225, 0.9);
            background: rgba(255, 255, 255, 1);
            border-radius: 6px;
            font-size: 14px;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
        }

        .context-menu-arrange-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.5);
            color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        /* Professional Grid Overlay */
        .canvas-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .canvas-grid-overlay.show {
            opacity: 0.1;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Snap Guidelines */
        .snap-line {
            position: absolute;
            background: rgba(16, 185, 129, 0.8);
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
        }

        .snap-line.horizontal {
            height: 1px;
            width: 100%;
            left: 0;
        }

        .snap-line.vertical {
            width: 1px;
            height: 100%;
            top: 0;
        }
    

/* ===================== FIXES OVERRIDES (Do not remove) ===================== */
/* Keep the top bars fixed and ensure tooltips render above them */
.header {
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  z-index: 4000 !important;
}

.toolbar {
  position: fixed !important;
  top: 60px; /* adjust if header height changes */
  left: 0;
  right: 0;
  z-index: 3500 !important;
}

.container {
  margin-top: 120px; /* header (60px) + toolbar (60px) */
  height: calc(100vh - 130px);
}

[data-tooltip]:hover::before,
[data-tooltip]:hover::after {
  z-index: 5000 !important; /* render above fixed bars */
}

/* Menus & overlays should stack correctly above the fixed bars */
.dropdown-menu {
  z-index: 5000 !important;
}

.present-mode {
  z-index: 6000 !important; /* presentation overlay above everything */
}
/* =================== END FIXES OVERRIDES =================== */



/* ===================== TOOLTIP CLIP FIXES ===================== */
/* Allow tooltips inside slides to escape the slide box */
.canvas-slide { overflow: visible !important; }
/* Ensure any element that shows tooltip is not clipping its pseudo-elements */
.element, [data-tooltip] { overflow: visible !important; }
/* Lift slide itself above toolbar if needed when hovering */
.canvas-slide:hover { z-index: 4500; }
/* Keep tooltips the highest */
[data-tooltip]:hover::before, [data-tooltip]:hover::after { z-index: 5000 !important; }
/* =================== END TOOLTIP CLIP FIXES =================== */


/* ============ JS Tooltip Portal Overrides ============ */
[data-tooltip]::before, [data-tooltip]::after { display: none !important; }
.js-tooltip {
  position: fixed;
  padding: 6px 10px;
  background: #1f2937;
  color: #fff;
  font-size: 12px;
  font-weight: 600;
  border-radius: 6px;
  white-space: nowrap;
  z-index: 10000; /* above header/toolbar */
  pointer-events: none;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  transform: translate(-50%, -6px);
}
.js-tooltip-arrow {
  position: fixed;
  width: 0;
  height: 0;
  border: 6px solid transparent;
  border-top-color: #1f2937;
  z-index: 10000;
  pointer-events: none;
  transform: translate(-50%, 0);
}
/* ============ End Overrides ============ */


/* ===================== COMPACT UI PASS ===================== */
:root{
  --btn-h: 34px;
  --btn-fs: 12px;
  --btn-px: 10px;
  --gap: 8px;
  --radius: 10px;
  --toolbar-top: 56px; /* header height */
}

/* Header refinement */
.header{
  padding: 10px 16px !important;
  min-height: var(--toolbar-top);
}
.title-input{ min-width: 260px !important; font-size: 13px !important; padding: 8px 12px !important; }

/* Toolbar refinement */
.toolbar{
  top: var(--toolbar-top) !important;
  padding: 10px 16px !important;
  gap: var(--gap) !important;
}

/* Button base */
.header-btn, .tool-btn, .zoom-btn, .zoom-reset {
  height: var(--btn-h) !important;
  padding: 0 var(--btn-px) !important;
  font-size: var(--btn-fs) !important;
  border-radius: var(--radius) !important;
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  border: 1px solid #e5e7eb !important;
  background: #fff;
  box-shadow: none !important;
}

/* Share button should keep emerald gradient */
.share-btn {
  background: linear-gradient(to right, #10b981, #059669) !important;
  color: white !important;
  border: none !important;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
}
.share-btn:hover {
  background: linear-gradient(to right, #059669, #047857) !important;
  color: white !important;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
}

/* Icons boldness */
.tool-btn strong, .tool-btn em, .tool-btn u { font-size: 12px !important; }

/* Selects & number inputs same height */
select.tool-btn, input[type="number"].tool-btn {
  height: var(--btn-h) !important;
  padding: 0 8px !important;
  min-width: 64px;
}

/* Color inputs smaller */
input[type="color"]{
  width: 30px !important;
  height: 30px !important;
  padding: 0 !important;
  border-radius: 6px !important;
}

/* Divider slimmer */
.tool-divider{ height: 26px !important; margin: 0 4px !important; background: #eef2f7 !important; }

/* Dropdown menu tighter */
.dropdown-menu{ min-width: 180px !important; }
.dropdown-item{ padding: 10px 12px !important; font-size: 12px !important; }

/* Sidebar spacing */
.sidebar{ padding: 12px 10px !important; gap: 10px !important; }
.sidebar-add-slide{ padding: 10px !important; font-size: 12px !important; }
.sidebar-slide-number{ font-size: 9px !important; padding: 2px 6px !important; }
.sidebar-slide{ border-width: 2px !important; }

/* Slide badge smaller */
.slide-number-badge{ font-size: 11px !important; padding: 4px 10px !important; }

/* Zoom control smaller */
.zoom-control{
  padding: 10px 12px !important;
  gap: 10px !important;
  border-radius: 10px !important;
}
.zoom-slider{ width: 100px !important; }
.zoom-value{ font-size: 12px !important; min-width: 40px !important; }

/* Container offset update to match tighter bars */
/* Removed - using unified container margin-top below */
/* =================== END COMPACT UI PASS =================== */



/* ===================== KEEP HEADER AS-IS & BEAUTIFY TOOLBAR ===================== */
:root{
  --header-h: 60px;        /* header fixed height */
  --toolbar-h: 52px;       /* toolbar visual height after compacting */
}

/* 1) Restore original header styling (no compact changes) */
.header {
  padding: 14px 24px !important;     /* original spacing */
  min-height: unset !important;
}
.header .header-btn{
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1.5px solid rgba(203, 213, 225, 0.9) !important;
  color: #1e293b !important;
  padding: 8px 16px !important;
  border-radius: 8px !important;
  font-size: 13px !important;
  font-weight: 600 !important;
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08) !important;
  height: auto !important;
}
.header .header-btn:hover{ 
  background: rgba(16, 185, 129, 0.12) !important; 
  border-color: rgba(16, 185, 129, 0.4) !important;
  color: #047857 !important;
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.2) !important;
}
.header .share-btn{
  background: linear-gradient(to right, #10b981, #059669) !important;
  color: white !important;
  padding: 9px 24px !important;
  border: none !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  font-size: 13px !important;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
  height: auto !important;
}
.header .share-btn:hover {
  background: linear-gradient(to right, #059669, #047857) !important;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
}
.title-input{
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1.5px solid rgba(203, 213, 225, 0.9) !important;
  color: #1e293b !important;
  font-size: 14px !important;
  font-weight: 500 !important;
  padding: 9px 16px !important;
  border-radius: 8px !important;
  min-width: 320px !important;
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08) !important;
}
.title-input::placeholder {
  color: rgba(100, 116, 139, 0.7) !important;
}

/* 2) Toolbar tidy look (smaller buttons, subtle hover) */
.toolbar{
  top: var(--header-h) !important;
  padding: 10px 20px !important;
  gap: 8px !important;
  background: #fff !important;
  border-bottom: 1px solid #e5e7eb !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03) !important;
}

.tool-btn{
  height: 34px !important;
  padding: 0 10px !important;
  font-size: 12.5px !important;
  background: #f9fafb !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 6px !important;
  box-shadow: none !important;
  color: #374151 !important;
}
.tool-btn:hover{
  background: rgba(16, 185, 129, 0.1) !important;
  border-color: rgba(16, 185, 129, 0.3) !important;
  color: #059669 !important;
}
.tool-btn:active, .tool-btn:focus{
  background: rgba(16, 185, 129, 0.15) !important;
  color: #047857 !important;
  outline: none !important;
}

/* Inputs same height as buttons */
select.tool-btn, input[type="number"].tool-btn{
  height: 34px !important;
  min-width: 64px;
}
input[type="color"]{
  width: 30px !important; height: 30px !important; border-radius: 6px !important;
}

/* Divider thinner */
.tool-divider{ height: 26px !important; margin: 0 4px !important; background: #eef2f7 !important; }

/* 3) Proper top offset so content doesn't hide under bars */
.container{
  margin-top: 112px !important;
  height: calc(100vh - 112px) !important;
}

/* Keep tooltips over everything */
[data-tooltip]::before, [data-tooltip]::after{ z-index: 5000 !important; }

/* =================== AI Panel Styles =================== */
.ai-message {
    display: flex;
    margin-bottom: 12px;
    animation: fadeIn 0.3s ease-in;
}

.ai-message.user {
    justify-content: flex-end;
}

.ai-message.ai-assistant {
    justify-content: flex-start;
}

.ai-message-content {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.6;
}

.ai-message.user .ai-message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.ai-message.ai-assistant .ai-message-content {
    background: white;
    color: #0f172a;
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.ai-message-content ul {
    margin: 8px 0;
    padding-right: 20px;
}

.ai-message-content li {
    margin: 4px 0;
}

.ai-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #e0e7ff;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

#aiChatInput:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.ai-lang-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(3, 105, 161, 0.2);
}

#aiPreviewContainer {
    margin-top: 12px;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* AI Sidebar Styles */
.ai-sidebar {
    position: fixed;
    right: 0;
    top: 160px;
    width: 400px;
    height: calc(100vh - 160px);
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
    z-index: 1500;
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease-out;
    overflow: hidden;
}

.ai-sidebar.visible {
    transform: translateX(0);
}

.ai-sidebar-header {
    padding: 16px 20px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ai-sidebar-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.ai-sidebar-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.ai-sidebar-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.ai-sidebar-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ai-sidebar-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8fafc;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ai-sidebar-input-area {
    padding: 16px;
    border-top: 1px solid #e5e7eb;
    background: white;
}

/* Adjust container when AI sidebar is open */
.container.ai-sidebar-open {
    margin-right: 400px;
}

/* =================== END =================== */

</style>
</head>
<body>
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" onclick="app.groupElements(); app.hideContextMenu();">Group</div>
    <div class="context-menu-item" onclick="app.ungroupElements(); app.hideContextMenu();">Ungroup</div>
    <div class="context-menu-item" onclick="app.duplicateElement(); app.hideContextMenu();">Duplicate</div>
    <div class="context-menu-item" onclick="app.deleteElement(); app.hideContextMenu();">Delete</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="app.moveLayer('forward'); app.hideContextMenu();">Bring Forward</div>
    <div class="context-menu-item" onclick="app.moveLayer('backward'); app.hideContextMenu();">Send Backward</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="app.copyStyle(); app.hideContextMenu();">Copy Style</div>
    <div class="context-menu-item" onclick="app.pasteStyle(); app.hideContextMenu();">Paste Style</div>
</div>
<div class="header">
<div class="header-left">
<a href="templates.html" class="templates-btn"> Templates</a>
<div class="header-brand">
<img src="assets/aramco-digital-logo.png" alt="Aramco Digital" />
<span class="header-brand-text">Presentation Lab</span>
</div>
<input class="title-input" id="title" placeholder="Untitled Presentation" type="text"/>
</div>
<div class="header-right">
<button class="header-btn" onclick="app.toggleAIPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
  AI
</button>
<button class="header-btn grey-style" onclick="app.newPresentation()">New</button>
<button class="header-btn grey-style" onclick="app.saveJSON()">Save</button>
<button class="header-btn grey-style" onclick="app.loadJSON()">Load</button>
<button class="header-btn" data-tooltip="Undo (Ctrl+Z)" disabled="" id="undoBtn" onclick="app.undo()">Undo</button>
<button class="header-btn" data-tooltip="Redo (Ctrl+Y)" disabled="" id="redoBtn" onclick="app.redo()">Redo</button>
<div style="position: relative;">
<button class="share-btn" onclick="app.toggleExport()">Export </button>
<div class="dropdown-menu" id="exportMenu">
<div class="dropdown-item" onclick="app.exportPDF()">Export as PDF</div>
<div class="dropdown-item" onclick="app.exportImages()">Export as Images</div>
<div class="dropdown-item" onclick="app.shareLink()">Share Link</div>
</div>
</div>
</div>
</div>
<div class="toolbar">
<div class="toolbar-nav">
<nav style="flex: 1; display: flex; align-items: center; gap: 4px;">
<button class="category-tab" data-category="design" onclick="app.showCategory('design')">
<span class="dot"></span> Design
            </button>
<button class="category-tab" data-category="text" onclick="app.showCategory('text')">
<span class="dot"></span> Text
</button>
<button class="category-tab" data-category="image" onclick="app.showCategory('image')">
<span class="dot"></span> Image
</button>
<button class="category-tab" data-category="shape-data" onclick="app.showCategory('shape-data')">
<span class="dot"></span> Shape & Data
</button>
<button class="category-tab" data-category="effects" onclick="app.showCategory('effects')">
<span class="dot"></span> Effects
</button>
</nav>
<div style="display: flex; align-items: center; gap: 8px;">
<button class="share-btn" data-tooltip="Start Presentation (F5)" onclick="app.presentMode()" style="padding: 8px 20px; font-size: 13px;">
<span></span> Present
</button>
<button class="share-btn" onclick="app.toggleExport()" style="padding: 8px 20px; font-size: 13px;">Share</button>
                </div>
                </div>
<div class="category-panel" id="categoryPanel">
<div class="category-panel-content" id="categoryPanelContent">
<!-- Content will be dynamically inserted here -->
                </div>
                </div>
</div>
<div class="container">
<div class="sidebar" id="sidebar">
<div class="sidebar-header">Slides</div>
<div id="slides"></div>
<button class="sidebar-add-slide" onclick="app.addSlide()">+ Add Slide</button>
</div>
<div class="main-canvas" id="mainCanvas">
<div class="canvas-wrapper" id="canvasWrapper">
<!-- Slides will be rendered here -->
</div>
</div>
<div class="properties-panel" id="propertiesPanel">
<div class="properties-panel-header">
<span>Properties</span>
<div class="properties-panel-actions" id="propertiesActions" style="display: none;">
<button class="properties-action-btn" onclick="app.duplicateElement()" title="Duplicate"></button>
<button class="properties-action-btn delete" onclick="app.deleteElement()" title="Delete"></button>
</div>
</div>
<div id="propertiesContent" class="properties-section">
<div class="properties-empty">
<div class="properties-empty-title">No Selection</div>
<div class="properties-empty-text">Select an element on the canvas to edit its properties</div>
</div>
</div>
</div>
</div>
<!-- Zoom Control Bar with Present Button -->
<div class="zoom-control">
<button class="share-btn" data-tooltip="Start Presentation (F5)" onclick="app.presentMode()">
<span></span> Present
        </button>
<div class="zoom-divider"></div>
<button class="zoom-btn" data-tooltip="Zoom Out" onclick="app.zoomOut()" title="Zoom Out"></button>
<input class="zoom-slider" id="zoomSlider" max="200" min="25" oninput="app.setZoom(this.value)" step="5" type="range" value="100"/>
<div class="zoom-value" id="zoomValue">100%</div>
<button class="zoom-btn" data-tooltip="Zoom In" onclick="app.zoomIn()" title="Zoom In">+</button>
<button class="zoom-reset" data-tooltip="Reset Zoom" onclick="app.resetZoom()">Reset</button>
</div>
<!-- Background Modal -->
<div class="modal" id="bgModal">
<div class="modal-content">
<span class="modal-close" onclick="app.closeModal('bgModal')"></span>
<div class="modal-header">Choose Slide Background</div>
<div class="bg-grid">
<div class="bg-option" onclick="app.applyBg('white')" style="background: white;"></div>
<div class="bg-option" onclick="app.applyBg('#f0fdf4')" style="background: #f0fdf4;"></div>
<div class="bg-option" onclick="app.applyBg('#ecfdf5')" style="background: #ecfdf5;"></div>
<div class="bg-option" onclick="app.applyBg('#dcfce7')" style="background: #dcfce7;"></div>
<div class="bg-option" onclick="app.applyBg('#d1fae5')" style="background: #d1fae5;"></div>
<div class="bg-option" onclick="app.applyBg('#a7f3d0')" style="background: #a7f3d0;"></div>
<div class="bg-option" onclick="app.applyBg('#e0f2fe')" style="background: #e0f2fe;"></div>
<div class="bg-option" onclick="app.applyBg('#bae6fd')" style="background: #bae6fd;"></div>
<div class="bg-option" onclick="app.applyBg('#7dd3fc')" style="background: #7dd3fc;"></div>
<div class="bg-option" onclick="app.applyBg('#ccfbf1')" style="background: #ccfbf1;"></div>
<div class="bg-option" onclick="app.applyBg('#99f6e4')" style="background: #99f6e4;"></div>
<div class="bg-option" onclick="app.applyBg('#5eead4')" style="background: #5eead4;"></div>
<div class="bg-option" onclick="app.applyBg('#dbeafe')" style="background: #dbeafe;"></div>
<div class="bg-option" onclick="app.applyBg('#bfdbfe')" style="background: #bfdbfe;"></div>
<div class="bg-option" onclick="app.applyBg('#93c5fd')" style="background: #93c5fd;"></div>
<div class="bg-option" onclick="app.applyBg('#e0e7ff')" style="background: #e0e7ff;"></div>
<div class="bg-option" onclick="app.applyBg('#c7d2fe')" style="background: #c7d2fe;"></div>
<div class="bg-option" onclick="app.applyBg('#a5b4fc')" style="background: #a5b4fc;"></div>
<div class="bg-option" onclick="app.applyBg('linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)')" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);"></div>
<div class="bg-option" onclick="app.applyBg('linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%)')" style="background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);"></div>
<div class="bg-option" onclick="app.applyBg('linear-gradient(135deg, #99f6e4 0%, #5eead4 100%)')" style="background: linear-gradient(135deg, #99f6e4 0%, #5eead4 100%);"></div>
</div>
<button class="tool-btn" onclick="app.uploadBgImage()" style="margin-top: 24px; width: 100%;">Upload Image</button>
</div>
</div>
<!-- Templates Modal -->
<div class="modal" id="templatesModal">
<div class="modal-content" style="max-width: 900px;">
<span class="modal-close" onclick="app.closeModal('templatesModal')"></span>
<div class="modal-header">Choose Layout</div>
<div class="bg-grid" id="templatesGrid">
<!-- Templates will be loaded here -->
</div>
</div>
</div>
<!-- Crop Modal -->
<div class="modal" id="cropModal">
<div class="modal-content" style="max-width: 800px;">
<span class="modal-close" onclick="app.closeModal('cropModal')"></span>
<div class="modal-header">Crop Image</div>
<div style="padding: 20px; text-align: center;">
<div style="background: #f3f4f6; border-radius: 12px; padding: 40px; margin-bottom: 20px; min-height: 400px; display: flex; align-items: center; justify-content: center;">
<img id="cropImagePreview" src="" alt="Image to crop" style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
</div>
<div style="display: flex; gap: 12px; justify-content: center;">
<button class="tool-btn" onclick="app.closeModal('cropModal')" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db;">Cancel</button>
<button class="tool-btn tool-btn-primary" onclick="app.applyCrop()" style="padding: 12px 24px;">Apply Crop</button>
</div>
<div style="margin-top: 20px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
<p style="margin: 0; font-size: 13px; color: #92400e; line-height: 1.5;">
<strong>Note:</strong> Full crop functionality is coming soon. For now, you can use image editing software to crop images before uploading.
</p>
</div>
</div>
</div>
</div>
<!-- Adjust Image Modal -->
<div class="modal" id="adjustImageModal">
<div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
<span class="modal-close" onclick="app.closeModal('adjustImageModal')"></span>
<div class="modal-header">Adjust Image</div>
<div style="padding: 20px;">
<!-- Preview -->
<div style="background: #f3f4f6; border-radius: 12px; padding: 20px; margin-bottom: 24px; text-align: center;">
<img id="adjustImagePreview" src="" alt="Image preview" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
</div>

<!-- Correction Section -->
<div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px;">
<h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #374151;">Correction</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Sharpen / Soften</label>
<div style="display: flex; align-items: center; gap: 12px;">
<input type="range" id="sharpenSlider" min="-100" max="100" value="0" oninput="app.updateImageFilter('sharpen', this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;">
<input type="number" id="sharpenInput" min="-100" max="100" value="0" onchange="app.updateImageFilter('sharpen', this.value)" style="width: 70px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center;">
</div>
</div>
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Brightness</label>
<div style="display: flex; align-items: center; gap: 12px;">
<input type="range" id="brightnessSlider" min="-100" max="100" value="0" oninput="app.updateImageFilter('brightness', this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;">
<input type="number" id="brightnessInput" min="-100" max="100" value="0" onchange="app.updateImageFilter('brightness', this.value)" style="width: 70px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center;">
</div>
</div>
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Contrast</label>
<div style="display: flex; align-items: center; gap: 12px;">
<input type="range" id="contrastSlider" min="-100" max="100" value="0" oninput="app.updateImageFilter('contrast', this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;">
<input type="number" id="contrastInput" min="-100" max="100" value="0" onchange="app.updateImageFilter('contrast', this.value)" style="width: 70px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center;">
</div>
</div>
</div>
</div>

<!-- Color Section -->
<div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px;">
<h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #374151;">Color</h3>
<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Saturation</label>
<div style="display: flex; align-items: center; gap: 12px;">
<input type="range" id="saturationSlider" min="-100" max="100" value="0" oninput="app.updateImageFilter('saturation', this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;">
<input type="number" id="saturationInput" min="-100" max="100" value="0" onchange="app.updateImageFilter('saturation', this.value)" style="width: 70px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center;">
</div>
</div>
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Color Tone</label>
<div style="display: flex; align-items: center; gap: 12px;">
<input type="range" id="toneSlider" min="-100" max="100" value="0" oninput="app.updateImageFilter('tone', this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none; appearance: none;">
<input type="number" id="toneInput" min="-100" max="100" value="0" onchange="app.updateImageFilter('tone', this.value)" style="width: 70px; padding: 6px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center;">
</div>
</div>
<div>
<label style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 8px;">Recolor</label>
<select id="recolorSelect" onchange="app.updateImageFilter('recolor', this.value)" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; background: white;">
<option value="none">None</option>
<option value="sepia">Sepia</option>
<option value="grayscale">Grayscale</option>
<option value="invert">Invert</option>
<option value="warm">Warm</option>
<option value="cool">Cool</option>
</select>
</div>
</div>
</div>

<!-- Artistic Effects Section -->
<div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 12px;">
<h3 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #374151;">Artistic Effects</h3>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('none')" style="padding: 12px;">None</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('blur')" style="padding: 12px;">Blur</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('fog')" style="padding: 12px;">Fog</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('paper')" style="padding: 12px;">Paper</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('vintage')" style="padding: 12px;">Vintage</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('pencil')" style="padding: 12px;">Pencil</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('watercolor')" style="padding: 12px;">Watercolor</button>
<button class="properties-arrange-btn" onclick="app.applyArtisticEffect('oil')" style="padding: 12px;">Oil</button>
</div>
</div>

<!-- Actions -->
<div style="display: flex; gap: 12px; justify-content: center; padding-top: 16px; border-top: 1px solid #e5e7eb;">
<button class="tool-btn" onclick="app.resetImageFilters()" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db;">Reset Image</button>
<button class="tool-btn" onclick="app.closeModal('adjustImageModal')" style="padding: 12px 24px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db;">Cancel</button>
<button class="tool-btn tool-btn-primary" onclick="app.applyImageFilters()" style="padding: 12px 24px;">Apply</button>
</div>
</div>
</div>
</div>
<!-- Themes Modal -->
<div class="modal" id="themesModal">
<div class="modal-content" style="max-width: 900px;">
<span class="modal-close" onclick="app.closeModal('themesModal')"></span>
<div class="modal-header">Choose Theme</div>
<div class="bg-grid" id="themesGrid">
<!-- Themes will be loaded here -->
</div>
</div>
</div>
<!-- Animation Modal -->
<div class="modal" id="animModal">
<div class="modal-content">
<span class="modal-close" onclick="app.closeModal('animModal')"></span>
<div class="modal-header">Choose Animation</div>
<div class="animation-grid">
<div class="animation-option" onclick="app.applyAnimation('none')">None</div>
<div class="animation-option" onclick="app.applyAnimation('fadeIn')">Fade In</div>
<div class="animation-option" onclick="app.applyAnimation('slideInLeft')">Slide In Left</div>
<div class="animation-option" onclick="app.applyAnimation('slideInRight')">Slide In Right</div>
<div class="animation-option" onclick="app.applyAnimation('slideInUp')">Slide In Up</div>
<div class="animation-option" onclick="app.applyAnimation('slideInDown')">Slide In Down</div>
<div class="animation-option" onclick="app.applyAnimation('zoomIn')">Zoom In</div>
<div class="animation-option" onclick="app.applyAnimation('bounce')">Bounce</div>
</div>
</div>
</div>
<!-- AI Assistant Sidebar -->
<div class="ai-sidebar" id="aiSidebar">
<div class="ai-sidebar-header">
<h3>
<span></span>
<span>AI Smart Assistant</span>
</h3>
<button class="ai-sidebar-close" onclick="app.toggleAIPanel()"></button>
</div>
<div class="ai-sidebar-content">
<div class="ai-sidebar-messages" id="aiChatMessages">
<div class="ai-message ai-assistant">
<div class="ai-message-content">
<div style="font-weight: 600; margin-bottom: 4px; color: #667eea;">AI Assistant</div>
<div>Hello! I'm your creative AI assistant. I can automatically:</div>
<ul style="margin: 8px 0; padding-left: 20px; color: #64748b;">
<li>Create complete slides with titles, content, and visuals</li>
<li>Add images from the internet related to your topic</li>
<li>Create charts and graphs with data</li>
<li>Add bullet points and organize content beautifully</li>
<li>Design professional layouts automatically</li>
</ul>
<div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
<div style="font-weight: 600; margin-bottom: 8px; color: #0369a1;">Choose Language:</div>
<div style="display: flex; gap: 8px;">
<button onclick="app.setAILanguage('ar')" class="ai-lang-btn" style="flex: 1; padding: 10px; background: white; border: 2px solid #bae6fd; border-radius: 8px; cursor: pointer; font-weight: 600; color: #0369a1; transition: all 0.2s;"> </button>
<button onclick="app.setAILanguage('en')" class="ai-lang-btn" style="flex: 1; padding: 10px; background: #0369a1; color: white; border: 2px solid #0369a1; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;"> English</button>
</div>
</div>
</div>
</div>
</div>
<div id="aiPreviewContainer" style="display: none; padding: 0 20px 20px 20px;"></div>
</div>
<div class="ai-sidebar-input-area">
<div style="display: flex; gap: 8px;">
<input type="text" id="aiChatInput" placeholder="Type your request... (e.g., Create 5 slides about AI)" style="flex: 1; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; font-family: inherit; outline: none; transition: border-color 0.2s;" onkeypress="if(event.key === 'Enter') app.sendAIMessage()">
<button onclick="app.sendAIMessage()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Send</button>
</div>
<div id="aiLoading" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; color: #0369a1; font-size: 13px;">
<div style="display: flex; align-items: center; gap: 8px;">
<div class="ai-spinner"></div>
<span id="aiLoadingText">Processing...</span>
</div>
</div>
</div>
</div>
</div>
<script>
        const app = {
            data: [{ els: [], bg: 'white', transition: 'fade' }],
            curr: 0,
            sel: null,
            drag: null,
            resize: null,
            history: [],
            historyIndex: -1,
            presenting: false,
            presentSlide: 0,
            copiedStyle: null,
            zoom: 100,
            gridVisible: false,
            snapToGrid: false,
            snapThreshold: 10,

            activeCategory: null,
            thumbnailUpdateTimeout: null,

            init() {
                this.loadCanvas();
                this.renderSlides();
                this.setupDragDrop();
                this.setupKeyboardShortcuts();
                this.saveState();
                
                // Hide context menu on click anywhere
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#contextMenu')) {
                        this.hideContextMenu();
                    }
                });
            },

            showCategory(category) {
                const panel = document.getElementById('categoryPanel');
                const content = document.getElementById('categoryPanelContent');
                const tabs = document.querySelectorAll('.category-tab');
                const propertiesPanel = document.getElementById('propertiesPanel');
                
                // Toggle active state
                if (this.activeCategory === category) {
                    // Close panel if clicking same category
                    panel.classList.remove('show');
                    tabs.forEach(tab => {
                        if (tab.dataset.category === category) {
                            tab.classList.remove('active');
                        }
                    });
                    this.activeCategory = null;
                    // Remove padding from properties panel
                    if (propertiesPanel) {
                        propertiesPanel.classList.remove('category-panel-open');
                    }
                    return;
                }

                // Update active tab
                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.category === category);
                });

                // Show panel and set content
                this.activeCategory = category;
                content.innerHTML = this.getCategoryContent(category);
                panel.classList.add('show');
                
                // Add padding to properties panel when category panel is open
                if (propertiesPanel && propertiesPanel.classList.contains('visible')) {
                    propertiesPanel.classList.add('category-panel-open');
                }
            },

            getCategoryContent(category) {
                const contents = {
                    design: `
                        <div class="category-panel-group">
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('bgColorDropdown')">Background Color</button>
                                <div class="category-dropdown" id="bgColorDropdown">
                                    <div class="category-dropdown-item" onclick="app.uploadBgImage(); app.closeDropdown('bgColorDropdown');" style="display: flex; align-items: center; gap: 8px; padding: 10px;">
                                        <span style="font-size: 16px;"></span>
                                        <span>Upload Image</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 10px;">
                                        <div class="bg-color-item" onclick="app.applyBg('white'); app.closeDropdown('bgColorDropdown');" style="background: white; border: 1px solid #e5e7eb;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#f0fdf4'); app.closeDropdown('bgColorDropdown');" style="background: #f0fdf4;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#ecfdf5'); app.closeDropdown('bgColorDropdown');" style="background: #ecfdf5;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#dcfce7'); app.closeDropdown('bgColorDropdown');" style="background: #dcfce7;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#d1fae5'); app.closeDropdown('bgColorDropdown');" style="background: #d1fae5;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#a7f3d0'); app.closeDropdown('bgColorDropdown');" style="background: #a7f3d0;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#e0f2fe'); app.closeDropdown('bgColorDropdown');" style="background: #e0f2fe;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#bae6fd'); app.closeDropdown('bgColorDropdown');" style="background: #bae6fd;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#7dd3fc'); app.closeDropdown('bgColorDropdown');" style="background: #7dd3fc;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#ccfbf1'); app.closeDropdown('bgColorDropdown');" style="background: #ccfbf1;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#99f6e4'); app.closeDropdown('bgColorDropdown');" style="background: #99f6e4;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#5eead4'); app.closeDropdown('bgColorDropdown');" style="background: #5eead4;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#dbeafe'); app.closeDropdown('bgColorDropdown');" style="background: #dbeafe;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#bfdbfe'); app.closeDropdown('bgColorDropdown');" style="background: #bfdbfe;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#93c5fd'); app.closeDropdown('bgColorDropdown');" style="background: #93c5fd;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#e0e7ff'); app.closeDropdown('bgColorDropdown');" style="background: #e0e7ff;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#c7d2fe'); app.closeDropdown('bgColorDropdown');" style="background: #c7d2fe;"></div>
                                        <div class="bg-color-item" onclick="app.applyBg('#a5b4fc'); app.closeDropdown('bgColorDropdown');" style="background: #a5b4fc;"></div>
                                    </div>
                                    <div style="padding: 10px; border-top: 1px solid #e5e7eb; margin-top: 8px;">
                                        <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 10px;">Gradients</div>
                                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #99f6e4 0%, #5eead4 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #99f6e4 0%, #5eead4 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #f472b6 0%, #ec4899 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #f472b6 0%, #ec4899 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #34d399 0%, #10b981 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #34d399 0%, #10b981 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #fda4af 0%, #f43f5e 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #fda4af 0%, #f43f5e 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #818cf8 0%, #6366f1 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #fb923c 0%, #f97316 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);"></div>
                                            <div class="bg-color-item" onclick="app.applyBg('linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%)'); app.closeDropdown('bgColorDropdown');" style="background: linear-gradient(135deg, #2dd4bf 0%, #14b8a6 100%);"></div>
                                        </div>
                                    </div>
                                    <div style="padding: 10px; border-top: 1px solid #e5e7eb; margin-top: 8px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <label style="font-size: 12px; font-weight: 500; color: #374151; min-width: 90px;">Transparency</label>
                                            <input type="range" id="bgTransparencySlider" min="0" max="100" value="0" oninput="app.updateBgTransparency(this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none;">
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="number" id="bgTransparencyInput" min="0" max="100" value="0" onchange="app.updateBgTransparency(this.value)" oninput="app.updateBgTransparency(this.value)" style="width: 60px; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center; outline: none;">
                                                <span style="font-size: 12px; color: #6b7280;">%</span>
                                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                                    <button type="button" onclick="app.adjustTransparency(1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                                    <button type="button" onclick="app.adjustTransparency(-1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button class="tool-btn" onclick="app.showTemplates()">Layout</button>
                            <button class="tool-btn" onclick="app.showThemes()">Themes</button>
                        </div>
                    `,
                    text: `
                        <div class="category-panel-group">
                            <button class="tool-btn tool-btn-primary" onclick="app.addText()">+ Add Text</button>
                        </div>
                        <div class="category-panel-group">
                            <span class="category-panel-label">Font</span>
                            <select class="tool-btn" id="fontFamily" onchange="app.changeFont()" style="text-transform: none; letter-spacing: 0;">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Kraft Mono">Kraft Mono</option>
                                <option value="ID Grotesk">ID Grotesk</option>
                            </select>
                            <input class="tool-btn" id="fontSize" type="number" min="8" max="200" value="24" onchange="app.changeFontSize()" placeholder="Size" style="width: 80px; text-transform: none; letter-spacing: 0;" />
                        </div>
                        <div class="category-panel-group">
                            <button class="tool-btn tool-btn-icon" onclick="app.toggleBold()" title="Bold"><strong>B</strong></button>
                            <button class="tool-btn tool-btn-icon" onclick="app.toggleItalic()" title="Italic"><em>I</em></button>
                            <button class="tool-btn tool-btn-icon" onclick="app.toggleUnderline()" title="Underline"><u>U</u></button>
                        </div>
                        <div class="category-panel-group">
                            <span class="category-panel-label">Color</span>
                            <input type="color" id="textColor" value="#000000" onchange="app.changeTextColor()" style="width: 44px; height: 40px; border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 10px; cursor: pointer; box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);" />
                            <input type="color" id="bgColor" value="#ffffff" onchange="app.changeBgColor()" style="width: 44px; height: 40px; border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 10px; cursor: pointer; box-shadow: 0 2px 4px rgba(15, 23, 42, 0.08);" />
                        </div>
                        <div class="category-panel-group">
                            <span class="category-panel-label">Align</span>
                            <button class="tool-btn tool-btn-icon" onclick="app.alignText('left')" title="Align Left"></button>
                            <button class="tool-btn tool-btn-icon" onclick="app.alignText('center')" title="Align Center"></button>
                            <button class="tool-btn tool-btn-icon" onclick="app.alignText('right')" title="Align Right"></button>
                        </div>
                    `,
                    image: `
                        <div class="category-panel-group">
                            <button class="tool-btn tool-btn-primary" onclick="app.addImage()">Upload Image</button>
                        </div>
                        <div class="category-panel-group">
                            <button class="tool-btn" onclick="app.removeBackground()">Remove Background</button>
                        </div>
                    `,
                    'shape-data': `
                        <div class="category-panel-group">
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('shapesDropdown')">Shapes</button>
                                <div class="category-dropdown" id="shapesDropdown">
                                    <div class="category-dropdown-item" onclick="app.addShape('rectangle'); app.closeDropdown('shapesDropdown')">Rectangle</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('circle'); app.closeDropdown('shapesDropdown')">Circle</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('triangle'); app.closeDropdown('shapesDropdown')">Triangle</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('star'); app.closeDropdown('shapesDropdown')">Star</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('hexagon'); app.closeDropdown('shapesDropdown')">Hexagon</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('diamond'); app.closeDropdown('shapesDropdown')">Diamond</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('arrow-right'); app.closeDropdown('shapesDropdown')">Arrow Right</div>
                                    <div class="category-dropdown-item" onclick="app.addShape('arrow-left'); app.closeDropdown('shapesDropdown')">Arrow Left</div>
                                </div>
                            </div>
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('chartsDropdown')">Charts</button>
                                <div class="category-dropdown" id="chartsDropdown">
                                    <div class="category-dropdown-item" onclick="app.addChart('bar'); app.closeDropdown('chartsDropdown')">Bar Chart</div>
                                    <div class="category-dropdown-item" onclick="app.addChart('line'); app.closeDropdown('chartsDropdown')">Line Chart</div>
                                    <div class="category-dropdown-item" onclick="app.addChart('pie'); app.closeDropdown('chartsDropdown')">Pie Chart</div>
                                </div>
                            </div>
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('tablesDropdown')">Tables</button>
                                <div class="category-dropdown" id="tablesDropdown">
                                    <div class="category-dropdown-item" onclick="app.addTable(2, 2); app.closeDropdown('tablesDropdown')">2x2 Table</div>
                                    <div class="category-dropdown-item" onclick="app.addTable(3, 3); app.closeDropdown('tablesDropdown')">3x3 Table</div>
                                    <div class="category-dropdown-item" onclick="app.addTable(4, 4); app.closeDropdown('tablesDropdown')">4x4 Table</div>
                                </div>
                            </div>
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('iconsDropdown')">Symbols</button>
                                <div class="category-dropdown" id="iconsDropdown">
                                    <div class="category-dropdown-item" onclick="app.showSymbols('arrows'); app.closeDropdown('iconsDropdown')">Arrows</div>
                                    <div class="category-dropdown-item" onclick="app.showSymbols('shapes'); app.closeDropdown('iconsDropdown')">Shapes</div>
                                    <div class="category-dropdown-item" onclick="app.showSymbols('symbols'); app.closeDropdown('iconsDropdown')">Symbols</div>
                                </div>
                            </div>
                        </div>
                    `,
                    arrange: `
                        <div class="category-panel-group">
                            <div class="dropdown-wrapper">
                                <button class="tool-btn dropdown-btn" onclick="app.toggleDropdown('alignDropdown')">Align</button>
                                <div class="category-dropdown" id="alignDropdown">
                                    <div class="category-dropdown-item" onclick="app.alignElements('left'); app.closeDropdown('alignDropdown')">Align Left</div>
                                    <div class="category-dropdown-item" onclick="app.alignElements('center'); app.closeDropdown('alignDropdown')">Align Center</div>
                                    <div class="category-dropdown-item" onclick="app.alignElements('right'); app.closeDropdown('alignDropdown')">Align Right</div>
                                    <div class="category-dropdown-item" onclick="app.alignElements('top'); app.closeDropdown('alignDropdown')">Align Top</div>
                                    <div class="category-dropdown-item" onclick="app.alignElements('middle'); app.closeDropdown('alignDropdown')">Align Middle</div>
                                    <div class="category-dropdown-item" onclick="app.alignElements('bottom'); app.closeDropdown('alignDropdown')">Align Bottom</div>
                                </div>
                            </div>
                            <button class="tool-btn" onclick="app.groupElements()">Group</button>
                            <button class="tool-btn" onclick="app.ungroupElements()">Ungroup</button>
                            <button class="tool-btn" onclick="app.duplicateElement()">Duplicate</button>
                            <button class="tool-btn tool-btn-danger" onclick="app.deleteElement()">Delete</button>
                        </div>
                        <div class="category-panel-group">
                            <button class="tool-btn" onclick="app.moveLayer('forward')">Bring Forward</button>
                            <button class="tool-btn" onclick="app.moveLayer('backward')">Send Backward</button>
                            <button class="tool-btn" onclick="app.copyStyle()">Copy Style</button>
                            <button class="tool-btn" onclick="app.pasteStyle()">Paste Style</button>
                            <button class="tool-btn" id="gridBtn" onclick="app.toggleGrid()">Grid</button>
                        </div>
                    `,
                    effects: `
                        <div class="category-panel-group">
                            <span class="category-panel-label">Animations</span>
                            <button class="tool-btn" onclick="app.showAnimations()">Element Animations</button>
                        </div>
                        <div class="category-panel-group">
                            <span class="category-panel-label">Transitions</span>
                            <button class="tool-btn" onclick="app.showTransitions()">Slide Transitions</button>
                        </div>
                    `
                };
                return contents[category] || '';
            },

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Don't trigger shortcuts when typing in input fields
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.contentEditable === 'true') {
                        return;
                    }

                    // Presentation Mode: F5
                    if (e.key === 'F5') {
                        e.preventDefault();
                        this.presentMode();
                    }

                    // Add Text: T
                    if (e.key === 't' || e.key === 'T') {
                        e.preventDefault();
                        this.addText();
                    }

                    // Add Image: I
                    if (e.key === 'i' || e.key === 'I') {
                        e.preventDefault();
                        this.addImage();
                    }

                    // Toggle Grid: G
                    if (e.key === 'g' || e.key === 'G') {
                        e.preventDefault();
                        this.toggleGrid();
                    }

                    // Delete: Delete or Backspace
                    if ((e.key === 'Delete' || e.key === 'Backspace') && this.sel) {
                        e.preventDefault();
                        this.deleteElement();
                    }

                    // Undo: Ctrl+Z
                    if (e.ctrlKey && e.key === 'z') {
                        e.preventDefault();
                        this.undo();
                    }

                    // Redo: Ctrl+Y
                    if (e.ctrlKey && e.key === 'y') {
                        e.preventDefault();
                        this.redo();
                    }

                    // Duplicate: Ctrl+D
                    if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        this.duplicateElement();
                    }

                    // Bold: Ctrl+B
                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        this.toggleBold();
                    }

                    // Italic: Ctrl+I
                    if (e.ctrlKey && e.key === 'i') {
                        e.preventDefault();
                        this.toggleItalic();
                    }

                    // Underline: Ctrl+U
                    if (e.ctrlKey && e.key === 'u') {
                        e.preventDefault();
                        this.toggleUnderline();
                    }

                    // Save: Ctrl+S
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.saveJSON();
                    }

                    // Arrow keys to move selected element
                    if (this.sel && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                        e.preventDefault();
                        const step = e.shiftKey ? 10 : 1;
                        const currentLeft = parseInt(this.sel.style.left) || 0;
                        const currentTop = parseInt(this.sel.style.top) || 0;

                        switch(e.key) {
                            case 'ArrowLeft':
                                this.sel.style.left = Math.max(0, currentLeft - step) + 'px';
                                break;
                            case 'ArrowRight':
                                this.sel.style.left = Math.min(960 - this.sel.offsetWidth, currentLeft + step) + 'px';
                                break;
                            case 'ArrowUp':
                                this.sel.style.top = Math.max(0, currentTop - step) + 'px';
                                break;
                            case 'ArrowDown':
                                this.sel.style.top = Math.min(540 - this.sel.offsetHeight, currentTop + step) + 'px';
                                break;
                        }
                        this.saveElementPosition();
                    }
                });
            },

            toggleGrid() {
                this.gridVisible = !this.gridVisible;
                const overlays = document.querySelectorAll('.canvas-grid-overlay');
                const btn = document.getElementById('gridBtn');
                
                if (this.gridVisible) {
                    overlays.forEach(overlay => overlay.classList.add('show'));
                    btn.style.background = '#ecfeff';
                    btn.style.color = '#0891b2';
                } else {
                    overlays.forEach(overlay => overlay.classList.remove('show'));
                    btn.style.background = 'white';
                    btn.style.color = '#374151';
                }
            },

            snapToGridPosition(value) {
                if (!this.snapToGrid) return value;
                const gridSize = 20;
                return Math.round(value / gridSize) * gridSize;
            },

            showSnapLine(type, position) {
                const slides = document.querySelectorAll('.canvas-slide');
                const currentSlide = slides[this.curr];
                if (!currentSlide) return;
                
                const line = document.createElement('div');
                line.className = `snap-line ${type}`;
                if (type === 'horizontal') {
                    line.style.top = position + 'px';
                } else {
                    line.style.left = position + 'px';
                }
                currentSlide.appendChild(line);
                setTimeout(() => line.remove(), 500);
            },

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: '',
                    error: '',
                    warning: ''
                };
                
                notification.innerHTML = `
                    <span class="notification-icon">${icons[type] || icons.success}</span>
                    <span class="notification-text">${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            },

            showLoading() {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.id = 'loadingOverlay';
                overlay.innerHTML = '<div class="loading-spinner"></div>';
                document.body.appendChild(overlay);
            },

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.remove();
            },

            setupDragDrop() {
                const wrapper = document.getElementById('canvasWrapper');
                
                wrapper.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('resize-handle')) {
                        const parentEl = e.target.parentElement;
                        // Don't allow resizing locked elements
                        if (parentEl.dataset.locked === 'true') {
                            return;
                        }
                        this.resize = {
                            el: parentEl,
                            handle: e.target.className.split(' ')[1],
                            startX: e.clientX,
                            startY: e.clientY,
                            startWidth: parentEl.offsetWidth,
                            startHeight: parentEl.offsetHeight,
                            startLeft: parentEl.offsetLeft,
                            startTop: parentEl.offsetTop
                        };
                        return;
                    }
                    
                    if (e.target.classList.contains('element') || e.target.closest('.element')) {
                        const el = e.target.classList.contains('element') ? e.target : e.target.closest('.element');
                        
                        // Check if element is locked
                        if (el.dataset.locked === 'true') {
                            return; // Don't allow interaction with locked elements
                        }
                        
                        const slideIndex = parseInt(el.dataset.slideIndex);
                        
                        // Switch to this slide if not current
                        if (slideIndex !== this.curr) {
                            this.switchSlide(slideIndex);
                            return;
                        }
                        
                        this.selectElement(el);
                        this.drag = {
                            el: el,
                            startX: e.clientX,
                            startY: e.clientY,
                            startLeft: el.offsetLeft,
                            startTop: el.offsetTop
                        };
                    } else {
                        this.deselectAll();
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (this.drag) {
                        const dx = (e.clientX - this.drag.startX) / (this.zoom / 100);
                        const dy = (e.clientY - this.drag.startY) / (this.zoom / 100);
                        
                        let newLeft = this.drag.startLeft + dx;
                        let newTop = this.drag.startTop + dy;

                        // Snap to grid if enabled
                        if (e.shiftKey) {
                            newLeft = this.snapToGridPosition(newLeft);
                            newTop = this.snapToGridPosition(newTop);
                        }

                        // Keep element within canvas bounds
                        newLeft = Math.max(0, Math.min(960 - this.drag.el.offsetWidth, newLeft));
                        newTop = Math.max(0, Math.min(540 - this.drag.el.offsetHeight, newTop));

                        this.drag.el.style.left = newLeft + 'px';
                        this.drag.el.style.top = newTop + 'px';

                        // Show snap guidelines at center
                        const centerX = newLeft + this.drag.el.offsetWidth / 2;
                        const centerY = newTop + this.drag.el.offsetHeight / 2;
                        
                        if (Math.abs(centerX - 480) < this.snapThreshold) {
                            this.showSnapLine('vertical', 480);
                            this.drag.el.style.left = (480 - this.drag.el.offsetWidth / 2) + 'px';
                        }
                        if (Math.abs(centerY - 270) < this.snapThreshold) {
                            this.showSnapLine('horizontal', 270);
                            this.drag.el.style.top = (270 - this.drag.el.offsetHeight / 2) + 'px';
                        }
                    }
                    
                    if (this.resize) {
                        const dx = (e.clientX - this.resize.startX) / (this.zoom / 100);
                        const dy = (e.clientY - this.resize.startY) / (this.zoom / 100);
                        
                        if (this.resize.handle.includes('e')) {
                            this.resize.el.style.width = Math.max(20, this.resize.startWidth + dx) + 'px';
                        }
                        if (this.resize.handle.includes('w')) {
                            const newWidth = Math.max(20, this.resize.startWidth - dx);
                            this.resize.el.style.width = newWidth + 'px';
                            this.resize.el.style.left = (this.resize.startLeft + dx) + 'px';
                        }
                        if (this.resize.handle.includes('s')) {
                            this.resize.el.style.height = Math.max(20, this.resize.startHeight + dy) + 'px';
                        }
                        if (this.resize.handle.includes('n')) {
                            const newHeight = Math.max(20, this.resize.startHeight - dy);
                            this.resize.el.style.height = newHeight + 'px';
                            this.resize.el.style.top = (this.resize.startTop + dy) + 'px';
                        }
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (this.drag || this.resize) {
                        this.saveElementPosition();
                        this.drag = null;
                        this.resize = null;
                    }
                });
            },

            selectElement(el) {
                if (!el || !el.dataset || !el.dataset.id) {
                    console.error('Invalid element selected');
                    return;
                }
                
                // Don't allow selection of locked elements
                if (el.dataset.locked === 'true') {
                    return;
                }
                
                this.deselectAll();
                el.classList.add('selected');
                this.sel = el;
                
                // Convert dataset.id to number for comparison (dataset.id is always a string)
                const elementId = parseInt(el.dataset.id, 10);
                const data = this.data[this.curr].els.find(e => e.id == elementId || e.id == el.dataset.id);
                if (!data) {
                    console.error('Element data not found for id:', el.dataset.id, 'Current slide:', this.curr, 'Available elements:', this.data[this.curr].els.map(e => e.id));
                    this.renderPropertiesPanel(null);
                    return;
                }
                
                if (data.type === 'text') {
                    const fontFamily = document.getElementById('fontFamily');
                    const fontSize = document.getElementById('fontSize');
                    const textColor = document.getElementById('textColor');
                    const bgColor = document.getElementById('bgColor');
                    
                    if (fontFamily) fontFamily.value = data.font || 'Arial';
                    if (fontSize) fontSize.value = data.size || 24;
                    if (textColor) textColor.value = data.color || '#000000';
                    if (bgColor) bgColor.value = data.bg || '#ffffff';
                }
                
                // Always render properties panel with the data
                this.renderPropertiesPanel(data);
            },

            deselectAll() {
                document.querySelectorAll('.element').forEach(el => el.classList.remove('selected'));
                this.sel = null;
                this.renderPropertiesPanel(null);
            },

            renderPropertiesPanel(data) {
                try {
                    const panel = document.getElementById('propertiesPanel');
                    const content = document.getElementById('propertiesContent');
                    const actions = document.getElementById('propertiesActions');
                    
                    if (!panel || !content) {
                        console.error('Properties panel elements not found');
                        return;
                    }

                    if (!data || !this.sel) {
                        // Hide panel when no selection
                        panel.classList.remove('visible');
                        panel.classList.remove('category-panel-open');
                        if (actions) actions.style.display = 'none';
                        content.innerHTML = `
                            <div class="properties-empty">
                                <div class="properties-empty-title">No Selection</div>
                                <div class="properties-empty-text">Select an element on the canvas to edit its properties</div>
                            </div>
                        `;
                        return;
                    }

                    // Show panel when element is selected
                    panel.classList.add('visible');
                    if (actions) actions.style.display = 'flex';
                    
                    // Check if category panel is open and add padding
                    const categoryPanel = document.getElementById('categoryPanel');
                    if (categoryPanel && categoryPanel.classList.contains('show')) {
                        panel.classList.add('category-panel-open');
                    } else {
                        panel.classList.remove('category-panel-open');
                    }

                    let html = '';

                    // Validate data type
                    if (!data.type) {
                        console.error('Element data missing type:', data);
                        content.innerHTML = `
                            <div class="properties-empty">
                                <div class="properties-empty-title">Error</div>
                                <div class="properties-empty-text">Invalid element data</div>
                            </div>
                        `;
                        return;
                    }

                if (data.type === 'shape') {
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Fill Color</label>
                            <input type="color" class="properties-color-input" id="propFillColor" value="${data.bg || '#10b981'}" onchange="app.updateShapeProperty('bg', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Border Color</label>
                            <input type="color" class="properties-color-input" id="propBorderColor" value="${data.border || '#047857'}" onchange="app.updateShapeProperty('border', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Border Width</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" class="properties-input" id="propBorderWidth" min="0" max="20" value="${data.thick || 2}" onchange="app.updateShapeProperty('thick', parseInt(this.value))" style="flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="app.adjustProperty('propBorderWidth', 1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    <button type="button" onclick="app.adjustProperty('propBorderWidth', -1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'text') {
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Text Color</label>
                            <input type="color" class="properties-color-input" id="propTextColor" value="${data.color || '#000000'}" onchange="app.updateTextProperty('color', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Background Color</label>
                            <input type="color" class="properties-color-input" id="propTextBg" value="${data.bg || 'transparent'}" onchange="app.updateTextProperty('bg', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Border Color</label>
                            <input type="color" class="properties-color-input" id="propTextBorderColor" value="${data.borderColor || '#000000'}" onchange="app.updateTextProperty('borderColor', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Border Width</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" class="properties-input" id="propTextBorderWidth" min="0" max="20" value="${data.borderWidth || 0}" onchange="app.updateTextProperty('borderWidth', parseInt(this.value))" style="flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="app.adjustProperty('propTextBorderWidth', 1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    <button type="button" onclick="app.adjustProperty('propTextBorderWidth', -1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Font Size</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" class="properties-input" id="propFontSize" min="8" max="200" value="${data.size || 24}" onchange="app.updateTextProperty('size', parseInt(this.value))" style="flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="app.adjustProperty('propFontSize', 1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    <button type="button" onclick="app.adjustProperty('propFontSize', -1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'image') {
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Border Color</label>
                            <input type="color" class="properties-color-input" id="propImgBorderColor" value="${data.borderColor || '#000000'}" onchange="app.updateImageProperty('borderColor', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Border Width</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" class="properties-input" id="propImgBorderWidth" min="0" max="20" value="${data.borderWidth || 0}" onchange="app.updateImageProperty('borderWidth', parseInt(this.value))" style="flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="app.adjustProperty('propImgBorderWidth', 1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    <button type="button" onclick="app.adjustProperty('propImgBorderWidth', -1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Transparency</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="imgTransparencySlider" min="0" max="100" value="${data.transparency || 0}" oninput="app.updateImageTransparency(this.value)" style="flex: 1; height: 6px; border-radius: 3px; background: #e5e7eb; outline: none; cursor: pointer; -webkit-appearance: none;">
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="imgTransparencyInput" min="0" max="100" value="${data.transparency || 0}" onchange="app.updateImageTransparency(this.value)" oninput="app.updateImageTransparency(this.value)" style="width: 60px; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; text-align: center; outline: none;">
                                    <span style="font-size: 12px; color: #6b7280;">%</span>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <button type="button" onclick="app.adjustImageTransparency(1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                        <button type="button" onclick="app.adjustImageTransparency(-1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Shape</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.applyImageShape('none')" title="Rectangle" style="${data.shape === 'none' || !data.shape ? 'background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);' : ''}"></button>
                                <button class="properties-arrange-btn" onclick="app.applyImageShape('circle')" title="Circle" style="${data.shape === 'circle' ? 'background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);' : ''}"></button>
                                <button class="properties-arrange-btn" onclick="app.applyImageShape('rounded')" title="Rounded" style="${data.shape === 'rounded' ? 'background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);' : ''}"></button>
                                <button class="properties-arrange-btn" onclick="app.applyImageShape('triangle')" title="Triangle" style="${data.shape === 'triangle' ? 'background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);' : ''}"></button>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Adjust Image</label>
                            <button class="properties-arrange-btn" onclick="app.showAdjustImageModal()" style="width: 100%;">Adjust Image</button>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'chart') {
                    // Convert old data format to new format if needed
                    if (data.data && data.data.datasets && !data.labels) {
                        const oldData = data.data;
                        data.labels = oldData.labels || [];
                        if (oldData.datasets && oldData.datasets[0]) {
                            data.values = oldData.datasets[0].data || [];
                            if (data.chartType === 'line') {
                                data.colors = [oldData.datasets[0].borderColor || '#10b981'];
                            } else {
                                data.colors = oldData.datasets[0].backgroundColor || [];
                            }
                        }
                        delete data.data;
                        this.saveState();
                    }
                    
                    // Ensure data exists, if not use defaults
                    if (!data.labels || data.labels.length === 0) {
                        const defaultData = this.getDefaultChartData(data.chartType || 'bar');
                        data.labels = defaultData.labels || [];
                        data.values = defaultData.values || [];
                        data.colors = defaultData.colors || [];
                        this.saveState();
                    }
                    
                    const labels = data.labels || [];
                    const values = data.values || [];
                    const colors = data.colors || [];
                    const maxLength = Math.max(labels.length, values.length, colors.length, 1);
                    
                    let chartItemsHtml = '';
                    for (let i = 0; i < maxLength; i++) {
                        const labelValue = labels[i] !== undefined ? labels[i] : '';
                        const valueValue = values[i] !== undefined ? values[i] : 0;
                        const colorValue = colors[i] !== undefined ? colors[i] : '#10b981';
                        
                        chartItemsHtml += `
                            <div style="display: grid; grid-template-columns: 1fr 80px 50px 30px; gap: 6px; align-items: center; padding: 6px; background: ${i % 2 === 0 ? '#f9fafb' : 'white'}; border-radius: 4px; margin-bottom: 4px;">
                                <input type="text" class="properties-input" value="${labelValue}" placeholder="Label" onchange="app.updateChartData('${data.id}', 'label', ${i}, this.value)" style="font-size: 11px; padding: 4px 6px;">
                                <input type="number" class="properties-input" value="${valueValue}" placeholder="Value" onchange="app.updateChartData('${data.id}', 'value', ${i}, this.value)" style="font-size: 11px; padding: 4px 6px;">
                                <input type="color" class="properties-color-input" value="${colorValue}" onchange="app.updateChartData('${data.id}', 'color', ${i}, this.value)" style="width: 100%; height: 28px; border: 1px solid #d1d5db; border-radius: 4px; cursor: pointer;">
                                <button onclick="app.removeChartItem('${data.id}', ${i})" style="width: 24px; height: 24px; border: 1px solid #ef4444; background: white; color: #ef4444; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; padding: 0;"></button>
                            </div>
                        `;
                    }
                    
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Chart Type</label>
                            <select class="properties-input" onchange="app.updateChartType('${data.id}', this.value)">
                                <option value="bar" ${data.chartType === 'bar' ? 'selected' : ''}>Bar Chart</option>
                                <option value="line" ${data.chartType === 'line' ? 'selected' : ''}>Line Chart</option>
                                <option value="pie" ${data.chartType === 'pie' ? 'selected' : ''}>Pie Chart</option>
                            </select>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label" style="display: flex; align-items: center; justify-content: space-between;">
                                <span>Show Values</span>
                                <label style="position: relative; display: inline-block; width: 44px; height: 24px; margin: 0;">
                                    <input type="checkbox" ${data.showValues !== false ? 'checked' : ''} onchange="app.updateChartProperty('${data.id}', 'showValues', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                    <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${data.showValues !== false ? '#10b981' : '#ccc'}; border-radius: 24px; transition: 0.3s;">
                                        <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; transform: ${data.showValues !== false ? 'translateX(20px)' : 'translateX(0)'};"></span>
                                    </span>
                                </label>
                            </label>
                        </div>
                        <div class="properties-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label class="properties-label" style="margin: 0;">Chart Data</label>
                                <button onclick="app.addChartItem('${data.id}')" style="padding: 4px 12px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600;">+ Add</button>
                            </div>
                            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; background: white;">
                                ${maxLength > 0 ? chartItemsHtml : '<div style="text-align: center; color: #9ca3af; padding: 20px; font-size: 12px;">No data. Click "+ Add" to add items.</div>'}
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'table') {
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Table Size</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <input type="number" class="properties-input" min="1" max="10" value="${data.rows || 3}" onchange="app.updateTableSize('${data.id}', 'rows', parseInt(this.value))" placeholder="Rows">
                                <input type="number" class="properties-input" min="1" max="10" value="${data.cols || 3}" onchange="app.updateTableSize('${data.id}', 'cols', parseInt(this.value))" placeholder="Cols">
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                } else if (data.type === 'symbol') {
                    html = `
                        <div class="properties-group">
                            <label class="properties-label">Symbol</label>
                            <div style="font-size: 48px; text-align: center; padding: 20px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                ${data.symbol || ''}
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Color</label>
                            <input type="color" class="properties-color-input" value="${data.color || '#000000'}" onchange="app.updateSymbolProperty('${data.id}', 'color', this.value)">
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Size</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="number" class="properties-input" min="12" max="200" value="${data.fontSize || 48}" onchange="app.updateSymbolProperty('${data.id}', 'fontSize', parseInt(this.value))" style="flex: 1;">
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    <button type="button" onclick="app.adjustProperty('propSymbolSize', 1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-radius: 4px 4px 0 0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                    <button type="button" onclick="app.adjustProperty('propSymbolSize', -1)" style="width: 20px; height: 14px; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 4px 4px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; font-size: 8px; color: #374151;"></button>
                                </div>
                            </div>
                        </div>
                        <div class="properties-group">
                            <label class="properties-label">Arrange</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('left')" title="Align Left"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('center')" title="Align Center"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('right')" title="Align Right"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('top')" title="Align Top"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('middle')" title="Align Middle"></button>
                                <button class="properties-arrange-btn" onclick="app.arrangeElement('bottom')" title="Align Bottom"></button>
                            </div>
                        </div>
                    `;
                }

                content.innerHTML = html;
                } catch (error) {
                    console.error('Error rendering properties panel:', error);
                    // Fallback: show empty state
                    if (panel) {
                        panel.classList.remove('visible');
                        panel.classList.remove('category-panel-open');
                    }
                    if (content) {
                        content.innerHTML = `
                            <div class="properties-empty">
                                <div class="properties-empty-title">Error</div>
                                <div class="properties-empty-text">Failed to load properties</div>
                            </div>
                        `;
                    }
                }
            },

            updateShapeProperty(prop, value) {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'shape') return;

                data[prop] = value;
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateTextProperty(prop, value) {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'text') return;

                // Preserve content when updating properties
                if (prop === 'size' || prop === 'width' || prop === 'height') {
                    const currentContent = this.sel.innerText || this.sel.textContent || data.content || '';
                    data.content = currentContent;
                }

                data[prop] = value;
                
                // Apply border changes immediately
                if (prop === 'borderColor' || prop === 'borderWidth') {
                    if (data.borderWidth && data.borderWidth > 0) {
                        this.sel.style.border = `${data.borderWidth}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        this.sel.style.border = 'none';
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            adjustProperty(inputId, delta) {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                const min = parseInt(input.min) || 0;
                const max = parseInt(input.max) || 200;
                let currentValue = parseInt(input.value) || 0;
                currentValue = Math.max(min, Math.min(max, currentValue + delta));
                input.value = currentValue;
                
                // Trigger change event
                input.dispatchEvent(new Event('change'));
            },

            arrangeElement(position) {
                if (!this.sel) return;
                
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data) return;
                
                const slideWidth = 960;
                const slideHeight = 540;
                const elementWidth = parseInt(this.sel.style.width) || data.width || 200;
                const elementHeight = parseInt(this.sel.style.height) || data.height || 100;
                
                let newX = data.x;
                let newY = data.y;
                
                switch(position) {
                    case 'left':
                        newX = 0;
                        break;
                    case 'center':
                        newX = (slideWidth - elementWidth) / 2;
                        break;
                    case 'right':
                        newX = slideWidth - elementWidth;
                        break;
                    case 'top':
                        newY = 0;
                        break;
                    case 'middle':
                        newY = (slideHeight - elementHeight) / 2;
                        break;
                    case 'bottom':
                        newY = slideHeight - elementHeight;
                        break;
                }
                
                // Update position
                data.x = Math.max(0, Math.min(slideWidth - elementWidth, newX));
                data.y = Math.max(0, Math.min(slideHeight - elementHeight, newY));
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            showContextMenu(x, y) {
                const contextMenu = document.getElementById('contextMenu');
                if (!contextMenu) return;
                
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';
                contextMenu.classList.add('show');
                
                // Hide menu when clicking elsewhere
                const hideMenu = (e) => {
                    if (!contextMenu.contains(e.target)) {
                        contextMenu.classList.remove('show');
                        document.removeEventListener('click', hideMenu);
                        document.removeEventListener('contextmenu', hideMenu);
                    }
                };
                
                // Use setTimeout to avoid immediate hide
                setTimeout(() => {
                    document.addEventListener('click', hideMenu);
                    document.addEventListener('contextmenu', hideMenu);
                }, 10);
            },

            hideContextMenu() {
                const contextMenu = document.getElementById('contextMenu');
                if (contextMenu) {
                    contextMenu.classList.remove('show');
                }
            },

            updateImageProperty(prop, value) {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') return;

                data[prop] = value;
                
                // Apply border changes immediately
                if (prop === 'borderColor' || prop === 'borderWidth') {
                    if (data.borderWidth && data.borderWidth > 0) {
                        this.sel.style.border = `${data.borderWidth}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        this.sel.style.border = 'none';
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateImageTransparency(value) {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') return;
                
                const transparency = parseInt(value) || 0;
                data.transparency = transparency;
                
                // Update slider and input
                const slider = document.getElementById('imgTransparencySlider');
                const input = document.getElementById('imgTransparencyInput');
                if (slider) slider.value = transparency;
                if (input) input.value = transparency;
                
                // Apply transparency to image
                const opacity = (100 - transparency) / 100;
                if (this.sel) {
                    const img = this.sel.querySelector('img');
                    if (img) img.style.opacity = opacity;
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            },

            adjustImageTransparency(delta) {
                const input = document.getElementById('imgTransparencyInput');
                if (!input) return;
                
                let currentValue = parseInt(input.value) || 0;
                currentValue = Math.max(0, Math.min(100, currentValue + delta));
                
                this.updateImageTransparency(currentValue);
            },

            applyImageShape(shape) {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') return;
                
                data.shape = shape;
                
                // Apply shape styling
                if (this.sel) {
                    const img = this.sel.querySelector('img');
                    if (img) {
                        switch(shape) {
                            case 'circle':
                                img.style.borderRadius = '50%';
                                img.style.clipPath = 'none';
                                break;
                            case 'rounded':
                                img.style.borderRadius = '20px';
                                img.style.clipPath = 'none';
                                break;
                            case 'triangle':
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                                break;
                            case 'none':
                            default:
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'none';
                                break;
                        }
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${data.id}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            cropImage() {
                if (!this.sel) {
                    this.showNotification('Select an image first', 'warning');
                    return;
                }
                
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') {
                    this.showNotification('Selected element is not an image', 'warning');
                    return;
                }
                
                // Show crop modal
                const modal = document.getElementById('cropModal');
                if (modal) {
                    modal.classList.add('show');
                    // Load image into crop area
                    const cropImg = document.getElementById('cropImagePreview');
                    if (cropImg) {
                        cropImg.src = data.src;
                    }
                } else {
                    this.showNotification('Crop feature coming soon! Use image editing software to crop images before uploading.', 'info');
                }
            },

            applyCrop() {
                // For now, just close the modal
                // Full crop functionality would require canvas-based cropping
                this.closeModal('cropModal');
                this.showNotification('Crop feature coming soon! Use image editing software to crop images before uploading.', 'info');
            },

            showAdjustImageModal() {
                if (!this.sel) {
                    this.showNotification('Select an image first', 'warning');
                    return;
                }
                
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') {
                    this.showNotification('Selected element is not an image', 'warning');
                    return;
                }
                
                const modal = document.getElementById('adjustImageModal');
                if (modal) {
                    modal.classList.add('show');
                    // Load image into preview
                    const previewImg = document.getElementById('adjustImagePreview');
                    if (previewImg) {
                        previewImg.src = data.src;
                    }
                    
                    // Reset all sliders to current values or 0
                    const filters = data.filters || {};
                    document.getElementById('sharpenSlider').value = filters.sharpen || 0;
                    document.getElementById('sharpenInput').value = filters.sharpen || 0;
                    document.getElementById('brightnessSlider').value = filters.brightness || 0;
                    document.getElementById('brightnessInput').value = filters.brightness || 0;
                    document.getElementById('contrastSlider').value = filters.contrast || 0;
                    document.getElementById('contrastInput').value = filters.contrast || 0;
                    document.getElementById('saturationSlider').value = filters.saturation || 0;
                    document.getElementById('saturationInput').value = filters.saturation || 0;
                    document.getElementById('toneSlider').value = filters.tone || 0;
                    document.getElementById('toneInput').value = filters.tone || 0;
                    document.getElementById('recolorSelect').value = filters.recolor || 'none';
                    
                    // Apply current filters to preview
                    this.tempFilters = { ...filters };
                    this.updateImagePreviewFilters();
                }
            },

            updateImageFilter(type, value) {
                // Update input field
                const input = document.getElementById(type + 'Input');
                if (input) input.value = value;
                
                // Update slider
                const slider = document.getElementById(type + 'Slider');
                if (slider) slider.value = value;
                
                // Store filter value temporarily
                if (!this.tempFilters) this.tempFilters = {};
                this.tempFilters[type] = parseInt(value);
                
                // Apply to preview
                this.updateImagePreviewFilters();
            },

            updateImagePreviewFilters() {
                const previewImg = document.getElementById('adjustImagePreview');
                if (!previewImg) return;
                
                const filters = this.tempFilters || {};
                let filterString = '';
                
                // Brightness
                if (filters.brightness) {
                    filterString += `brightness(${100 + filters.brightness}%) `;
                }
                
                // Contrast
                if (filters.contrast) {
                    filterString += `contrast(${100 + filters.contrast}%) `;
                }
                
                // Saturation
                if (filters.saturation) {
                    filterString += `saturate(${100 + filters.saturation}%) `;
                }
                
                // Sharpen/Blur (using blur inversely)
                if (filters.sharpen) {
                    const blurValue = Math.abs(filters.sharpen) / 10;
                    if (filters.sharpen < 0) {
                        filterString += `blur(${blurValue}px) `;
                    }
                }
                
                // Recolor
                if (filters.recolor) {
                    switch(filters.recolor) {
                        case 'sepia':
                            filterString += 'sepia(100%) ';
                            break;
                        case 'grayscale':
                            filterString += 'grayscale(100%) ';
                            break;
                        case 'invert':
                            filterString += 'invert(100%) ';
                            break;
                        case 'warm':
                            filterString += 'sepia(50%) saturate(150%) ';
                            break;
                        case 'cool':
                            filterString += 'sepia(20%) saturate(80%) hue-rotate(180deg) ';
                            break;
                    }
                }
                
                previewImg.style.filter = filterString.trim() || 'none';
            },

            applyArtisticEffect(effect) {
                if (!this.tempFilters) this.tempFilters = {};
                
                // Reset other filters when applying artistic effect
                if (effect !== 'none') {
                    this.tempFilters.artistic = effect;
                    // Apply effect-specific filters
                    switch(effect) {
                        case 'blur':
                            this.tempFilters.sharpen = -30;
                            break;
                        case 'fog':
                            this.tempFilters.sharpen = -20;
                            this.tempFilters.brightness = 10;
                            this.tempFilters.contrast = -10;
                            break;
                        case 'paper':
                            this.tempFilters.contrast = -20;
                            this.tempFilters.saturation = -30;
                            break;
                        case 'vintage':
                            this.tempFilters.recolor = 'sepia';
                            this.tempFilters.contrast = 10;
                            break;
                        case 'pencil':
                            this.tempFilters.recolor = 'grayscale';
                            this.tempFilters.contrast = 30;
                            break;
                        case 'watercolor':
                            this.tempFilters.saturation = 20;
                            this.tempFilters.contrast = -15;
                            break;
                        case 'oil':
                            this.tempFilters.saturation = 30;
                            this.tempFilters.contrast = 20;
                            break;
                    }
                } else {
                    delete this.tempFilters.artistic;
                }
                
                // Update all inputs
                if (this.tempFilters.sharpen !== undefined) {
                    document.getElementById('sharpenSlider').value = this.tempFilters.sharpen;
                    document.getElementById('sharpenInput').value = this.tempFilters.sharpen;
                }
                if (this.tempFilters.brightness !== undefined) {
                    document.getElementById('brightnessSlider').value = this.tempFilters.brightness;
                    document.getElementById('brightnessInput').value = this.tempFilters.brightness;
                }
                if (this.tempFilters.contrast !== undefined) {
                    document.getElementById('contrastSlider').value = this.tempFilters.contrast;
                    document.getElementById('contrastInput').value = this.tempFilters.contrast;
                }
                if (this.tempFilters.saturation !== undefined) {
                    document.getElementById('saturationSlider').value = this.tempFilters.saturation;
                    document.getElementById('saturationInput').value = this.tempFilters.saturation;
                }
                if (this.tempFilters.recolor) {
                    document.getElementById('recolorSelect').value = this.tempFilters.recolor;
                }
                
                this.updateImagePreviewFilters();
            },

            applyImageFilters() {
                if (!this.sel) return;
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') return;
                
                // Save filters to data
                data.filters = { ...this.tempFilters };
                
                // Apply filters to actual image
                const img = this.sel.querySelector('img');
                if (img) {
                    this.applyFiltersToImage(img, data.filters);
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                this.closeModal('adjustImageModal');
                this.tempFilters = null;
            },

            applyFiltersToImage(img, filters) {
                if (!filters) return;
                
                let filterString = '';
                
                if (filters.brightness) {
                    filterString += `brightness(${100 + filters.brightness}%) `;
                }
                if (filters.contrast) {
                    filterString += `contrast(${100 + filters.contrast}%) `;
                }
                if (filters.saturation) {
                    filterString += `saturate(${100 + filters.saturation}%) `;
                }
                if (filters.sharpen) {
                    const blurValue = Math.abs(filters.sharpen) / 10;
                    if (filters.sharpen < 0) {
                        filterString += `blur(${blurValue}px) `;
                    }
                }
                if (filters.recolor) {
                    switch(filters.recolor) {
                        case 'sepia':
                            filterString += 'sepia(100%) ';
                            break;
                        case 'grayscale':
                            filterString += 'grayscale(100%) ';
                            break;
                        case 'invert':
                            filterString += 'invert(100%) ';
                            break;
                        case 'warm':
                            filterString += 'sepia(50%) saturate(150%) ';
                            break;
                        case 'cool':
                            filterString += 'sepia(20%) saturate(80%) hue-rotate(180deg) ';
                            break;
                    }
                }
                
                img.style.filter = filterString.trim() || 'none';
            },

            resetImageFilters() {
                // Reset all sliders
                document.getElementById('sharpenSlider').value = 0;
                document.getElementById('sharpenInput').value = 0;
                document.getElementById('brightnessSlider').value = 0;
                document.getElementById('brightnessInput').value = 0;
                document.getElementById('contrastSlider').value = 0;
                document.getElementById('contrastInput').value = 0;
                document.getElementById('saturationSlider').value = 0;
                document.getElementById('saturationInput').value = 0;
                document.getElementById('toneSlider').value = 0;
                document.getElementById('toneInput').value = 0;
                document.getElementById('recolorSelect').value = 'none';
                
                // Reset temp filters
                this.tempFilters = {};
                
                // Reset preview
                const previewImg = document.getElementById('adjustImagePreview');
                if (previewImg) {
                    previewImg.style.filter = 'none';
                }
            },

            addText() {
                const id = Date.now();
                const el = {
                    id: id,
                    type: 'text',
                    content: 'Double-click to edit',
                    x: 100,
                    y: 100,
                    width: 300,
                    height: 50,
                    font: 'Arial',
                    size: 24,
                    color: '#000000',
                    bg: 'transparent',
                    weight: 'normal',
                    align: 'left',
                    animation: 'none'
                };
                this.data[this.curr].els.push(el);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Auto-select the new element
                setTimeout(() => {
                    const elementEl = document.querySelector(`[data-id="${id}"]`);
                    if (elementEl) this.selectElement(elementEl);
                }, 100);
            },

            addShape(shape) {
                const id = Date.now();
                const el = {
                    id: id,
                    type: 'shape',
                    shape: shape,
                    x: 200,
                    y: 150,
                    width: 200,
                    height: 150,
                    bg: '#10b981',
                    border: '#047857',
                    thick: 2,
                    animation: 'none'
                };
                this.data[this.curr].els.push(el);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Auto-select the new element
                setTimeout(() => {
                    const elementEl = document.querySelector(`[data-id="${id}"]`);
                    if (elementEl) this.selectElement(elementEl);
                }, 100);
            },

            toggleShapesMenu() {
                // Deprecated - using category system now
            },

            addImage() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const id = Date.now();
                            const el = {
                                id: id,
                                type: 'image',
                                src: ev.target.result,
                                x: 150,
                                y: 100,
                                width: 300,
                                height: 200,
                                animation: 'none'
                            };
                            this.data[this.curr].els.push(el);
                            this.saveState();
                            this.loadCanvas();
                            this.renderSlides();
                            
                            // Auto-select the new element
                            setTimeout(() => {
                                const elementEl = document.querySelector(`[data-id="${id}"]`);
                                if (elementEl) this.selectElement(elementEl);
                            }, 100);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },

            createEl(data, slideIndex) {
                const div = document.createElement('div');
                div.className = 'element ' + data.type + '-element';
                div.dataset.id = data.id;
                div.dataset.slideIndex = slideIndex;
                div.style.left = data.x + 'px';
                div.style.top = data.y + 'px';
                div.style.width = data.width + 'px';
                div.style.height = data.height + 'px';
                
                // Mark locked elements
                if (data.locked) {
                    div.dataset.locked = 'true';
                    div.style.pointerEvents = 'none';
                    div.style.userSelect = 'none';
                }

                if (data.shadow) {
                    div.style.boxShadow = data.shadow;
                }

                if (data.type === 'text') {
                    div.contentEditable = true;
                    div.innerText = data.content || '';
                    let fontFamily = data.font || 'Arial';
                    if (fontFamily === 'Kraft Mono') {
                        fontFamily = "'Kraft Mono', 'JetBrains Mono', monospace";
                    } else if (fontFamily === 'ID Grotesk') {
                        fontFamily = "'ID Grotesk', 'Work Sans', sans-serif";
                    }
                    div.style.fontFamily = fontFamily;
                    div.style.fontSize = (data.size || 24) + 'px';
                    div.style.color = data.color || '#000000';
                    div.style.backgroundColor = data.bg || 'transparent';
                    div.style.fontWeight = data.weight || 'normal';
                    div.style.textAlign = data.align || 'left';
                    div.style.padding = '8px';
                    div.style.whiteSpace = 'pre-wrap';
                    div.style.wordWrap = 'break-word';
                    div.style.overflowWrap = 'break-word';
                    
                    // Apply border if exists
                    if (data.borderWidth && data.borderWidth > 0) {
                        div.style.border = `${data.borderWidth}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        div.style.border = 'none';
                    }
                    
                    div.addEventListener('blur', () => {
                        const el = this.data[slideIndex].els.find(e => e.id == data.id);
                        if (el) {
                            el.content = div.innerText;
                            this.saveState();
                            this.renderSlides();
                        }
                    });

                    div.addEventListener('focus', () => {
                        // Switch to this slide when editing
                        if (this.curr !== slideIndex) {
                            this.switchSlide(slideIndex);
                        }
                    });
                }

                if (data.type === 'shape') {
                    const fillColor = data.bg || '#10b981';
                    const borderColor = data.border || '#047857';
                    const borderWidth = data.thick || 2;
                    
                    // Use SVG for complex shapes that need proper borders
                    const needsSVG = ['triangle', 'star', 'hexagon', 'diamond', 'arrow-right', 'arrow-left', 'pentagon'].includes(data.shape);
                    
                    if (needsSVG) {
                            div.style.backgroundColor = 'transparent';
                            div.style.border = 'none';
                        div.style.overflow = 'visible';
                        
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('width', '100%');
                        svg.setAttribute('height', '100%');
                        svg.setAttribute('viewBox', '0 0 100 100');
                        svg.style.position = 'absolute';
                        svg.style.top = '0';
                        svg.style.left = '0';
                        svg.style.pointerEvents = 'none';
                        
                        const shape = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        let pathData = '';
                        
                        switch(data.shape) {
                            case 'triangle':
                                pathData = 'M 50,10 L 90,90 L 10,90 Z';
                            break;
                        case 'star':
                                pathData = 'M 50,5 L 61,35 L 98,35 L 68,57 L 79,91 L 50,70 L 21,91 L 32,57 L 2,35 L 39,35 Z';
                            break;
                        case 'hexagon':
                                pathData = 'M 50,5 L 85,25 L 85,75 L 50,95 L 15,75 L 15,25 Z';
                            break;
                        case 'diamond':
                                pathData = 'M 50,5 L 95,50 L 50,95 L 5,50 Z';
                            break;
                        case 'arrow-right':
                                pathData = 'M 5,25 L 60,25 L 60,5 L 95,50 L 60,95 L 60,75 L 5,75 Z';
                            break;
                        case 'arrow-left':
                                pathData = 'M 95,25 L 40,25 L 40,5 L 5,50 L 40,95 L 40,75 L 95,75 Z';
                                break;
                            case 'pentagon':
                                pathData = 'M 50,5 L 95,38 L 82,95 L 18,95 L 5,38 Z';
                                break;
                        }
                        
                        shape.setAttribute('d', pathData);
                        shape.setAttribute('fill', fillColor);
                        shape.setAttribute('stroke', borderColor);
                        // Calculate stroke width relative to viewBox (100x100)
                        // borderWidth is in pixels, convert to viewBox units
                        const avgSize = (data.width + data.height) / 2;
                        const strokeWidthInViewBox = (borderWidth / avgSize) * 100;
                        shape.setAttribute('stroke-width', Math.max(0.5, strokeWidthInViewBox).toString());
                        shape.setAttribute('stroke-linejoin', 'round');
                        shape.setAttribute('stroke-linecap', 'round');
                        
                        svg.appendChild(shape);
                        div.appendChild(svg);
                    } else {
                        // Simple shapes with CSS
                        div.style.backgroundColor = fillColor;
                        div.style.border = `${borderWidth}px solid ${borderColor}`;
                        
                        switch(data.shape) {
                            case 'circle':
                                div.style.borderRadius = '50%';
                                break;
                            case 'rectangle':
                                div.style.borderRadius = '4px';
                            break;
                        default:
                            div.style.borderRadius = '4px';
                        }
                    }
                }

                if (data.type === 'image') {
                    const img = document.createElement('img');
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.display = 'block';
                    img.style.backgroundColor = '#f3f4f6';
                    img.style.minHeight = '50px';
                    img.style.border = '1px solid #e5e7eb';
                    img.style.borderRadius = '4px';
                    
                    // Log for debugging
                    console.log('Creating image element with src:', data.src, 'width:', data.width, 'height:', data.height);
                    
                    // Handle image loading
                    img.onload = function() {
                        console.log('Image loaded successfully:', this.src);
                    };
                    
                    img.onerror = function() {
                        console.error('Image failed to load:', this.src);
                        // Use a simple fallback that definitely works
                        const fallbackUrl = `https://via.placeholder.com/${data.width || 300}x${data.height || 200}/667eea/ffffff?text=Image`;
                        console.log('Trying fallback:', fallbackUrl);
                        this.src = fallbackUrl;
                    };
                    
                    // Set src - ensure we have a valid URL
                    if (data.src && data.src.trim() !== '') {
                        // Ensure URL is complete
                        let imageUrl = data.src;
                        if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                            // If not a full URL, create placeholder
                            imageUrl = `https://via.placeholder.com/${data.width || 300}x${data.height || 200}/667eea/ffffff?text=Image`;
                        }
                        img.src = imageUrl;
                        console.log('Setting image src to:', imageUrl);
                    } else {
                        // If no src, use placeholder immediately
                        const placeholderUrl = `https://via.placeholder.com/${data.width || 300}x${data.height || 200}/667eea/ffffff?text=Image`;
                        img.src = placeholderUrl;
                        console.log('No src provided, using placeholder:', placeholderUrl);
                    }
                    
                    // Apply transparency
                    if (data.transparency !== undefined) {
                        const opacity = (100 - data.transparency) / 100;
                        img.style.opacity = opacity;
                    }
                    
                    // Apply filters
                    if (data.filters) {
                        this.applyFiltersToImage(img, data.filters);
                    }
                    
                    // Apply shape
                    if (data.shape) {
                        switch(data.shape) {
                            case 'circle':
                                img.style.borderRadius = '50%';
                                img.style.clipPath = 'none';
                                break;
                            case 'rounded':
                                img.style.borderRadius = '20px';
                                img.style.clipPath = 'none';
                                break;
                            case 'triangle':
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                                break;
                            case 'none':
                            default:
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'none';
                                break;
                        }
                    }
                    
                    // Apply border
                    if (data.borderWidth && data.borderWidth > 0) {
                        div.style.border = `${data.borderWidth}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        div.style.border = 'none';
                    }
                    
                    div.appendChild(img);
                }

                if (data.type === 'chart') {
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.backgroundColor = '#ffffff';
                    div.style.border = '2px solid #e5e7eb';
                    div.style.borderRadius = '8px';
                    div.style.padding = '0';
                    div.style.overflow = 'visible';
                    
                    const chartCanvas = document.createElement('canvas');
                    const canvasWidth = Math.max(200, data.width || 400);
                    const canvasHeight = Math.max(200, data.height || 300);
                    chartCanvas.width = canvasWidth;
                    chartCanvas.height = canvasHeight;
                    chartCanvas.style.width = canvasWidth + 'px';
                    chartCanvas.style.height = canvasHeight + 'px';
                    chartCanvas.style.display = 'block';
                    chartCanvas.style.maxWidth = '100%';
                    chartCanvas.style.maxHeight = '100%';
                    
                    // Draw chart after a small delay to ensure canvas is ready
                    setTimeout(() => {
                        const ctx = chartCanvas.getContext('2d');
                        if (ctx) {
                            // Ensure data exists
                            if (!data.labels || data.labels.length === 0) {
                                const defaultData = this.getDefaultChartData(data.chartType || 'bar');
                                data.labels = defaultData.labels || [];
                                data.values = defaultData.values || [];
                                data.colors = defaultData.colors || [];
                            }
                            this.drawChart(ctx, data.chartType || 'bar', data, canvasWidth, canvasHeight);
                        }
                    }, 10);
                    
                    div.appendChild(chartCanvas);
                }

                if (data.type === 'table') {
                    div.style.backgroundColor = 'white';
                    div.style.border = '1px solid #e5e7eb';
                    div.style.borderRadius = '4px';
                    div.style.overflow = 'hidden';
                    
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.height = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.fontSize = '12px';
                    
                    for (let r = 0; r < data.rows; r++) {
                        const tr = document.createElement('tr');
                        for (let c = 0; c < data.cols; c++) {
                            const td = document.createElement(r === 0 ? 'th' : 'td');
                            td.textContent = data.data[r] ? data.data[r][c] : '';
                            td.style.border = '1px solid #e5e7eb';
                            td.style.padding = '8px';
                            td.style.textAlign = 'left';
                            if (r === 0) {
                                td.style.backgroundColor = '#f3f4f6';
                                td.style.fontWeight = '600';
                            }
                            tr.appendChild(td);
                        }
                        table.appendChild(tr);
                    }
                    div.appendChild(table);
                }

                if (data.type === 'symbol') {
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.fontSize = (data.fontSize || 48) + 'px';
                    div.style.color = data.color || '#000000';
                    div.style.backgroundColor = 'transparent';
                    div.textContent = data.symbol || '';
                    div.style.userSelect = 'none';
                }

                // Only show resize handles on active slide
                if (slideIndex === this.curr) {
                    ['nw', 'ne', 'sw', 'se'].forEach(pos => {
                        const handle = document.createElement('div');
                        handle.className = 'resize-handle ' + pos;
                        div.appendChild(handle);
                    });
                }

                // Add context menu on right click
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    // Select element if not already selected
                    if (slideIndex === this.curr) {
                        this.selectElement(div);
                        this.showContextMenu(e.clientX, e.clientY);
                    }
                });

                return div;
            },

            loadCanvas() {
                const wrapper = document.getElementById('canvasWrapper');
                wrapper.innerHTML = '';
                
                this.data.forEach((slide, slideIndex) => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = 'canvas-slide' + (slideIndex === this.curr ? ' active' : '');
                    slideDiv.dataset.slideIndex = slideIndex;
                    
                    // Apply background with transparency
                    const bg = slide.bg || 'white';
                    const opacity = slide.bgOpacity !== undefined ? slide.bgOpacity : 1;
                    
                    if (bg.startsWith('url(')) {
                        slideDiv.style.backgroundImage = bg;
                        slideDiv.style.backgroundSize = 'cover';
                        slideDiv.style.backgroundPosition = 'center';
                        slideDiv.style.opacity = opacity;
                    } else if (bg.startsWith('linear-gradient')) {
                        slideDiv.style.background = bg;
                        slideDiv.style.opacity = opacity;
                    } else if (bg.startsWith('rgba')) {
                        slideDiv.style.background = bg;
                    } else {
                        // Convert hex to rgba with opacity
                        if (bg.startsWith('#')) {
                            const r = parseInt(bg.slice(1, 3), 16);
                            const g = parseInt(bg.slice(3, 5), 16);
                            const b = parseInt(bg.slice(5, 7), 16);
                            slideDiv.style.background = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                        } else {
                            slideDiv.style.background = bg;
                            slideDiv.style.opacity = opacity;
                        }
                    }

                    // Add Aramco Digital template (logo and gradient line) - always show
                    // Logo at top
                    const logoContainer = document.createElement('div');
                    logoContainer.style.cssText = 'display: flex; align-items: center; padding: 32px 40px 0; position: absolute; top: 0; left: 0; right: 0; z-index: 2; pointer-events: none;';
                    const logo = document.createElement('img');
                    logo.src = 'assets/aramco-digital-logo.png';
                    logo.alt = 'Aramco Digital';
                    logo.style.cssText = 'height: 48px; width: auto;';
                    logoContainer.appendChild(logo);
                    slideDiv.appendChild(logoContainer);

                    // Content area (only show dashed box if slide is empty)
                    const isNewSlide = !slide.els || slide.els.length === 0;
                    if (isNewSlide) {
                        const contentArea = document.createElement('div');
                        contentArea.style.cssText = 'flex: 1; padding: 24px 40px; position: absolute; top: 80px; left: 0; right: 0; bottom: 10px; z-index: 1; pointer-events: none;';
                        const contentBox = document.createElement('div');
                        contentBox.style.cssText = 'height: 100%; width: 100%; border-radius: 24px; border: 2px dashed rgba(16, 185, 129, 0.3); background: rgba(255, 255, 255, 0.8);';
                        contentArea.appendChild(contentBox);
                        slideDiv.appendChild(contentArea);
                    }

                    // Gradient line at bottom - always show
                    const gradientLine = document.createElement('div');
                    gradientLine.style.cssText = 'height: 10px; width: 100%; background: linear-gradient(to right, #10b981, #14b8a6, #38bdf8); position: absolute; bottom: 0; left: 0; right: 0; z-index: 2; pointer-events: none;';
                    slideDiv.appendChild(gradientLine);

                    // Add grid overlay for this slide
                    const gridOverlay = document.createElement('div');
                    gridOverlay.className = 'canvas-grid-overlay';
                    if (this.gridVisible) {
                        gridOverlay.classList.add('show');
                    }
                    slideDiv.appendChild(gridOverlay);

                    // Add elements to this slide
                    slide.els.forEach(el => {
                        const element = this.createEl(el, slideIndex);
                        slideDiv.appendChild(element);
                    });

                    // Click to select slide
                    slideDiv.addEventListener('click', (e) => {
                        if (e.target === slideDiv || e.target === gridOverlay) {
                            this.switchSlide(slideIndex);
                        }
                    });

                    wrapper.appendChild(slideDiv);
                });

                // Apply zoom to wrapper
                wrapper.style.transform = `scale(${this.zoom / 100})`;
            },

            renderSlides() {
                const container = document.getElementById('slides');
                container.innerHTML = '';
                
                this.data.forEach((slide, idx) => {
                    const div = document.createElement('div');
                    div.className = 'sidebar-slide' + (idx === this.curr ? ' active' : '');
                    
                    const preview = document.createElement('div');
                    preview.className = 'sidebar-slide-preview';
                    preview.style.background = slide.bg || 'white';
                    
                    if (slide.bg && slide.bg.startsWith('url(')) {
                        preview.style.backgroundImage = slide.bg;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                    }
                    
                    // Add slide number
                    const number = document.createElement('div');
                    number.className = 'sidebar-slide-number';
                    number.textContent = idx + 1;
                    preview.appendChild(number);
                    
                    // Add delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'sidebar-slide-delete';
                    deleteBtn.textContent = '';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.deleteSlide(idx);
                    };
                    preview.appendChild(deleteBtn);
                    
                    // Render elements in thumbnail (scaled down)
                    slide.els.forEach(el => {
                        const element = this.createThumbnailElement(el);
                        preview.appendChild(element);
                    });
                    
                    div.appendChild(preview);
                    div.onclick = () => this.switchSlide(idx);
                    container.appendChild(div);
                });
            },

            createThumbnailElement(data) {
                // Calculate scale factor dynamically: sidebar is 200px, padding is 20px total, so preview is ~180px wide
                // Main slide is 960px wide
                const sidebarWidth = 200;
                const sidebarPadding = 20; // 10px on each side
                const previewWidth = sidebarWidth - sidebarPadding;
                const slideWidth = 960;
                const scale = previewWidth / slideWidth;
                
                const div = document.createElement('div');
                div.style.position = 'absolute';
                div.style.left = (data.x * scale) + 'px';
                div.style.top = (data.y * scale) + 'px';
                div.style.width = (data.width * scale) + 'px';
                div.style.height = (data.height * scale) + 'px';
                div.style.pointerEvents = 'none';
                
                if (data.type === 'text') {
                    let fontFamily = data.font || 'Arial';
                    if (fontFamily === 'Kraft Mono') {
                        fontFamily = "'Kraft Mono', 'JetBrains Mono', monospace";
                    } else if (fontFamily === 'ID Grotesk') {
                        fontFamily = "'ID Grotesk', 'Work Sans', sans-serif";
                    }
                    div.style.fontFamily = fontFamily;
                    div.style.fontSize = ((data.size || 24) * scale) + 'px';
                    div.style.color = data.color || '#000000';
                    div.style.backgroundColor = data.bg || 'transparent';
                    div.style.fontWeight = data.weight || 'normal';
                    div.style.textAlign = data.align || 'left';
                    div.style.padding = (8 * scale) + 'px';
                    div.style.overflow = 'hidden';
                    div.style.textOverflow = 'ellipsis';
                    div.style.whiteSpace = 'nowrap';
                    div.textContent = data.content || '';
                    
                    // Apply border if exists
                    if (data.borderWidth && data.borderWidth > 0) {
                        div.style.border = `${(data.borderWidth * scale)}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        div.style.border = 'none';
                    }
                } else if (data.type === 'shape') {
                    const fillColor = data.bg || '#10b981';
                    const borderColor = data.border || '#047857';
                    const borderWidth = data.thick || 2;
                    
                    // Use SVG for complex shapes that need proper borders
                    const needsSVG = ['triangle', 'star', 'hexagon', 'diamond', 'arrow-right', 'arrow-left', 'pentagon'].includes(data.shape);
                    
                    if (needsSVG) {
                        div.style.backgroundColor = 'transparent';
                        div.style.border = 'none';
                        div.style.overflow = 'visible';
                        
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('width', '100%');
                        svg.setAttribute('height', '100%');
                        svg.setAttribute('viewBox', '0 0 100 100');
                        svg.style.position = 'absolute';
                        svg.style.top = '0';
                        svg.style.left = '0';
                        svg.style.pointerEvents = 'none';
                        
                        const shape = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        let pathData = '';
                        
                        switch(data.shape) {
                            case 'triangle':
                                pathData = 'M 50,10 L 90,90 L 10,90 Z';
                                break;
                            case 'star':
                                pathData = 'M 50,5 L 61,35 L 98,35 L 68,57 L 79,91 L 50,70 L 21,91 L 32,57 L 2,35 L 39,35 Z';
                                break;
                            case 'hexagon':
                                pathData = 'M 50,5 L 85,25 L 85,75 L 50,95 L 15,75 L 15,25 Z';
                                break;
                            case 'diamond':
                                pathData = 'M 50,5 L 95,50 L 50,95 L 5,50 Z';
                                break;
                            case 'arrow-right':
                                pathData = 'M 5,25 L 60,25 L 60,5 L 95,50 L 60,95 L 60,75 L 5,75 Z';
                                break;
                            case 'arrow-left':
                                pathData = 'M 95,25 L 40,25 L 40,5 L 5,50 L 40,95 L 40,75 L 95,75 Z';
                                break;
                            case 'pentagon':
                                pathData = 'M 50,5 L 95,38 L 82,95 L 18,95 L 5,38 Z';
                                break;
                        }
                        
                        shape.setAttribute('d', pathData);
                        shape.setAttribute('fill', fillColor);
                        shape.setAttribute('stroke', borderColor);
                        // Calculate stroke width relative to viewBox (100x100) for thumbnail
                        const avgSize = (data.width + data.height) / 2;
                        const strokeWidthInViewBox = ((borderWidth / avgSize) * 100) * scale;
                        shape.setAttribute('stroke-width', Math.max(0.3, strokeWidthInViewBox).toString());
                        shape.setAttribute('stroke-linejoin', 'round');
                        shape.setAttribute('stroke-linecap', 'round');
                        
                        svg.appendChild(shape);
                        div.appendChild(svg);
                    } else {
                        // Simple shapes with CSS
                        div.style.backgroundColor = fillColor;
                        div.style.border = `${(borderWidth * scale)}px solid ${borderColor}`;
                        
                        switch(data.shape) {
                            case 'circle':
                                div.style.borderRadius = '50%';
                                break;
                            case 'rectangle':
                                div.style.borderRadius = (4 * scale) + 'px';
                                break;
                            default:
                                div.style.borderRadius = (4 * scale) + 'px';
                        }
                    }
                } else if (data.type === 'image') {
                    const img = document.createElement('img');
                    img.src = data.src;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    // Apply transparency
                    if (data.transparency !== undefined) {
                        const opacity = (100 - data.transparency) / 100;
                        img.style.opacity = opacity;
                    }
                    
                    // Apply filters
                    if (data.filters) {
                        this.applyFiltersToImage(img, data.filters);
                    }
                    
                    // Apply shape
                    if (data.shape) {
                        switch(data.shape) {
                            case 'circle':
                                img.style.borderRadius = '50%';
                                img.style.clipPath = 'none';
                                break;
                            case 'rounded':
                                img.style.borderRadius = (20 * scale) + 'px';
                                img.style.clipPath = 'none';
                                break;
                            case 'triangle':
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                                break;
                            case 'none':
                            default:
                                img.style.borderRadius = '0';
                                img.style.clipPath = 'none';
                                break;
                        }
                    }
                    
                    // Apply border
                    if (data.borderWidth && data.borderWidth > 0) {
                        div.style.border = `${(data.borderWidth * scale)}px solid ${data.borderColor || '#000000'}`;
                    } else {
                        div.style.border = 'none';
                    }
                    
                    div.appendChild(img);
                } else if (data.type === 'chart') {
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.backgroundColor = '#ffffff';
                    div.style.border = `${(2 * scale)}px solid #e5e7eb`;
                    div.style.borderRadius = (8 * scale) + 'px';
                    div.style.padding = '0';
                    div.style.overflow = 'visible';
                    
                    const chartCanvas = document.createElement('canvas');
                    const canvasWidth = Math.max(100, (data.width || 400) * scale);
                    const canvasHeight = Math.max(100, (data.height || 300) * scale);
                    chartCanvas.width = canvasWidth;
                    chartCanvas.height = canvasHeight;
                    chartCanvas.style.width = canvasWidth + 'px';
                    chartCanvas.style.height = canvasHeight + 'px';
                    chartCanvas.style.display = 'block';
                    chartCanvas.style.maxWidth = '100%';
                    chartCanvas.style.maxHeight = '100%';
                    
                    // Draw chart after a small delay to ensure canvas is ready
                    setTimeout(() => {
                        const ctx = chartCanvas.getContext('2d');
                        if (ctx) {
                            // Ensure data exists
                            if (!data.labels || data.labels.length === 0) {
                                const defaultData = this.getDefaultChartData(data.chartType || 'bar');
                                data.labels = defaultData.labels || [];
                                data.values = defaultData.values || [];
                                data.colors = defaultData.colors || [];
                            }
                            this.drawChart(ctx, data.chartType || 'bar', data, canvasWidth, canvasHeight);
                        }
                    }, 10);
                    
                    div.appendChild(chartCanvas);
                } else if (data.type === 'table') {
                    div.style.backgroundColor = 'white';
                    div.style.border = `${(1 * scale)}px solid #e5e7eb`;
                    div.style.borderRadius = (4 * scale) + 'px';
                    div.style.overflow = 'hidden';
                    
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.height = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.fontSize = (12 * scale) + 'px';
                    
                    for (let r = 0; r < data.rows; r++) {
                        const tr = document.createElement('tr');
                        for (let c = 0; c < data.cols; c++) {
                            const td = document.createElement(r === 0 ? 'th' : 'td');
                            td.textContent = data.data[r] ? data.data[r][c] : '';
                            td.style.border = `${(1 * scale)}px solid #e5e7eb`;
                            td.style.padding = (8 * scale) + 'px';
                            td.style.textAlign = 'left';
                            if (r === 0) {
                                td.style.backgroundColor = '#f3f4f6';
                                td.style.fontWeight = '600';
                            }
                            tr.appendChild(td);
                        }
                        table.appendChild(tr);
                    }
                    div.appendChild(table);
                } else if (data.type === 'symbol') {
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.fontSize = ((data.fontSize || 48) * scale) + 'px';
                    div.style.color = data.color || '#000000';
                    div.style.backgroundColor = 'transparent';
                    div.textContent = data.symbol || '';
                    div.style.userSelect = 'none';
                }
                
                return div;
            },

            addSlide() {
                this.data.push({ els: [], bg: 'white', transition: 'fade' });
                this.curr = this.data.length - 1;
                this.saveState();
                this.renderSlides();
                this.loadCanvas();
                
                // Auto-scroll to the new slide
                setTimeout(() => {
                    const sidebar = document.getElementById('sidebar');
                    const slides = sidebar.querySelectorAll('.sidebar-slide');
                    const lastSlide = slides[slides.length - 1];
                    if (lastSlide) {
                        lastSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            },

            deleteSlide(idx) {
                if (this.data.length === 1) {
                    this.showNotification('Cannot delete the last slide', 'warning');
                    return;
                }
                this.data.splice(idx, 1);
                if (this.curr >= this.data.length) {
                    this.curr = this.data.length - 1;
                }
                this.saveState();
                this.renderSlides();
                this.loadCanvas();
                this.showNotification('Slide deleted successfully');
            },

            switchSlide(idx) {
                this.curr = idx;
                this.renderSlides();
                this.loadCanvas();
                this.deselectAll();
                
                // Auto-scroll sidebar to the active slide
                setTimeout(() => {
                    const sidebar = document.getElementById('sidebar');
                    const activeSlide = sidebar.querySelector('.sidebar-slide.active');
                    if (activeSlide) {
                        activeSlide.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 50);

                // Auto-scroll main canvas to the active slide
                setTimeout(() => {
                    const mainCanvas = document.getElementById('mainCanvas');
                    const slides = document.querySelectorAll('.canvas-slide');
                    const activeCanvasSlide = slides[idx];
                    if (activeCanvasSlide) {
                        activeCanvasSlide.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            },

            deleteElement() {
                if (!this.sel) return;
                
                const id = this.sel.dataset.id;
                this.data[this.curr].els = this.data[this.curr].els.filter(e => e.id != id);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                this.sel = null;
            },

            duplicateElement() {
                if (!this.sel) return;
                
                const id = this.sel.dataset.id;
                const el = this.data[this.curr].els.find(e => e.id == id);
                if (el) {
                    const newEl = { ...el, id: Date.now(), x: el.x + 20, y: el.y + 20 };
                    this.data[this.curr].els.push(newEl);
                    this.saveState();
                    this.loadCanvas();
                    this.renderSlides();
                }
            },

            saveElementPosition() {
                if (!this.sel) return;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.x = parseInt(this.sel.style.left);
                    el.y = parseInt(this.sel.style.top);
                    el.width = parseInt(this.sel.style.width);
                    el.height = parseInt(this.sel.style.height);
                    
                    // Preserve text content when resizing
                    if (el.type === 'text') {
                        const currentContent = this.sel.innerText || this.sel.textContent || el.content || '';
                        el.content = currentContent;
                    }
                    
                    this.saveState();
                    
                    // Update properties panel
                    this.renderPropertiesPanel(el);
                    
                    // Debounce thumbnail update to avoid performance issues during dragging
                    if (this.thumbnailUpdateTimeout) {
                        clearTimeout(this.thumbnailUpdateTimeout);
                    }
                    this.thumbnailUpdateTimeout = setTimeout(() => {
                        this.renderSlides();
                    }, 200);
                }
            },

            changeFont() {
                if (!this.sel) return;
                
                const font = document.getElementById('fontFamily').value;
                let fontFamily = font;
                
                // Add fallback fonts
                if (font === 'Kraft Mono') {
                    fontFamily = "'Kraft Mono', 'JetBrains Mono', monospace";
                } else if (font === 'ID Grotesk') {
                    fontFamily = "'ID Grotesk', 'Work Sans', sans-serif";
                }
                
                this.sel.style.fontFamily = fontFamily;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.font = font;
                    this.saveState();
                    this.renderSlides();
                }
            },

            changeFontSize() {
                if (!this.sel) return;
                
                const size = document.getElementById('fontSize').value;
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el && el.type === 'text') {
                    // Preserve content when changing size
                    const currentContent = this.sel.innerText || this.sel.textContent || el.content || '';
                    el.content = currentContent;
                }
                
                this.sel.style.fontSize = size + 'px';
                
                if (el) {
                    el.size = parseInt(size);
                    this.saveState();
                    this.renderSlides();
                }
            },

            toggleBold() {
                if (!this.sel) return;
                
                const current = this.sel.style.fontWeight;
                const newWeight = current === 'bold' ? 'normal' : 'bold';
                this.sel.style.fontWeight = newWeight;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.weight = newWeight;
                    this.saveState();
                    this.renderSlides();
                }
            },

            toggleItalic() {
                if (!this.sel) return;
                
                const current = this.sel.style.fontStyle;
                this.sel.style.fontStyle = current === 'italic' ? 'normal' : 'italic';
                this.saveState();
                this.renderSlides();
            },

            toggleUnderline() {
                if (!this.sel) return;
                
                const current = this.sel.style.textDecoration;
                this.sel.style.textDecoration = current === 'underline' ? 'none' : 'underline';
                this.saveState();
                this.renderSlides();
            },

            changeTextColor() {
                if (!this.sel) return;
                
                const color = document.getElementById('textColor').value;
                this.sel.style.color = color;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.color = color;
                    this.saveState();
                    this.renderSlides();
                }
            },

            changeBgColor() {
                if (!this.sel) return;
                
                const color = document.getElementById('bgColor').value;
                this.sel.style.backgroundColor = color;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.bg = color;
                    this.saveState();
                    this.renderSlides();
                }
            },

            alignText(align) {
                if (!this.sel) return;
                
                this.sel.style.textAlign = align;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.align = align;
                    this.saveState();
                    this.renderSlides();
                }
            },

            moveLayer(direction) {
                if (!this.sel) return;
                
                const id = this.sel.dataset.id;
                const els = this.data[this.curr].els;
                const idx = els.findIndex(e => e.id == id);
                
                if (direction === 'forward' && idx < els.length - 1) {
                    [els[idx], els[idx + 1]] = [els[idx + 1], els[idx]];
                } else if (direction === 'backward' && idx > 0) {
                    [els[idx], els[idx - 1]] = [els[idx - 1], els[idx]];
                }
                
                this.saveState();
                this.loadCanvas();
            },

            saveState() {
                const state = JSON.stringify(this.data);
                if (this.historyIndex < this.history.length - 1) {
                    this.history = this.history.slice(0, this.historyIndex + 1);
                }
                this.history.push(state);
                this.historyIndex++;
                
                document.getElementById('undoBtn').disabled = this.historyIndex <= 0;
                document.getElementById('redoBtn').disabled = this.historyIndex >= this.history.length - 1;
            },

            undo() {
                if (this.historyIndex > 0) {
                    this.historyIndex--;
                    this.data = JSON.parse(this.history[this.historyIndex]);
                    this.loadCanvas();
                    this.renderSlides();
                    
                    document.getElementById('undoBtn').disabled = this.historyIndex <= 0;
                    document.getElementById('redoBtn').disabled = false;
                }
            },

            redo() {
                if (this.historyIndex < this.history.length - 1) {
                    this.historyIndex++;
                    this.data = JSON.parse(this.history[this.historyIndex]);
                    this.loadCanvas();
                    this.renderSlides();
                    
                    document.getElementById('undoBtn').disabled = false;
                    document.getElementById('redoBtn').disabled = this.historyIndex >= this.history.length - 1;
                }
            },

            newPresentation() {
                if (confirm('Start a new presentation? Unsaved changes will be lost.')) {
                    this.data = [{ els: [], bg: 'white', transition: 'fade' }];
                    this.curr = 0;
                    this.history = [];
                    this.historyIndex = -1;
                    document.getElementById('title').value = '';
                    this.saveState();
                    this.loadCanvas();
                    this.renderSlides();
                }
            },

            async saveToFirebase() {
                if (!window.firebaseDb || !window.currentUserId) {
                    this.showNotification('Please log in to save to cloud', 'error');
                    return;
                }

                try {
                    const { collection, addDoc, doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const title = document.getElementById('title').value || 'Untitled presentation';
                    const presentationData = {
                        title: title,
                        slides: this.data,
                        editorType: 'editor-ad',
                        updatedAt: serverTimestamp(),
                        createdAt: serverTimestamp()
                    };

                    // Check if we're editing an existing presentation
                    const urlParams = new URLSearchParams(window.location.search);
                    let presentationId = urlParams.get('presentationId');
                    
                    // Also check if we have a stored presentationId (for cases where URL might not have it)
                    if (!presentationId && this.currentPresentationId) {
                        presentationId = this.currentPresentationId;
                    }
                    
                    if (presentationId) {
                        // Update existing presentation
                        const presentationRef = doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', presentationId);
                        await setDoc(presentationRef, {
                            ...presentationData,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        // Store presentationId for future saves
                        this.currentPresentationId = presentationId;
                        
                        this.showNotification('Presentation updated successfully');
                    } else {
                        // Create new presentation
                        const presentationsRef = collection(window.firebaseDb, 'users', window.currentUserId, 'presentations');
                        const docRef = await addDoc(presentationsRef, {
                            ...presentationData,
                            createdAt: serverTimestamp()
                        });
                        
                        // Store presentationId for future saves
                        this.currentPresentationId = docRef.id;
                        
                        // Update URL with the new presentation ID
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('presentationId', docRef.id);
                        window.history.replaceState({}, '', newUrl);
                        this.showNotification('Presentation saved to cloud successfully');
                    }
                } catch (error) {
                    console.error('Failed to save to Firebase:', error);
                    this.showNotification('Failed to save to cloud: ' + error.message, 'error');
                }
            },

            saveJSON() {
                // Save to Firebase only
                this.saveToFirebase();
            },

            loadJSON() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            try {
                                const data = JSON.parse(ev.target.result);
                                this.data = data.slides;
                                document.getElementById('title').value = data.title || '';
                                this.curr = 0;
                                this.saveState();
                                this.loadCanvas();
                                this.renderSlides();
                                this.showNotification('Presentation loaded successfully');
                            } catch (err) {
                                this.showNotification('Error loading file. Please check the file format.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            },

            toggleExport() {
                document.getElementById('exportMenu').classList.toggle('show');
            },

            async exportPDF() {
                this.showLoading();
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape', 'px', [960, 540]);
                    
                    const slides = document.querySelectorAll('.canvas-slide');
                    
                    for (let i = 0; i < slides.length; i++) {
                        if (i > 0) pdf.addPage([960, 540], 'landscape');
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        const canvas = await html2canvas(slides[i], {
                            width: 960,
                            height: 540,
                            scale: 2
                        });
                        
                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', 0, 0, 960, 540);
                    }
                    
                    pdf.save((document.getElementById('title').value || 'presentation') + '.pdf');
                    this.showNotification('PDF exported successfully');
                } catch (error) {
                    this.showNotification('Failed to export PDF', 'error');
                } finally {
                    this.hideLoading();
                    this.closeModal('exportMenu');
                }
            },

            async exportImages() {
                this.showLoading();
                try {
                    const slides = document.querySelectorAll('.canvas-slide');
                    
                    for (let i = 0; i < slides.length; i++) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        const canvas = await html2canvas(slides[i], {
                            width: 960,
                            height: 540,
                            scale: 2
                        });
                        
                        canvas.toBlob(blob => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `slide-${i + 1}.png`;
                            a.click();
                        });
                    }
                    this.showNotification('Images exported successfully');
                } catch (error) {
                    this.showNotification('Failed to export images', 'error');
                } finally {
                    this.hideLoading();
                    this.closeModal('exportMenu');
                }
            },

            shareLink() {
                const data = btoa(JSON.stringify({
                    title: document.getElementById('title').value,
                    slides: this.data
                }));
                const url = window.location.origin + window.location.pathname + '?data=' + data;
                
                navigator.clipboard.writeText(url).then(() => {
                    this.showNotification('Share link copied to clipboard!');
                }).catch(() => {
                    this.showNotification('Failed to copy link', 'error');
                });
                this.closeModal('exportMenu');
            },

            copyStyle() {
                if (!this.sel) {
                    this.showNotification('Select an element first', 'warning');
                    return;
                }
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    this.copiedStyle = {
                        font: el.font,
                        size: el.size,
                        weight: el.weight,
                        color: el.color,
                        bg: el.bg,
                        align: el.align,
                        border: el.border,
                        thick: el.thick
                    };
                    this.showNotification('Style copied! Select another element and click Paste Style');
                }
            },

            pasteStyle() {
                if (!this.copiedStyle) {
                    this.showNotification('Copy a style first', 'warning');
                    return;
                }
                
                if (!this.sel) {
                    this.showNotification('Select target element', 'warning');
                    return;
                }
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    if (el.type === 'text' && this.copiedStyle.font) {
                        el.font = this.copiedStyle.font;
                        el.size = this.copiedStyle.size;
                        el.weight = this.copiedStyle.weight;
                        el.color = this.copiedStyle.color;
                        el.bg = this.copiedStyle.bg;
                        el.align = this.copiedStyle.align;
                    }
                    if (el.type === 'shape' && this.copiedStyle.border) {
                        el.border = this.copiedStyle.border;
                        el.thick = this.copiedStyle.thick;
                        el.bg = this.copiedStyle.bg;
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.showNotification('Style applied successfully');
            },

            setBgColor() {
                document.getElementById('bgModal').classList.add('show');
            },

            applyBg(color) {
                // Store original color
                this.data[this.curr].bg = color;
                this.data[this.curr].originalBg = color;
                
                // Get current transparency and apply it
                const transparency = this.data[this.curr].transparency || 0;
                if (transparency > 0) {
                    this.data[this.curr].bgOpacity = (100 - transparency) / 100;
                    // If it's a hex color, convert to rgba
                    if (color.startsWith('#')) {
                        const r = parseInt(color.slice(1, 3), 16);
                        const g = parseInt(color.slice(3, 5), 16);
                        const b = parseInt(color.slice(5, 7), 16);
                        const alpha = (100 - transparency) / 100;
                        this.data[this.curr].bg = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                    }
                } else {
                    this.data[this.curr].bgOpacity = 1;
                }
                
                // Update transparency controls if dropdown is open
                const slider = document.getElementById('bgTransparencySlider');
                const input = document.getElementById('bgTransparencyInput');
                if (slider) slider.value = transparency;
                if (input) input.value = transparency;
                
                // Use setTimeout to prevent UI freezing
                setTimeout(() => {
                    this.loadCanvas();
                    this.saveState();
                    this.renderSlides();
                }, 10);
            },

            updateBgTransparency(value) {
                const transparency = parseInt(value) || 0;
                this.data[this.curr].transparency = transparency;
                
                // Update slider and input
                const slider = document.getElementById('bgTransparencySlider');
                const input = document.getElementById('bgTransparencyInput');
                if (slider) slider.value = transparency;
                if (input) input.value = transparency;
                
                // Apply transparency to current background
                const currentBg = this.data[this.curr].bg || 'white';
                this.data[this.curr].bgOpacity = (100 - transparency) / 100;
                
                // If background is hex color and transparency > 0, convert to rgba
                // Otherwise, keep original and use opacity
                if (currentBg.startsWith('#') && transparency > 0) {
                    const r = parseInt(currentBg.slice(1, 3), 16);
                    const g = parseInt(currentBg.slice(3, 5), 16);
                    const b = parseInt(currentBg.slice(5, 7), 16);
                    const alpha = (100 - transparency) / 100;
                    // Store original hex for when transparency is reset
                    if (!this.data[this.curr].originalBg) {
                        this.data[this.curr].originalBg = currentBg;
                    }
                    this.data[this.curr].bg = `rgba(${r}, ${g}, ${b}, ${alpha})`;
                } else if (transparency === 0 && this.data[this.curr].originalBg) {
                    // Restore original color when transparency is 0
                    this.data[this.curr].bg = this.data[this.curr].originalBg;
                    delete this.data[this.curr].originalBg;
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            },

            adjustTransparency(delta) {
                const input = document.getElementById('bgTransparencyInput');
                if (!input) return;
                
                let currentValue = parseInt(input.value) || 0;
                currentValue = Math.max(0, Math.min(100, currentValue + delta));
                
                this.updateBgTransparency(currentValue);
            },

            uploadBgImage() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            this.data[this.curr].bg = `url(${ev.target.result})`;
                            this.closeModal('bgModal');
                            
                            // Use setTimeout to prevent UI freezing
                            setTimeout(() => {
                                this.loadCanvas();
                                this.saveState();
                            }, 10);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },

            showAnimations() {
                if (!this.sel) {
                    this.showNotification('Select an element first', 'warning');
                    return;
                }
                document.getElementById('animModal').classList.add('show');
            },

            applyAnimation(animation) {
                if (!this.sel) return;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.animation = animation;
                    this.saveState();
                    this.closeModal('animModal');
                    this.showNotification(`Animation "${animation}" applied! Preview in Presentation Mode`);
                }
            },

            presentMode() {
                this.presenting = true;
                this.presentSlide = 0;
                
                const presentDiv = document.createElement('div');
                presentDiv.className = 'present-mode active';
                presentDiv.innerHTML = `
                    <div class="present-slide">
                        <div class="present-canvas" id="presentCanvas"></div>
                    </div>
                    <div class="present-controls">
                        <button class="present-btn" onclick="app.prevPresentSlide()"></button>
                        <div class="present-counter"><span id="presentCounter">1 / ${this.data.length}</span></div>
                        <button class="present-btn" onclick="app.nextPresentSlide()"></button>
                        <button class="present-btn" onclick="app.exitPresent()"></button>
                    </div>
                `;
                document.body.appendChild(presentDiv);
                
                this.renderPresentSlide();
                
                document.addEventListener('keydown', this.presentKeyHandler = (e) => {
                    if (e.key === 'Escape') this.exitPresent();
                    if (e.key === 'ArrowRight' || e.key === ' ') this.nextPresentSlide();
                    if (e.key === 'ArrowLeft') this.prevPresentSlide();
                });
            },

            renderPresentSlide() {
                const canvas = document.getElementById('presentCanvas');
                if (!canvas) return;
                
                const slide = this.data[this.presentSlide];
                canvas.innerHTML = '';
                canvas.style.width = '960px';
                canvas.style.height = '540px';
                canvas.style.background = slide.bg || '#ffffff';
                canvas.style.position = 'relative';
                
                if (slide.bg && slide.bg.startsWith('url(')) {
                    canvas.style.backgroundImage = slide.bg;
                    canvas.style.backgroundSize = 'cover';
                    canvas.style.backgroundPosition = 'center';
                }
                
                const transition = slide.transition || 'fade';
                canvas.className = 'present-canvas slide-transition-' + transition;
                
                slide.els.forEach((el, index) => {
                    const div = document.createElement('div');
                    div.className = 'element ' + el.type + '-element';
                    div.style.left = el.x + 'px';
                    div.style.top = el.y + 'px';
                    div.style.width = el.width + 'px';
                    div.style.height = el.height + 'px';

                    if (el.shadow) {
                        div.style.boxShadow = el.shadow;
                    }

                    if (el.type === 'text') {
                        div.textContent = el.content;
                        div.style.fontFamily = el.font || 'Arial';
                        div.style.fontSize = (el.size || 24) + 'px';
                        div.style.color = el.color || '#000000';
                        div.style.backgroundColor = el.bg || 'transparent';
                        div.style.fontWeight = el.weight || 'normal';
                        div.style.textAlign = el.align || 'left';
                        div.style.padding = '8px';
                    }

                    if (el.type === 'shape') {
                        div.style.backgroundColor = el.bg || '#3b82f6';
                        div.style.border = `${el.thick || 2}px solid ${el.border || '#1e40af'}`;
                        
                        // Apply shape styles for presentation
                        switch(el.shape) {
                            case 'circle':
                                div.style.borderRadius = '50%';
                                break;
                            case 'rectangle':
                                div.style.borderRadius = '4px';
                                break;
                            case 'triangle':
                                div.style.backgroundColor = 'transparent';
                                div.style.borderLeft = `${el.width / 2}px solid transparent`;
                                div.style.borderRight = `${el.width / 2}px solid transparent`;
                                div.style.borderBottom = `${el.height}px solid ${el.bg || '#3b82f6'}`;
                                div.style.width = '0';
                                div.style.height = '0';
                                div.style.border = 'none';
                                break;
                            case 'star':
                                div.style.borderRadius = '4px';
                                div.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                                break;
                            case 'pentagon':
                                div.style.clipPath = 'polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)';
                                break;
                            case 'hexagon':
                                div.style.clipPath = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)';
                                break;
                            case 'diamond':
                                div.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';
                                break;
                            case 'arrow-right':
                                div.style.clipPath = 'polygon(0% 25%, 60% 25%, 60% 0%, 100% 50%, 60% 100%, 60% 75%, 0% 75%)';
                                break;
                            case 'arrow-left':
                                div.style.clipPath = 'polygon(40% 25%, 100% 25%, 100% 75%, 40% 75%, 40% 100%, 0% 50%, 40% 0%)';
                                break;
                            default:
                                div.style.borderRadius = '4px';
                        }
                    }

                    if (el.type === 'image') {
                        const img = document.createElement('img');
                        img.src = el.src;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        div.appendChild(img);
                    }

                    if (el.animation && el.animation !== 'none') {
                        setTimeout(() => {
                            div.classList.add('animate-' + el.animation);
                        }, index * 200);
                    }
                    canvas.appendChild(div);
                });
                
                document.getElementById('presentCounter').textContent = `${this.presentSlide + 1} / ${this.data.length}`;
            },

            nextPresentSlide() {
                if (this.presentSlide < this.data.length - 1) {
                    this.presentSlide++;
                    this.renderPresentSlide();
                }
            },

            prevPresentSlide() {
                if (this.presentSlide > 0) {
                    this.presentSlide--;
                    this.renderPresentSlide();
                }
            },

            exitPresent() {
                this.presenting = false;
                document.querySelector('.present-mode')?.remove();
                document.removeEventListener('keydown', this.presentKeyHandler);
            },

            // Design Functions
            showTemplates() {
                const modal = document.getElementById('templatesModal');
                const grid = document.getElementById('templatesGrid');
                
                // Define templates with actual content
                const templates = [
                    {
                        name: 'Title Slide',
                        bg: 'white',
                        elements: [
                            { type: 'text', content: 'Presentation Title', x: 480, y: 200, width: 400, height: 80, size: 48, color: '#1e293b', font: 'Arial', weight: 'bold', align: 'center' },
                            { type: 'text', content: 'Subtitle or Description', x: 480, y: 300, width: 400, height: 40, size: 24, color: '#64748b', font: 'Arial', align: 'center' }
                        ]
                    },
                    {
                        name: 'Bullet Points',
                        bg: 'white',
                        elements: [
                            { type: 'text', content: 'Main Topic', x: 100, y: 100, width: 600, height: 60, size: 36, color: '#1e293b', font: 'Arial', weight: 'bold' },
                            { type: 'text', content: ' First point', x: 120, y: 200, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' },
                            { type: 'text', content: ' Second point', x: 120, y: 260, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' },
                            { type: 'text', content: ' Third point', x: 120, y: 320, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' }
                        ]
                    },
                    {
                        name: 'Two Columns',
                        bg: 'white',
                        elements: [
                            { type: 'text', content: 'Column 1', x: 150, y: 100, width: 300, height: 50, size: 32, color: '#1e293b', font: 'Arial', weight: 'bold', align: 'center' },
                            { type: 'text', content: 'Content here...', x: 150, y: 180, width: 300, height: 200, size: 20, color: '#475569', font: 'Arial' },
                            { type: 'text', content: 'Column 2', x: 510, y: 100, width: 300, height: 50, size: 32, color: '#1e293b', font: 'Arial', weight: 'bold', align: 'center' },
                            { type: 'text', content: 'Content here...', x: 510, y: 180, width: 300, height: 200, size: 20, color: '#475569', font: 'Arial' }
                        ]
                    },
                    {
                        name: 'Image + Text',
                        bg: 'white',
                        elements: [
                            { type: 'text', content: 'Title', x: 480, y: 100, width: 400, height: 60, size: 40, color: '#1e293b', font: 'Arial', weight: 'bold', align: 'center' },
                            { type: 'text', content: 'Description text goes here', x: 480, y: 400, width: 600, height: 60, size: 20, color: '#64748b', font: 'Arial', align: 'center' }
                        ]
                    },
                    {
                        name: 'Quote',
                        bg: '#f8fafc',
                        elements: [
                            { type: 'text', content: '"', x: 100, y: 150, width: 100, height: 100, size: 80, color: '#10b981', font: 'Arial', weight: 'bold' },
                            { type: 'text', content: 'Inspirational quote text here', x: 200, y: 180, width: 600, height: 100, size: 28, color: '#1e293b', font: 'Arial', align: 'center', style: 'italic' },
                            { type: 'text', content: ' Author Name', x: 480, y: 320, width: 300, height: 40, size: 20, color: '#64748b', font: 'Arial', align: 'center' }
                        ]
                    },
                    {
                        name: 'Numbered List',
                        bg: 'white',
                        elements: [
                            { type: 'text', content: 'Topic Title', x: 100, y: 100, width: 600, height: 50, size: 36, color: '#1e293b', font: 'Arial', weight: 'bold' },
                            { type: 'text', content: '1. First item', x: 120, y: 200, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' },
                            { type: 'text', content: '2. Second item', x: 120, y: 260, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' },
                            { type: 'text', content: '3. Third item', x: 120, y: 320, width: 700, height: 40, size: 24, color: '#475569', font: 'Arial' }
                        ]
                    }
                ];
                
                grid.innerHTML = templates.map((t, idx) => `
                    <div class="bg-option" onclick="app.applyTemplate(${idx})" style="background: ${t.bg}; cursor: pointer; position: relative; border: 2px solid #e5e7eb;">
                        <div style="position: absolute; top: 8px; left: 8px; right: 8px; font-size: 12px; font-weight: 600; color: #1e293b; text-align: center; background: rgba(255,255,255,0.9); padding: 4px; border-radius: 4px;">${t.name}</div>
                    </div>
                `).join('');
                
                // Store templates for applyTemplate
                this.templatesList = templates;
                modal.classList.add('show');
            },

            applyTemplate(index) {
                if (!this.templatesList || !this.templatesList[index]) return;
                
                const template = this.templatesList[index];
                
                // Clear current slide
                this.data[this.curr].els = [];
                this.data[this.curr].bg = template.bg;
                
                // Add template elements
                template.elements.forEach(el => {
                    const id = Date.now() + Math.random();
                    const element = {
                        id: id,
                        type: el.type,
                        x: el.x,
                        y: el.y,
                        width: el.width,
                        height: el.height,
                        bg: el.bg || 'transparent',
                        color: el.color || '#000000',
                        font: el.font || 'Arial',
                        size: el.size || 24,
                        weight: el.weight || 'normal',
                        align: el.align || 'left',
                        content: el.content || '',
                        animation: 'none'
                    };
                    this.data[this.curr].els.push(element);
                });
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                this.closeModal('templatesModal');
                this.showNotification(`Template "${template.name}" applied!`, 'success');
            },

            showThemes() {
                const modal = document.getElementById('themesModal');
                const grid = document.getElementById('themesGrid');
                
                // Define themes (combinations of background and default colors)
                const themes = [
                    { name: 'Classic', bg: 'white', primary: '#1e293b', secondary: '#64748b' },
                    { name: 'Emerald', bg: '#f0fdf4', primary: '#10b981', secondary: '#059669' },
                    { name: 'Ocean', bg: '#f0f9ff', primary: '#0ea5e9', secondary: '#0284c7' },
                    { name: 'Sunset', bg: '#fff7ed', primary: '#f97316', secondary: '#ea580c' },
                    { name: 'Purple', bg: '#faf5ff', primary: '#a855f7', secondary: '#9333ea' },
                    { name: 'Rose', bg: '#fff1f2', primary: '#f43f5e', secondary: '#e11d48' },
                    { name: 'Dark', bg: '#1e293b', primary: '#f1f5f9', secondary: '#cbd5e1' },
                    { name: 'Nature', bg: '#f0fdf4', primary: '#22c55e', secondary: '#16a34a' },
                ];
                
                grid.innerHTML = themes.map(t => `
                    <div class="bg-option" onclick="app.applyTheme('${t.name}', '${t.bg}', '${t.primary}', '${t.secondary}')" style="background: ${t.bg}; cursor: pointer; position: relative; border: 2px solid ${t.primary};">
                        <div style="position: absolute; bottom: 8px; left: 8px; right: 8px; background: ${t.primary}; color: ${t.bg === '#1e293b' ? 'white' : 'white'}; padding: 6px; border-radius: 4px; font-size: 11px; text-align: center; font-weight: 600;">${t.name}</div>
                    </div>
                `).join('');
                
                modal.classList.add('show');
            },

            applyTheme(name, bg, primary, secondary) {
                // Apply background
                this.data[this.curr].bg = bg;
                
                // Apply theme colors to all elements
                this.data[this.curr].els.forEach(el => {
                    if (el.type === 'text') {
                        // Apply primary color to bold/large text, secondary to regular text
                        if (el.weight === 'bold' || (el.size && el.size > 30)) {
                            el.color = primary;
                        } else {
                            el.color = secondary;
                        }
                    } else if (el.type === 'shape') {
                        // Apply primary color to shapes
                        el.bg = primary;
                        el.border = secondary;
                    }
                });
                
                // Store theme colors for future use
                this.currentTheme = { name, bg, primary, secondary };
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                this.closeModal('themesModal');
                this.showNotification(`Theme "${name}" applied to all elements!`, 'success');
            },

            // Image Functions
            showStockPhotos() {
                this.showNotification('Stock Photos library coming soon!', 'warning');
            },

            removeBackground() {
                if (!this.sel) {
                    this.showNotification('Select an image first', 'warning');
                    return;
                }
                
                const data = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (!data || data.type !== 'image') {
                    this.showNotification('Selected element is not an image', 'warning');
                    return;
                }
                
                const img = this.sel.querySelector('img');
                if (!img) {
                    this.showNotification('Image not found', 'error');
                    return;
                }
                
                // Show loading notification
                this.showNotification('Removing background...', 'info');
                
                // Create a new image to load the source
                const sourceImg = new Image();
                sourceImg.crossOrigin = 'anonymous';
                sourceImg.onload = () => {
                    try {
                        // Create canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = sourceImg.width;
                        canvas.height = sourceImg.height;
                        const ctx = canvas.getContext('2d');
                        
                        // Draw image on canvas
                        ctx.drawImage(sourceImg, 0, 0);
                        
                        // Get image data
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const pixelData = imageData.data;
                        
                        // Remove background (white/light colors)
                        for (let i = 0; i < pixelData.length; i += 4) {
                            const r = pixelData[i];
                            const g = pixelData[i + 1];
                            const b = pixelData[i + 2];
                            const a = pixelData[i + 3];
                            
                            // Calculate brightness
                            const brightness = (r + g + b) / 3;
                            
                            // Remove white/light background (threshold: 240)
                            // Also check if it's near white (all RGB values are high)
                            if (brightness > 240 && r > 240 && g > 240 && b > 240) {
                                pixelData[i + 3] = 0; // Make transparent
                            }
                            // Remove very light colors (brightness > 250)
                            else if (brightness > 250) {
                                pixelData[i + 3] = 0;
                            }
                            // Remove pixels that are too similar to white
                            else if (Math.abs(r - g) < 10 && Math.abs(g - b) < 10 && Math.abs(r - b) < 10 && brightness > 200) {
                                pixelData[i + 3] = 0;
                            }
                        }
                        
                        // Put modified image data back
                        ctx.putImageData(imageData, 0, 0);
                        
                        // Convert canvas to data URL
                        const newSrc = canvas.toDataURL('image/png');
                        
                        // Update image source
                        img.src = newSrc;
                        data.src = newSrc;
                        
                        // Save state
                        this.saveState();
                        this.loadCanvas();
                        this.renderSlides();
                        
                        this.showNotification('Background removed successfully!', 'success');
                    } catch (error) {
                        console.error('Error removing background:', error);
                        this.showNotification('Failed to remove background', 'error');
                    }
                };
                
                sourceImg.onerror = () => {
                    this.showNotification('Failed to load image', 'error');
                };
                
                // Load the image
                sourceImg.src = data.src;
            },

            adjustImage() {
                if (!this.sel) {
                    this.showNotification('Select an image first', 'warning');
                    return;
                }
                this.showNotification('Image adjustment tools coming soon!', 'warning');
            },

            // Shape & Data Functions
            addChart(type) {
                const id = Date.now();
                const defaultData = this.getDefaultChartData(type || 'bar');
                
                const chartData = {
                    id: id,
                    type: 'chart',
                    chartType: type || 'bar',
                    x: 200,
                    y: 150,
                    width: 500,
                    height: 350,
                    labels: defaultData.labels || [],
                    values: defaultData.values || [],
                    colors: defaultData.colors || [],
                    showValues: true
                };
                
                this.data[this.curr].els.push(chartData);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Auto-select the new chart and ensure data is visible
                setTimeout(() => {
                    const elementEl = document.querySelector(`[data-id="${id}"]`);
                    if (elementEl) {
                        this.selectElement(elementEl);
                        // Force re-render properties panel to show data
                        setTimeout(() => {
                            const data = this.data[this.curr].els.find(e => e.id == id);
                            if (data) {
                                this.renderPropertiesPanel(data);
                            }
                        }, 50);
                    }
                }, 100);
            },

            getDefaultChartData(type) {
                switch(type) {
                    case 'bar':
                        return {
                            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                            values: [65, 59, 80, 81],
                            colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']
                        };
                    case 'line':
                        return {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
                            values: [12, 19, 15, 25, 22],
                            colors: ['#10b981']
                        };
                    case 'pie':
                        return {
                            labels: ['Red', 'Blue', 'Yellow', 'Green'],
                            values: [30, 25, 20, 25],
                            colors: ['#ef4444', '#3b82f6', '#f59e0b', '#10b981']
                        };
                    default:
                        return { labels: [], values: [], colors: [] };
                }
            },

            addTable(rows, cols) {
                const id = Date.now();
                const tableData = {
                    id: id,
                    type: 'table',
                    rows: rows || 3,
                    cols: cols || 3,
                    x: 200,
                    y: 150,
                    width: 400,
                    height: 200,
                    data: this.createTableData(rows || 3, cols || 3)
                };
                
                this.data[this.curr].els.push(tableData);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Auto-select the new table
                setTimeout(() => {
                    const elementEl = document.querySelector(`[data-id="${id}"]`);
                    if (elementEl) this.selectElement(elementEl);
                }, 100);
            },

            createTableData(rows, cols) {
                const data = [];
                for (let r = 0; r < rows; r++) {
                    const row = [];
                    for (let c = 0; c < cols; c++) {
                        row.push(r === 0 ? `Header ${c + 1}` : `Cell ${r},${c}`);
                    }
                    data.push(row);
                }
                return data;
            },

            showSymbols(category) {
                // Create or show symbols modal
                let modal = document.getElementById('symbolsModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.id = 'symbolsModal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                            <span class="modal-close" onclick="app.closeModal('symbolsModal')"></span>
                            <div class="modal-header">Choose Symbol</div>
                            <div id="symbolsGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; padding: 20px;">
                                <!-- Symbols will be loaded here -->
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
                
                // Load symbols based on category
                const symbolsGrid = document.getElementById('symbolsGrid');
                const symbols = this.getSymbolsByCategory(category);
                
                symbolsGrid.innerHTML = '';
                symbols.forEach(symbol => {
                    const symbolDiv = document.createElement('div');
                    symbolDiv.className = 'bg-color-item';
                    symbolDiv.style.cssText = 'width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 8px; background: white; transition: all 0.2s;';
                    symbolDiv.textContent = symbol;
                    symbolDiv.onclick = () => {
                        this.addSymbol(symbol);
                        this.closeModal('symbolsModal');
                    };
                    symbolDiv.onmouseenter = () => {
                        symbolDiv.style.transform = 'scale(1.1)';
                        symbolDiv.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                        symbolDiv.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.2)';
                    };
                    symbolDiv.onmouseleave = () => {
                        symbolDiv.style.transform = 'scale(1)';
                        symbolDiv.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        symbolDiv.style.boxShadow = 'none';
                    };
                    symbolsGrid.appendChild(symbolDiv);
                });
                
                modal.classList.add('show');
            },

            getSymbolsByCategory(category) {
                const symbolSets = {
                    arrows: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    shapes: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    symbols: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
                };
                return symbolSets[category] || symbolSets.symbols;
            },

            addSymbol(symbol) {
                const id = Date.now();
                const symbolData = {
                    id: id,
                    type: 'symbol',
                    symbol: symbol,
                    x: 200,
                    y: 150,
                    width: 100,
                    height: 100,
                    fontSize: 48,
                    color: '#000000'
                };
                
                this.data[this.curr].els.push(symbolData);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Auto-select the new symbol
                setTimeout(() => {
                    const elementEl = document.querySelector(`[data-id="${id}"]`);
                    if (elementEl) this.selectElement(elementEl);
                }, 100);
            },

            updateChartType(id, type) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'chart') return;
                
                data.chartType = type;
                // Update data structure if needed
                if (!data.labels || data.labels.length === 0) {
                    const defaultData = this.getDefaultChartData(type);
                    data.labels = defaultData.labels;
                    data.values = defaultData.values;
                    data.colors = defaultData.colors;
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateChartData(id, field, index, value) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'chart') return;
                
                if (field === 'label') {
                    if (!data.labels) data.labels = [];
                    data.labels[index] = value;
                } else if (field === 'value') {
                    if (!data.values) data.values = [];
                    data.values[index] = parseFloat(value) || 0;
                } else if (field === 'color') {
                    if (!data.colors) data.colors = [];
                    data.colors[index] = value;
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateChartProperty(id, property, value) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'chart') return;
                
                data[property] = value;
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            addChartItem(id) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'chart') return;
                
                if (!data.labels) data.labels = [];
                if (!data.values) data.values = [];
                if (!data.colors) data.colors = [];
                
                const defaultColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
                const newIndex = data.labels.length;
                
                data.labels.push(`Item ${newIndex + 1}`);
                data.values.push(0);
                data.colors.push(defaultColors[newIndex % defaultColors.length]);
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            removeChartItem(id, index) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'chart') return;
                
                if (data.labels && data.labels.length > index) {
                    data.labels.splice(index, 1);
                }
                if (data.values && data.values.length > index) {
                    data.values.splice(index, 1);
                }
                if (data.colors && data.colors.length > index) {
                    data.colors.splice(index, 1);
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateTableSize(id, dimension, value) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'table') return;
                
                if (dimension === 'rows') {
                    data.rows = Math.max(1, Math.min(10, value));
                    // Adjust data array
                    while (data.data.length < data.rows) {
                        const newRow = [];
                        for (let c = 0; c < data.cols; c++) {
                            newRow.push(`Cell ${data.data.length + 1},${c + 1}`);
                        }
                        data.data.push(newRow);
                    }
                    while (data.data.length > data.rows) {
                        data.data.pop();
                    }
                } else if (dimension === 'cols') {
                    data.cols = Math.max(1, Math.min(10, value));
                    // Adjust data array
                    data.data.forEach((row, r) => {
                        while (row.length < data.cols) {
                            row.push(r === 0 ? `Header ${row.length + 1}` : `Cell ${r + 1},${row.length + 1}`);
                        }
                        while (row.length > data.cols) {
                            row.pop();
                        }
                    });
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            updateSymbolProperty(id, prop, value) {
                const elementId = typeof id === 'string' ? parseInt(id) : id;
                const data = this.data[this.curr].els.find(e => e.id == elementId);
                if (!data || data.type !== 'symbol') return;
                
                data[prop] = value;
                
                // Apply changes immediately
                if (this.sel && parseInt(this.sel.dataset.id) === elementId) {
                    if (prop === 'color') {
                        this.sel.style.color = value;
                    } else if (prop === 'fontSize') {
                        this.sel.style.fontSize = value + 'px';
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
                
                // Re-select to update properties panel
                setTimeout(() => {
                    const el = document.querySelector(`[data-id="${elementId}"]`);
                    if (el) this.selectElement(el);
                }, 50);
            },

            drawChart(ctx, type, chartData, width, height) {
                try {
                    ctx.clearRect(0, 0, width, height);
                    
                    // Convert old data format to new format if needed
                    if (chartData.data && chartData.data.datasets && !chartData.labels) {
                        const oldData = chartData.data;
                        chartData.labels = oldData.labels || [];
                        if (oldData.datasets && oldData.datasets[0]) {
                            chartData.values = oldData.datasets[0].data || [];
                            if (type === 'line') {
                                chartData.colors = [oldData.datasets[0].borderColor || '#10b981'];
                            } else {
                                chartData.colors = oldData.datasets[0].backgroundColor || [];
                            }
                        }
                    }
                    
                    // Ensure data arrays exist
                    if (!chartData.labels || chartData.labels.length === 0) {
                        const defaultData = this.getDefaultChartData(type || 'bar');
                        chartData.labels = defaultData.labels || [];
                        chartData.values = defaultData.values || [];
                        chartData.colors = defaultData.colors || [];
                    }
                    
                    const labels = chartData.labels || [];
                    const values = chartData.values || [];
                    const colors = chartData.colors || [];
                    
                    if (!labels || labels.length === 0 || !values || values.length === 0) {
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '14px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('No data', width / 2, height / 2);
                        return;
                    }
                    
                    const padding = 50;
                    const chartWidth = Math.max(100, width - (padding * 2));
                    const chartHeight = Math.max(100, height - (padding * 2));
                    
                    // Set default showValues if not set
                    if (chartData.showValues === undefined) {
                        chartData.showValues = true;
                    }
                    
                    switch(type) {
                        case 'bar':
                            this.drawBarChart(ctx, labels, values, colors, padding, chartWidth, chartHeight, width, height, chartData);
                            break;
                        case 'line':
                            this.drawLineChart(ctx, labels, values, colors, padding, chartWidth, chartHeight, width, height, chartData);
                            break;
                        case 'pie':
                            this.drawPieChart(ctx, labels, values, colors, padding, chartWidth, chartHeight, width, height, chartData);
                            break;
                        default:
                            console.warn('Unknown chart type:', type);
                    }
                } catch (error) {
                    console.error('Error drawing chart:', error);
                    ctx.fillStyle = '#ef4444';
                    ctx.font = '14px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('Chart Error', width / 2, height / 2);
                }
            },

            drawBarChart(ctx, labels, values, colors, padding, width, height, canvasWidth, canvasHeight, data = {}) {
                const maxValue = Math.max(...values, 1);
                const barWidth = Math.max(20, width / labels.length * 0.7);
                const spacing = width / labels.length;
                const showValues = data.showValues !== false; // Default to true if undefined
                const leftPadding = 50; // Extra padding for Y-axis labels
                
                // Draw background grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding + (height / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding + leftPadding, y);
                    ctx.lineTo(padding + width, y);
                    ctx.stroke();
                }
                
                // Draw Y-axis labels on the left
                if (showValues) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '11px Inter, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                    for (let i = 0; i <= 4; i++) {
                        const y = padding + (height / 4) * i;
                        const yValue = Math.round(maxValue - (maxValue / 4) * i);
                        ctx.fillText(yValue.toString(), padding + leftPadding - 10, y);
                    }
                }
                
                // Draw bars
                labels.forEach((label, i) => {
                    if (i >= values.length) return;
                    
                    const value = values[i] || 0;
                    const barHeight = Math.max(2, (value / maxValue) * height);
                    const x = padding + leftPadding + (i * spacing) + (spacing - barWidth) / 2;
                    const y = padding + height - barHeight;
                    
                    // Draw bar
                    const defaultColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
                    ctx.fillStyle = colors[i] || defaultColors[i % defaultColors.length];
                    ctx.fillRect(x, y, barWidth, barHeight);
                    
                    // Draw value in the center of the bar (only if showValues is true)
                    if (barHeight > 15 && showValues) {
                        const centerY = y + barHeight / 2;
                        // Use white text if bar is dark, black if bar is light
                        const isDark = ['#10b981', '#3b82f6', '#8b5cf6'].includes(colors[i] || defaultColors[i % defaultColors.length]);
                        ctx.fillStyle = isDark ? '#ffffff' : '#374151';
                        ctx.font = 'bold 12px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(value.toString(), x + barWidth / 2, centerY);
                    }
                    
                    // Draw label
                    ctx.fillStyle = '#374151';
                    ctx.font = '11px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillText(label, padding + leftPadding + (i * spacing) + spacing / 2, padding + height + 10);
                });
            },

            drawLineChart(ctx, labels, values, colors, padding, width, height, canvasWidth, canvasHeight, data = {}) {
                const maxValue = Math.max(...values, 1);
                const spacing = labels.length > 1 ? width / (labels.length - 1) : (width / 2);
                const color = colors[0] || '#10b981';
                const bgColor = color + '20';
                const showValues = data.showValues !== false; // Default to true if undefined
                
                // Draw background grid
                ctx.strokeStyle = '#e5e7eb';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = padding + (height / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(padding + width, y);
                    ctx.stroke();
                }
                
                // Draw area under line
                ctx.fillStyle = bgColor;
                ctx.beginPath();
                ctx.moveTo(padding, padding + height);
                
                values.forEach((value, i) => {
                    const x = padding + (i * spacing);
                    const y = padding + height - (value / maxValue) * height;
                    ctx.lineTo(x, y);
                });
                
                ctx.lineTo(padding + width, padding + height);
                ctx.closePath();
                ctx.fill();
                
                // Draw line
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                values.forEach((value, i) => {
                    const x = padding + (i * spacing);
                    const y = padding + height - (value / maxValue) * height;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Draw points
                values.forEach((value, i) => {
                    const x = padding + (i * spacing);
                    const y = padding + height - (value / maxValue) * height;
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 6, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Draw value above point (only if showValues is true)
                    if (showValues) {
                        ctx.fillStyle = '#374151';
                        ctx.font = 'bold 11px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        ctx.fillText(value.toString(), x, y - 10);
                    }
                });
                
                // Draw labels
                labels.forEach((label, i) => {
                    const x = padding + (i * spacing);
                    ctx.fillStyle = '#374151';
                    ctx.font = '11px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillText(label, x, padding + height + 10);
                });
            },

            drawPieChart(ctx, labels, values, colors, padding, width, height, canvasWidth, canvasHeight, data = {}) {
                const centerX = padding + width / 2;
                const centerY = padding + height / 2;
                const radius = Math.min(width, height) / 2 - 20;
                const total = values.reduce((a, b) => a + b, 0);
                const showValues = data.showValues !== false; // Default to true if undefined
                
                if (total === 0) {
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '14px Inter, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('No data', canvasWidth / 2, canvasHeight / 2);
                    return;
                }
                
                let currentAngle = -Math.PI / 2;
                const defaultColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
                
                // Draw pie slices
                values.forEach((value, i) => {
                    if (value <= 0) return;
                    
                    const sliceAngle = (value / total) * Math.PI * 2;
                    const color = colors[i] || defaultColors[i % defaultColors.length];
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    
                    // Draw border
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Draw label
                    if (sliceAngle > 0.15) {
                        const labelAngle = currentAngle + sliceAngle / 2;
                        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.65);
                        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.65);
                        
                        const percentage = Math.round((value / total) * 100);
                        const labelText = labels[i] || `Item ${i + 1}`;
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 11px Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        if (showValues) {
                            // Show value and percentage
                            const valueText = value.toString();
                            const percentText = `(${percentage}%)`;
                            const textWidth = Math.max(ctx.measureText(valueText).width, ctx.measureText(percentText).width);
                            const textHeight = 32;
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                            ctx.fillRect(labelX - textWidth / 2 - 5, labelY - textHeight / 2, textWidth + 10, textHeight);
                            
                            ctx.fillStyle = '#ffffff';
                            ctx.fillText(valueText, labelX, labelY - 6);
                            ctx.fillText(percentText, labelX, labelY + 6);
                        } else {
                            // Show only label
                        const textWidth = ctx.measureText(labelText).width;
                        const textHeight = 16;
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        ctx.fillRect(labelX - textWidth / 2 - 5, labelY - textHeight / 2, textWidth + 10, textHeight);
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(labelText, labelX, labelY);
                        }
                    }
                    
                    currentAngle += sliceAngle;
                });
            },

            // Arrange Functions
            groupElements() {
                if (!this.sel) {
                    this.showNotification('Select elements to group', 'warning');
                    return;
                }
                this.showNotification('Group feature coming soon!', 'warning');
            },

            ungroupElements() {
                if (!this.sel) {
                    this.showNotification('Select a group to ungroup', 'warning');
                    return;
                }
                this.showNotification('Ungroup feature coming soon!', 'warning');
            },

            alignElements(align) {
                if (!this.sel) {
                    this.showNotification('Select elements to align', 'warning');
                    return;
                }
                this.showNotification(`Align ${align} feature coming soon!`, 'warning');
            },

            // Effects Functions
            showTransitions() {
                const modal = document.getElementById('transModal');
                if (!modal) {
                    // Create transitions modal
                    const transModal = document.createElement('div');
                    transModal.className = 'modal';
                    transModal.id = 'transModal';
                    transModal.innerHTML = `
                        <div class="modal-content">
                            <span class="modal-close" onclick="app.closeModal('transModal')"></span>
                            <div class="modal-header">Choose Slide Transition</div>
                            <div class="animation-grid">
                                <div class="animation-option" onclick="app.applyTransition('fade')">Fade</div>
                                <div class="animation-option" onclick="app.applyTransition('slide')">Slide</div>
                                <div class="animation-option" onclick="app.applyTransition('zoom')">Zoom</div>
                                <div class="animation-option" onclick="app.applyTransition('none')">None</div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(transModal);
                }
                document.getElementById('transModal').classList.add('show');
            },

            applyTransition(transition) {
                this.data[this.curr].transition = transition;
                this.saveState();
                this.closeModal('transModal');
                this.showNotification(`Transition "${transition}" applied!`);
            },

            toggleDropdown(id) {
                const dropdown = document.getElementById(id);
                if (!dropdown) return;
                
                // Close all other dropdowns
                document.querySelectorAll('.category-dropdown').forEach(dd => {
                    if (dd.id !== id) {
                        dd.classList.remove('show');
                    }
                });
                
                // Toggle current dropdown
                dropdown.classList.toggle('show');
                
                // If opening bgColorDropdown, update transparency values
                if (id === 'bgColorDropdown' && dropdown.classList.contains('show')) {
                    const transparency = this.data[this.curr].transparency || 0;
                    const slider = document.getElementById('bgTransparencySlider');
                    const input = document.getElementById('bgTransparencyInput');
                    if (slider) slider.value = transparency;
                    if (input) input.value = transparency;
                }
            },

            closeDropdown(id) {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('show');
            },

            // Zoom Functions
            setZoom(value) {
                this.zoom = parseInt(value);
                document.getElementById('zoomValue').textContent = this.zoom + '%';
                document.getElementById('canvasWrapper').style.transform = `scale(${this.zoom / 100})`;
            },

            zoomIn() {
                const slider = document.getElementById('zoomSlider');
                const newValue = Math.min(200, this.zoom + 10);
                slider.value = newValue;
                this.setZoom(newValue);
            },

            zoomOut() {
                const slider = document.getElementById('zoomSlider');
                const newValue = Math.max(25, this.zoom - 10);
                slider.value = newValue;
                this.setZoom(newValue);
            },

            resetZoom() {
                document.getElementById('zoomSlider').value = 100;
                this.setZoom(100);
            },

            // AI Assistant Functions
            getOpenAIKey() {
                // Get API key from localStorage (user should set it via browser console or settings)
                let apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    // Prompt user to set API key
                    apiKey = prompt('Please enter your OpenAI API key:');
                    if (apiKey) {
                        localStorage.setItem('openai_api_key', apiKey);
                    } else {
                        alert('OpenAI API key is required for AI features to work. Please set it in browser console: localStorage.setItem("openai_api_key", "your-key-here")');
                        return null;
                    }
                }
                return apiKey;
            },
            aiLanguage: 'en', // Default to English
            aiPendingActions: null,
            aiPendingSlidesCount: null,
            aiConversationHistory: [], // Store conversation history for context

            toggleAIPanel() {
                const sidebar = document.getElementById('aiSidebar');
                const container = document.querySelector('.container');
                if (sidebar) {
                    sidebar.classList.toggle('visible');
                    if (container) {
                        container.classList.toggle('ai-sidebar-open');
                    }
                    if (sidebar.classList.contains('visible')) {
                        // Set default language to English
                        if (!this.aiLanguage) {
                            this.aiLanguage = 'en';
                            // Auto-select English button
                            const enBtn = document.querySelector('.ai-lang-btn[onclick*="en"]');
                            if (enBtn) {
                                enBtn.style.background = '#0369a1';
                                enBtn.style.color = 'white';
                                enBtn.style.borderColor = '#0369a1';
                            }
                        }
                        // Don't reset conversation history - keep it for context
                        // Only reset pending actions
                        this.aiPendingActions = null;
                        this.aiPendingSlidesCount = null;
                        setTimeout(() => {
                            document.getElementById('aiChatInput').focus();
                        }, 100);
                    }
                }
            },

            setAILanguage(lang) {
                this.aiLanguage = lang;
                const langButtons = document.querySelectorAll('.ai-lang-btn');
                langButtons.forEach(btn => {
                    btn.style.background = 'white';
                    btn.style.borderColor = '#bae6fd';
                    btn.style.color = '#0369a1';
                });
                event.target.style.background = '#0369a1';
                event.target.style.color = 'white';
                event.target.style.borderColor = '#0369a1';
                
                if (lang === 'ar') {
                    this.addChatMessage('  .    ', 'assistant');
                    document.getElementById('aiChatInput').placeholder = '  ... (:  3    )';
                } else {
                    this.addChatMessage('English selected. How can I help you today?', 'assistant');
                    document.getElementById('aiChatInput').placeholder = 'Type your request here... (e.g., Add 3 slides about technology)';
                }
            },

            async sendAIMessage() {
                const input = document.getElementById('aiChatInput');
                const message = input.value.trim();
                if (!message) return;

                // Default to English if not set
                if (!this.aiLanguage) {
                    this.aiLanguage = 'en';
                }

                // Add user message to chat and conversation history
                this.addChatMessage(message, 'user');
                this.aiConversationHistory.push({ role: 'user', content: message });
                input.value = '';

                // Show loading
                const loadingEl = document.getElementById('aiLoading');
                const loadingText = document.getElementById('aiLoadingText');
                loadingEl.style.display = 'block';
                loadingText.textContent = this.aiLanguage === 'ar' ? ' ...' : 'Processing...';

                try {
                    // Get first slide style as reference
                    const firstSlide = this.data[0] || { els: [], bg: 'white', transition: 'fade' };
                    const firstSlideStyle = {
                        bg: firstSlide.bg || 'white',
                        elements: firstSlide.els || []
                    };
                    
                    // Extract style patterns from first slide
                    let titleStyle = { size: 42, color: '#0f172a', weight: 'bold', align: 'center', font: 'Arial' };
                    let contentStyle = { size: 24, color: '#374151', align: 'left', font: 'Arial' };
                    
                    // Find title and content elements in first slide
                    firstSlideStyle.elements.forEach(el => {
                        if (el.type === 'text') {
                            if (el.weight === 'bold' && el.size >= 36) {
                                titleStyle = { size: el.size, color: el.color, weight: el.weight, align: el.align, font: el.font || 'Arial' };
                            } else {
                                contentStyle = { size: el.size, color: el.color, align: el.align, font: el.font || 'Arial' };
                            }
                        }
                    });
                    
                    // Get current presentation state
                    const currentState = {
                        slides: this.data,
                        currentSlide: this.curr,
                        title: document.getElementById('title').value || 'Untitled Presentation',
                        totalSlides: this.data.length,
                        firstSlideStyle: firstSlideStyle,
                        titleStyle: titleStyle,
                        contentStyle: contentStyle
                    };

                    // Check if asking about number of slides
                    const slidesCountMatch = message.match(/(\d+)\s*(?:|slide|slides)/i);
                    if (slidesCountMatch && !this.aiPendingSlidesCount) {
                        this.aiPendingSlidesCount = parseInt(slidesCountMatch[1]);
                    }

                    // Prepare system message based on language
                    const systemMessage = this.aiLanguage === 'ar' ? 
                        `     . :
1.    (      )
2.     
3.   
4.   

     :
1.        
2.  preview   
3.   

 :    .    " "  " "  " "          .

    JSON  :
{
  "actions": [
    {"type": "add_slide", "title": " ", "bg": "white", "elements": [{"type": "text", "content": "", "x": 100, "y": 100, "width": 300, "height": 50, "size": 24, "color": "#000000"}]},
    {"type": "add_chart", "slide": 0, "chartType": "bar", "labels": ["A", "B", "C"], "values": [10, 20, 30], "x": 200, "y": 200, "width": 400, "height": 300}
  ],
  "preview": "   ",
  "slidesCount": 3,
  "message": " 3   .   "
}

    .` :
                        `You are a PROFESSIONAL presentation design assistant. Create DETAILED, COMPREHENSIVE, and RICH content slides with VARIED content formats.

CRITICAL: Respond with VALID JSON only. Follow the exact format below.

SLIDE CANVAS: 960px  540px

IMPORTANT RULES:
1. USE VARIED CONTENT FORMATS - Mix different text styles:
   - Regular paragraphs (descriptive text, explanations)
   - Bullet points ( for lists of items)
   - Numbered lists (1. 2. 3. for steps or sequences)
   - Don't use only bullet points - vary the format!
2. CREATE DETAILED CONTENT - Add comprehensive information (5-8 items or substantial paragraphs)
3. You can MODIFY the FIRST slide (slide 0) - use type "modify_slide" with slide: 0 to add content to the existing first slide
4. DO NOT duplicate the title - use EITHER action.title OR a title element in elements array, NOT both
5. ALWAYS use the SAME background color as the first slide (check firstSlideStyle.bg in currentState)
6. ALWAYS use the SAME text styles as the first slide:
   - Title: Use titleStyle from currentState (size, color, weight, align, font)
   - Content: Use contentStyle from currentState (size, color, align, font)
7. Use proper coordinates within canvas bounds (0-960 width, 0-540 height)
8. Don't overlap elements
9. Match the visual style and formatting of the existing first slide
10. ADD MORE CONTENT - Each slide should have substantial information, not minimal content

ELEMENT SPECIFICATIONS:

TITLE (choose ONE method):
- Option A: Use action.title field (recommended)
- Option B: Include in elements array with: type:"text", size:36-42, weight:"bold", align:"center", x:130, y:60, width:700, height:80

CONTENT TEXT - USE VARIED FORMATS (IMPORTANT!):
You MUST use different text formats, not only bullet points:

1. Regular paragraphs (no bullets, no numbers):
   - content: "This is a paragraph explaining the topic in detail. It provides comprehensive information and context. Use this for introductions, explanations, and descriptions."
   - Example: "Artificial intelligence is transforming how we work and live. It enables machines to learn from data and make intelligent decisions."

2. Bullet points (use ):
   - content: " First key point\\n Second key point\\n Third key point"
   - Use for lists of features, benefits, items

3. Numbered lists (use 1. 2. 3.):
   - content: "1. First step or item\\n2. Second step or item\\n3. Third step or item"
   - Use for steps, processes, sequences, rankings

4. Mixed content (RECOMMENDED):
   - content: "Introduction paragraph explaining the topic in detail.\\n\\n Key feature one\\n Key feature two\\n Key feature three\\n\\nConclusion or summary paragraph."
   - Combine paragraphs with bullets for rich, varied content

CRITICAL: Vary content format across slides - don't use only bullet points! Mix paragraphs, bullets, and numbered lists.
- x: 120-150
- y: 180-200
- width: 450-550
- height: 300-400 (adjust based on content amount)
- size: 22-26
- color: "#374151"
- align: "left"

IMAGES:
- type: "image"
- imageUrl: Search term (e.g., "technology", "business", "team", "alexa")
- x: 550-600 (right side)
- y: 180-200
- width: 280-320
- height: 200-240

CHARTS:
- type: "chart"
- chartType: "bar", "line", or "pie"
- labels: ["Label1", "Label2", "Label3"]
- values: [value1, value2, value3]
- colors: ["#10b981", "#3b82f6", "#f59e0b"]
- x: 250-300
- y: 250-280
- width: 400-450
- height: 220-250

LAYOUT PATTERNS:
- Pattern 1 (with image): Title (action.title) + Bullets left (x:120, y:180) + Image right (x:550, y:180)
- Pattern 2 (simple): Title (action.title) + Bullets (x:120, y:180)
- Pattern 3 (with chart): Title (action.title) + Chart (x:250, y:250)

RESPONSE FORMAT (JSON ONLY):
{
  "actions": [
    {
      "type": "modify_slide",
      "slide": 0,
      "elements": [
        {"type": "text", "content": "Main Presentation Title", "x": 130, "y": 60, "width": 700, "height": 80, "size": 42, "color": "#0f172a", "weight": "bold", "align": "center"}
      ]
    },
    {
      "type": "add_slide",
      "title": "Introduction to Topic",
      "bg": "white",
      "elements": [
        {"type": "text", "content": "This is an introduction paragraph that explains the topic in detail. It provides comprehensive background information and context for the presentation.\\n\\n Key feature one with explanation\\n Key feature two with explanation\\n Key feature three with explanation\\n\\nIn conclusion, this topic is important because...", "x": 120, "y": 180, "width": 500, "height": 350, "size": 24, "color": "#374151", "align": "left"},
        {"type": "image", "imageUrl": "topic", "x": 550, "y": 180, "width": 300, "height": 220}
      ]
    },
    {
      "type": "add_slide",
      "title": "Process Steps",
      "bg": "white",
      "elements": [
        {"type": "text", "content": "The following steps outline the process:\\n\\n1. First step with detailed explanation\\n2. Second step with detailed explanation\\n3. Third step with detailed explanation\\n4. Fourth step with detailed explanation", "x": 120, "y": 180, "width": 500, "height": 350, "size": 24, "color": "#374151", "align": "left"}
      ]
    }
  ],
  "preview": "Creating slides",
  "slidesCount": 3,
  "message": "Creating slides..."
}

ACTION TYPES:
- "add_slide": Add a new slide
- "modify_slide": Modify existing slide (use slide: 0 for first slide)
- "add_text": Add text to specific slide
- "add_image": Add image to specific slide
- "add_chart": Add chart to specific slide

CONTENT VARIETY EXAMPLES:
- Slide 1: Paragraph + bullets
- Slide 2: Numbered list (1. 2. 3.)
- Slide 3: Paragraph only
- Slide 4: Bullets + paragraph
- Mix formats throughout the presentation!

REMEMBER: Always use bg: "white" for all slides. Never use colored backgrounds.`;

                    // Build messages array with conversation history
                    const messages = [
                        {
                            role: 'system',
                            content: systemMessage
                        }
                    ];

                    // Add conversation history (last 5 messages only to avoid token limit)
                    // Only include essential context, not full conversation
                    const recentHistory = this.aiConversationHistory.slice(-5);
                    recentHistory.forEach(msg => {
                        // Only add user messages and important assistant responses
                        if (msg.role === 'user' || (msg.role === 'assistant' && msg.content.length < 500)) {
                            messages.push(msg);
                        }
                    });

                    // Add current state and user request (simplified to save tokens)
                    const simplifiedState = {
                        totalSlides: currentState.totalSlides,
                        currentSlide: currentState.curr,
                        title: currentState.title,
                        firstSlideStyle: {
                            bg: currentState.firstSlideStyle?.bg || 'white',
                            titleStyle: currentState.titleStyle,
                            contentStyle: currentState.contentStyle
                        }
                    };
                    
                    const currentRequest = {
                        role: 'user',
                        content: `Presentation: ${simplifiedState.totalSlides} slides. Style: ${JSON.stringify(simplifiedState.firstSlideStyle)}. Request: ${message}${this.aiPendingSlidesCount ? ` (${this.aiPendingSlidesCount} slides)` : ''}`
                    };
                    messages.push(currentRequest);

                    // Call OpenAI API
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.getOpenAIKey()}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4',
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 2000
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || (this.aiLanguage === 'ar' ? '  API' : 'API Error'));
                    }

                    const aiResponse = data.choices[0].message.content;
                    
                    // Try to parse JSON from response
                    let actions = null;
                    let preview = null;
                    let slidesCount = null;
                    let responseMessage = aiResponse;
                    
                    try {
                        // Try multiple methods to extract JSON
                        // Method 1: Look for JSON code block
                        const codeBlockMatch = aiResponse.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                        if (codeBlockMatch) {
                            const parsed = JSON.parse(codeBlockMatch[1]);
                            if (parsed.actions) {
                                actions = parsed.actions;
                                preview = parsed.preview;
                                slidesCount = parsed.slidesCount;
                                responseMessage = parsed.message || aiResponse;
                            }
                        } else {
                            // Method 2: Look for JSON object directly
                            const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    const parsed = JSON.parse(jsonMatch[0]);
                                    if (parsed.actions && Array.isArray(parsed.actions)) {
                                        actions = parsed.actions;
                                        preview = parsed.preview;
                                        slidesCount = parsed.slidesCount;
                                        responseMessage = parsed.message || aiResponse;
                                    }
                                } catch (parseError) {
                                    console.log('JSON parse error:', parseError);
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Could not parse JSON, treating as plain text:', e);
                    }

                    // Add AI response to conversation history
                    this.aiConversationHistory.push({ role: 'assistant', content: aiResponse });

                    // If we have actions, execute them automatically
                    if (actions && Array.isArray(actions) && actions.length > 0) {
                        // Show message first
                        this.addChatMessage(responseMessage || 'Creating slides...', 'assistant');
                        
                        // Execute actions automatically
                        await this.executeAIActions(actions);
                        
                        // Show success message
                        const successMsg = this.aiLanguage === 'ar' ? 
                            `   ${actions.filter(a => a.type === 'add_slide').length}  !` : 
                            ` Successfully created ${actions.filter(a => a.type === 'add_slide').length} slide(s)!`;
                        this.addChatMessage(successMsg, 'assistant');
                    } else {
                        // Add AI response to chat
                        this.addChatMessage(responseMessage, 'assistant');
                        
                        // If asking about slides count, wait for user response
                        if (responseMessage.includes('') || responseMessage.includes('how many') || responseMessage.includes('How many')) {
                            // User will respond with number
                        }
                    }

                } catch (error) {
                    console.error('AI Error:', error);
                    const errorMsg = this.aiLanguage === 'ar' ? 
                        `  : ${error.message}` : 
                        `Sorry, an error occurred: ${error.message}`;
                    this.addChatMessage(errorMsg, 'assistant');
                } finally {
                    loadingEl.style.display = 'none';
                }
            },

            showAIPreview(actions, previewText) {
                const previewContainer = document.getElementById('aiPreviewContainer');
                previewContainer.style.display = 'block';
                
                // Count slides to be added
                const slidesToAdd = actions.filter(a => a.type === 'add_slide').length;
                const totalSlides = this.data.length + slidesToAdd;
                
                // Count elements
                let elementsCount = 0;
                actions.forEach(action => {
                    if (action.elements) {
                        elementsCount += action.elements.length;
                    } else if (action.type !== 'add_slide' && action.type !== 'set_slide_bg' && action.type !== 'switch_slide' && action.type !== 'delete_slide') {
                        elementsCount++;
                    }
                });
                
                const previewHTML = `
                    <div class="ai-message ai-assistant">
                        <div class="ai-message-content" style="background: #fef3c7; border: 2px solid #f59e0b;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;"> ${this.aiLanguage === 'ar' ? ' ' : 'Content Preview'}</div>
                            <div style="color: #78350f; margin-bottom: 12px; line-height: 1.6;">${previewText}</div>
                            <div style="padding: 12px; background: white; border-radius: 8px; margin-top: 12px; border: 1px solid #fbbf24;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #78350f;">${this.aiLanguage === 'ar' ? ':' : 'Details:'}</div>
                                <div style="color: #92400e; font-size: 13px; line-height: 1.8;">
                                    ${this.aiLanguage === 'ar' ? 
                                        `   ${slidesToAdd} ${slidesToAdd > 1 ? '' : ''}<br>
                                            : ${totalSlides}<br>
                                             : ${elementsCount + slidesToAdd}` :
                                        ` Will add ${slidesToAdd} slide${slidesToAdd > 1 ? 's' : ''}<br>
                                         Total slides after addition: ${totalSlides}<br>
                                         Number of elements to be added: ${elementsCount + slidesToAdd}`}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button onclick="app.confirmAIActions()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    ${this.aiLanguage === 'ar' ? '  ' : ' Confirm & Execute'}
                                </button>
                                <button onclick="app.cancelAIPreview()" style="flex: 1; padding: 12px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    ${this.aiLanguage === 'ar' ? ' ' : ' Cancel'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                previewContainer.innerHTML = previewHTML;
                
                // Scroll to preview
                setTimeout(() => {
                    previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
            },

            confirmAIActions() {
                if (this.aiPendingActions) {
                    this.executeAIActions(this.aiPendingActions);
                    this.cancelAIPreview();
                    
                    const confirmMsg = this.aiLanguage === 'ar' ? 
                        '    !' : 
                        ' Commands executed successfully!';
                    this.addChatMessage(confirmMsg, 'assistant');
                    // Add confirmation to conversation history
                    this.aiConversationHistory.push({ role: 'assistant', content: confirmMsg });
                }
            },

            cancelAIPreview() {
                const previewContainer = document.getElementById('aiPreviewContainer');
                previewContainer.style.display = 'none';
                previewContainer.innerHTML = '';
                this.aiPendingActions = null;
                this.aiPendingSlidesCount = null;
            },

            addChatMessage(message, type) {
                const messagesContainer = document.getElementById('aiChatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `ai-message ${type === 'user' ? 'user' : 'ai-assistant'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'ai-message-content';
                
                if (type === 'assistant') {
                    const header = document.createElement('div');
                    header.style.cssText = 'font-weight: 600; margin-bottom: 4px; color: #667eea;';
                    header.textContent = 'AI Assistant';
                    contentDiv.appendChild(header);
                }
                
                const textDiv = document.createElement('div');
                textDiv.textContent = message;
                contentDiv.appendChild(textDiv);
                
                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            },

            async executeAIActions(actions) {
                for (const action of actions) {
                    try {
                        switch (action.type) {
                            case 'add_slide':
                                this.addSlide();
                                const newSlideIndex = this.data.length - 1;
                                
                                // Use the same background as first slide
                                const firstSlideBg = this.data[0]?.bg || 'white';
                                this.data[newSlideIndex].bg = action.bg || firstSlideBg;
                                
                                // Check if title is already in elements
                                let hasTitleInElements = false;
                                if (action.elements && Array.isArray(action.elements)) {
                                    hasTitleInElements = action.elements.some(el => 
                                        el.type === 'text' && 
                                        (el.weight === 'bold' || el.size >= 36) &&
                                        el.align === 'center'
                                    );
                                }
                                
                                // Add title only if not already in elements
                                if (action.title && !hasTitleInElements) {
                                    // Get style from first slide
                                    const firstSlide = this.data[0] || { els: [] };
                                    let titleStyle = { size: 42, color: '#0f172a', weight: 'bold', align: 'center', font: 'Arial' };
                                    
                                    // Find title style from first slide
                                    firstSlide.els.forEach(el => {
                                        if (el.type === 'text' && (el.weight === 'bold' || el.size >= 36)) {
                                            titleStyle = {
                                                size: el.size || 42,
                                                color: el.color || '#0f172a',
                                                weight: el.weight || 'bold',
                                                align: el.align || 'center',
                                                font: el.font || 'Arial'
                                            };
                                        }
                                    });
                                    
                                    this.addTextElement(newSlideIndex, {
                                        content: action.title,
                                        x: 130,
                                        y: 60,
                                        width: 700,
                                        height: 80,
                                        size: titleStyle.size,
                                        color: titleStyle.color,
                                        weight: titleStyle.weight,
                                        align: titleStyle.align,
                                        font: titleStyle.font
                                    });
                                }
                                
                                // Add elements if provided
                                if (action.elements && Array.isArray(action.elements)) {
                                    for (let idx = 0; idx < action.elements.length; idx++) {
                                        const element = action.elements[idx];
                                        await new Promise(resolve => setTimeout(resolve, 100 * (idx + 1)));
                                        
                                        if (element.type === 'text') {
                                            // Skip if this is a duplicate title
                                            if (action.title && element.content === action.title && element.weight === 'bold') {
                                                continue;
                                            }
                                            
                                            // Get content style from first slide if not specified
                                            const firstSlide = this.data[0] || { els: [] };
                                            let defaultContentStyle = { size: 24, color: '#374151', align: 'left', font: 'Arial' };
                                            
                                            // Find content style from first slide
                                            firstSlide.els.forEach(el => {
                                                if (el.type === 'text' && el.weight !== 'bold' && el.size < 36) {
                                                    defaultContentStyle = {
                                                        size: el.size || 24,
                                                        color: el.color || '#374151',
                                                        align: el.align || 'left',
                                                        font: el.font || 'Arial'
                                                    };
                                                }
                                            });
                                            
                                            this.addTextElement(newSlideIndex, {
                                                content: element.content || 'New text',
                                                x: element.x || 120,
                                                y: element.y || (150 + idx * 60),
                                                width: element.width || 500,
                                                height: element.height || 200,
                                                size: element.size || defaultContentStyle.size,
                                                color: element.color || defaultContentStyle.color,
                                                weight: element.weight || 'normal',
                                                align: element.align || defaultContentStyle.align,
                                                font: element.font || defaultContentStyle.font
                                            });
                                        } else if (element.type === 'chart') {
                                            this.addChartElement(newSlideIndex, {
                                                chartType: element.chartType || 'bar',
                                                labels: element.labels || [],
                                                values: element.values || [],
                                                colors: element.colors || ['#10b981', '#3b82f6', '#f59e0b'],
                                                x: element.x || 250,
                                                y: element.y || 250,
                                                width: element.width || 450,
                                                height: element.height || 250
                                            });
                                        } else if (element.type === 'image') {
                                            // Get image from Unsplash or use placeholder
                                            let imageUrl = element.imageUrl || element.src;
                                            console.log('Processing image element, imageUrl:', imageUrl);
                                            
                                            if (typeof imageUrl === 'string' && !imageUrl.startsWith('http')) {
                                                // It's a search term, get image from Unsplash
                                                console.log('Getting image for search term:', imageUrl);
                                                imageUrl = await this.getImageFromUnsplash(imageUrl);
                                                console.log('Got image URL:', imageUrl);
                                            }
                                            
                                            if (imageUrl) {
                                                console.log('Adding image element with URL:', imageUrl);
                                                this.addImageElement(newSlideIndex, {
                                                    src: imageUrl,
                                                    x: element.x || 550,
                                                    y: element.y || 180,
                                                    width: element.width || 300,
                                                    height: element.height || 220
                                                });
                                            } else {
                                                console.warn('No image URL available, using fallback');
                                                // Use fallback
                                                this.addImageElement(newSlideIndex, {
                                                    src: `https://via.placeholder.com/${element.width || 300}x${element.height || 220}/667eea/ffffff?text=Image`,
                                                    x: element.x || 550,
                                                    y: element.y || 180,
                                                    width: element.width || 300,
                                                    height: element.height || 220
                                                });
                                            }
                                        }
                                    }
                                }
                                break;

                            case 'modify_slide':
                                const modifySlideIndex = action.slide !== undefined ? action.slide : 0;
                                if (this.data[modifySlideIndex]) {
                                    // Add elements to existing slide
                                    if (action.elements && Array.isArray(action.elements)) {
                                        for (let idx = 0; idx < action.elements.length; idx++) {
                                            const element = action.elements[idx];
                                            await new Promise(resolve => setTimeout(resolve, 100 * (idx + 1)));
                                            
                                            if (element.type === 'text') {
                                                // Get style from first slide
                                                const firstSlide = this.data[0] || { els: [] };
                                                let defaultStyle = { size: 24, color: '#374151', align: 'left', font: 'Arial' };
                                                
                                                // Check if it's a title
                                                if (element.weight === 'bold' || element.size >= 36) {
                                                    firstSlide.els.forEach(el => {
                                                        if (el.type === 'text' && (el.weight === 'bold' || el.size >= 36)) {
                                                            defaultStyle = {
                                                                size: el.size || 42,
                                                                color: el.color || '#0f172a',
                                                                weight: el.weight || 'bold',
                                                                align: el.align || 'center',
                                                                font: el.font || 'Arial'
                                                            };
                                                        }
                                                    });
                                                } else {
                                                    firstSlide.els.forEach(el => {
                                                        if (el.type === 'text' && el.weight !== 'bold' && el.size < 36) {
                                                            defaultStyle = {
                                                                size: el.size || 24,
                                                                color: el.color || '#374151',
                                                                align: el.align || 'left',
                                                                font: el.font || 'Arial'
                                                            };
                                                        }
                                                    });
                                                }
                                                
                                                this.addTextElement(modifySlideIndex, {
                                                    content: element.content || 'New text',
                                                    x: element.x || 130,
                                                    y: element.y || 60,
                                                    width: element.width || 700,
                                                    height: element.height || 80,
                                                    size: element.size || defaultStyle.size,
                                                    color: element.color || defaultStyle.color,
                                                    weight: element.weight || defaultStyle.weight || 'normal',
                                                    align: element.align || defaultStyle.align,
                                                    font: element.font || defaultStyle.font
                                                });
                                            } else if (element.type === 'image') {
                                                let imageUrl = element.imageUrl || element.src;
                                                if (typeof imageUrl === 'string' && !imageUrl.startsWith('http')) {
                                                    imageUrl = await this.getImageFromUnsplash(imageUrl);
                                                }
                                                if (imageUrl) {
                                                    this.addImageElement(modifySlideIndex, {
                                                        src: imageUrl,
                                                        x: element.x || 550,
                                                        y: element.y || 180,
                                                        width: element.width || 300,
                                                        height: element.height || 220
                                                    });
                                                }
                                            } else if (element.type === 'chart') {
                                                this.addChartElement(modifySlideIndex, {
                                                    chartType: element.chartType || 'bar',
                                                    labels: element.labels || [],
                                                    values: element.values || [],
                                                    colors: element.colors || ['#10b981', '#3b82f6', '#f59e0b'],
                                                    x: element.x || 250,
                                                    y: element.y || 250,
                                                    width: element.width || 450,
                                                    height: element.height || 250
                                                });
                                            }
                                        }
                                    }
                                }
                                break;

                            case 'add_text':
                                const slideIndex = action.slide !== undefined ? action.slide : this.curr;
                                this.addTextElement(slideIndex, {
                                    content: action.content || 'New text',
                                    x: action.x || 100,
                                    y: action.y || 100,
                                    width: action.width || 300,
                                    height: action.height || 50,
                                    size: action.size || 24,
                                    color: action.color || '#000000',
                                    weight: action.weight || 'normal',
                                    align: action.align || 'left',
                                    font: action.font || 'Arial'
                                });
                                break;

                            case 'add_chart':
                                const chartSlideIndex = action.slide !== undefined ? action.slide : this.curr;
                                this.addChartElement(chartSlideIndex, {
                                    chartType: action.chartType || 'bar',
                                    labels: action.labels || ['A', 'B', 'C'],
                                    values: action.values || [10, 20, 30],
                                    colors: action.colors || ['#10b981', '#3b82f6', '#f59e0b'],
                                    x: action.x || 200,
                                    y: action.y || 200,
                                    width: action.width || 400,
                                    height: action.height || 300
                                });
                                break;

                            case 'set_slide_bg':
                                const bgSlideIndex = action.slide !== undefined ? action.slide : this.curr;
                                if (this.data[bgSlideIndex]) {
                                    this.data[bgSlideIndex].bg = action.bg || 'white';
                                    this.saveState();
                                    this.loadCanvas();
                                }
                                break;

                            case 'switch_slide':
                                if (action.slide !== undefined && this.data[action.slide]) {
                                    this.switchSlide(action.slide);
                                }
                                break;

                            case 'delete_slide':
                                if (action.slide !== undefined && this.data[action.slide]) {
                                    this.deleteSlide(action.slide);
                                }
                                break;
                        }
                    } catch (error) {
                        console.error('Error executing action:', action, error);
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            },

            addTextElement(slideIndex, options) {
                if (!this.data[slideIndex]) return;
                
                const id = Date.now() + Math.random();
                const el = {
                    id: id,
                    type: 'text',
                    content: options.content || ' ',
                    x: options.x || 100,
                    y: options.y || 100,
                    width: options.width || 300,
                    height: options.height || 50,
                    font: options.font || 'Arial',
                    size: options.size || 24,
                    color: options.color || '#000000',
                    bg: options.bg || 'transparent',
                    weight: options.weight || 'normal',
                    align: options.align || 'left',
                    animation: 'none'
                };
                
                this.data[slideIndex].els.push(el);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            },

            addChartElement(slideIndex, options) {
                if (!this.data[slideIndex]) return;
                
                const id = Date.now() + Math.random();
                const el = {
                    id: id,
                    type: 'chart',
                    chartType: options.chartType || 'bar',
                    labels: options.labels || [],
                    values: options.values || [],
                    colors: options.colors || ['#10b981', '#3b82f6', '#f59e0b'],
                    x: options.x || 200,
                    y: options.y || 200,
                    width: options.width || 400,
                    height: options.height || 300,
                    animation: 'none'
                };
                
                this.data[slideIndex].els.push(el);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            },

            async getImageFromUnsplash(searchTerm) {
                try {
                    // Try to generate image using DALL-E API
                    console.log('Generating image for:', searchTerm);
                    
                    try {
                        const imageUrl = await this.generateImageWithDALLE(searchTerm);
                        if (imageUrl) {
                            console.log('Image generated successfully:', imageUrl);
                            return imageUrl;
                        }
                    } catch (dalleError) {
                        console.warn('DALL-E generation failed, using placeholder:', dalleError);
                    }
                    
                    // Fallback: Use placeholder.com with nice colors
                    const colors = ['667eea', '10b981', '3b82f6', 'f59e0b', 'ef4444', '8b5cf6', 'ec4899', '14b8a6'];
                    const seed = searchTerm.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const colorIndex = seed % colors.length;
                    const color = colors[colorIndex];
                    
                    const placeholderUrl = `https://via.placeholder.com/800x600/${color}/ffffff?text=${encodeURIComponent(searchTerm.substring(0, 20))}`;
                    return placeholderUrl;
                } catch (error) {
                    console.error('Error fetching image:', error);
                    return `https://via.placeholder.com/800x600/667eea/ffffff?text=Image`;
                }
            },

            async generateImageWithDALLE(prompt) {
                try {
                    // Generate image using DALL-E 3
                    const imagePrompt = `Professional, clean, modern presentation image about: ${prompt}. Suitable for business presentation, high quality, no text.`;
                    
                    const response = await fetch('https://api.openai.com/v1/images/generations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.getOpenAIKey()}`
                        },
                        body: JSON.stringify({
                            model: 'dall-e-3',
                            prompt: imagePrompt,
                            n: 1,
                            size: '1024x1024',
                            quality: 'standard'
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('DALL-E API error:', errorData);
                        // If DALL-E fails, try alternative method
                        return await this.getImageFromAlternativeSource(prompt);
                    }

                    const data = await response.json();
                    if (data.data && data.data[0] && data.data[0].url) {
                        return data.data[0].url;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error generating image with DALL-E:', error);
                    // Fallback to alternative source
                    return await this.getImageFromAlternativeSource(prompt);
                }
            },

            async getImageFromAlternativeSource(searchTerm) {
                try {
                    // Try using a proxy service or alternative image source
                    // Using a service that provides images based on search terms
                    
                    // Method 1: Try using Lorem Picsum with seed based on search term
                    const seed = searchTerm.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const picsumUrl = `https://picsum.photos/seed/${seed}/800/600`;
                    
                    // Test if it loads
                    return new Promise((resolve) => {
                        const testImg = new Image();
                        testImg.onload = () => resolve(picsumUrl);
                        testImg.onerror = () => {
                            // Fallback to placeholder
                            const colors = ['667eea', '10b981', '3b82f6', 'f59e0b'];
                            const colorIndex = seed % colors.length;
                            resolve(`https://via.placeholder.com/800x600/${colors[colorIndex]}/ffffff?text=${encodeURIComponent(searchTerm.substring(0, 15))}`);
                        };
                        testImg.src = picsumUrl;
                    });
                } catch (error) {
                    console.error('Error getting alternative image:', error);
                    // Final fallback
                    return `https://via.placeholder.com/800x600/667eea/ffffff?text=${encodeURIComponent(searchTerm)}`;
                }
            },

            addImageElement(slideIndex, options) {
                if (!this.data[slideIndex]) {
                    console.error('Slide index does not exist:', slideIndex);
                    return;
                }
                
                // Ensure we have a valid src
                if (!options.src || options.src.trim() === '') {
                    console.warn('No image src provided, using placeholder');
                    options.src = `https://via.placeholder.com/${options.width || 300}x${options.height || 200}/667eea/ffffff?text=Image`;
                }
                
                console.log('Adding image element to slide', slideIndex, 'with src:', options.src);
                
                const id = Date.now() + Math.random();
                const el = {
                    id: id,
                    type: 'image',
                    src: options.src,
                    x: options.x || 150,
                    y: options.y || 100,
                    width: options.width || 300,
                    height: options.height || 200,
                    animation: 'none'
                };
                
                this.data[slideIndex].els.push(el);
                console.log('Image element added, total elements:', this.data[slideIndex].els.length);
                this.saveState();
                this.loadCanvas();
                this.renderSlides();
            }
        };

        window.onload = async () => {
            app.init();
            
            // Load from Firebase if presentationId is in URL
            const urlParams = new URLSearchParams(window.location.search);
            const presentationId = urlParams.get('presentationId');
            
            if (presentationId && window.firebaseDb && window.currentUserId) {
                try {
                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const presentationRef = doc(window.firebaseDb, 'users', window.currentUserId, 'presentations', presentationId);
                    const presentationSnap = await getDoc(presentationRef);
                    
                    if (presentationSnap.exists()) {
                        const data = presentationSnap.data();
                        app.data = data.slides || app.data;
                        document.getElementById('title').value = data.title || '';
                        app.curr = 0;
                        // Store presentationId for future saves
                        app.currentPresentationId = presentationId;
                        app.saveState();
                        app.loadCanvas();
                        app.renderSlides();
                        app.showNotification('Presentation loaded from cloud');
                    } else {
                        app.showNotification('Presentation not found', 'error');
                    }
                } catch (error) {
                    console.error('Failed to load from Firebase:', error);
                    app.showNotification('Failed to load from cloud: ' + error.message, 'error');
                }
            }
            
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('data');
            if (shared) {
                try {
                    const d = JSON.parse(atob(shared));
                    app.data = d.slides;
                    document.getElementById('title').value = d.title || '';
                    app.renderSlides();
                    app.loadCanvas();
                    app.saveState();
                } catch (e) {
                    console.error('Failed to load shared presentation');
                }
            }

            // Close export menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.header-right')) {
                    document.getElementById('exportMenu').classList.remove('show');
                }
                
                // Close category dropdowns when clicking outside
                if (!e.target.closest('.dropdown-wrapper')) {
                    document.querySelectorAll('.category-dropdown').forEach(dd => {
                        dd.classList.remove('show');
                    });
                }
                
                // Close category panel when clicking outside
                if (!e.target.closest('.toolbar')) {
                    const panel = document.getElementById('categoryPanel');
                    const propertiesPanel = document.getElementById('propertiesPanel');
                    if (panel) panel.classList.remove('show');
                    document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
                    app.activeCategory = null;
                    // Remove padding from properties panel
                    if (propertiesPanel) {
                        propertiesPanel.classList.remove('category-panel-open');
                    }
                }
            });
        };
    </script>
<script>
(function () {
  let tipEl = null;
  let arrowEl = null;
  let activeTarget = null;

  function showTooltip(target) {
    const text = target.getAttribute('data-tooltip');
    if (!text) return;

    if (!tipEl) {
      tipEl = document.createElement('div');
      tipEl.className = 'js-tooltip';
      document.body.appendChild(tipEl);

      arrowEl = document.createElement('div');
      arrowEl.className = 'js-tooltip-arrow';
      document.body.appendChild(arrowEl);
    }

    tipEl.textContent = text;
    tipEl.style.display = 'block';
    arrowEl.style.display = 'block';

    positionTooltip(target);
    activeTarget = target;
  }

  function hideTooltip() {
    if (tipEl) tipEl.style.display = 'none';
    if (arrowEl) arrowEl.style.display = 'none';
    activeTarget = null;
  }

  function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

  function positionTooltip(target) {
    const rect = target.getBoundingClientRect();
    // Initial center above the target
    const centerX = rect.left + rect.width / 2;
    const topY = rect.top;

    // Measure tooltip size by temporarily showing it
    tipEl.style.visibility = 'hidden';
    tipEl.style.display = 'block';
    const tipWidth = tipEl.offsetWidth;
    const tipHeight = tipEl.offsetHeight;
    tipEl.style.visibility = '';
    // Compute final positions with viewport clamping
    const padding = 8;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const left = clamp(centerX, padding + tipWidth / 2, vw - padding - tipWidth / 2);
    let top = topY - padding - tipHeight;

    // If not enough space above, place below
    if (top < padding) {
      top = rect.bottom + padding + tipHeight; // place arrow below as well
      tipEl.style.transform = 'translate(-50%, -100%)'; // adjust transform to anchor below
      arrowEl.style.borderTopColor = 'transparent';
      arrowEl.style.borderBottomColor = '#1f2937';
      arrowEl.style.top = (rect.bottom + padding) + 'px';
    } else {
      tipEl.style.transform = 'translate(-50%, -6px)';
      arrowEl.style.borderBottomColor = 'transparent';
      arrowEl.style.borderTopColor = '#1f2937';
      arrowEl.style.top = (topY - padding) + 'px';
    }

    tipEl.style.left = left + 'px';
    tipEl.style.top = top + 'px';

    arrowEl.style.left = clamp(centerX, padding + 6, vw - padding - 6) + 'px';
  }

  // Delegate listeners
  document.addEventListener('mouseover', function (e) {
    const target = e.target.closest('[data-tooltip]');
    if (!target) return;
    showTooltip(target);
  });
  document.addEventListener('mouseout', function (e) {
    const related = e.relatedTarget;
    if (activeTarget && (!related || !related.closest('[data-tooltip]'))) {
      hideTooltip();
    }
  });
  document.addEventListener('mousemove', function () {
    if (activeTarget) positionTooltip(activeTarget);
  });
  window.addEventListener('scroll', function () {
    if (activeTarget) positionTooltip(activeTarget);
  }, true);
  window.addEventListener('resize', function () {
    if (activeTarget) positionTooltip(activeTarget);
  });
})();
</script></body>
</html>
