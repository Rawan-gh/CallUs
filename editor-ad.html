<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AD Template Editor · Presentation Maker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js'
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'

      const firebaseConfig = {
        apiKey: 'AIzaSyDPzRqV-_hGNedZoeGNtorLTGWTBMmqdkc',
        authDomain: 'prj-adc-gcp-coop-test.firebaseapp.com',
        projectId: 'prj-adc-gcp-coop-test',
        storageBucket: 'prj-adc-gcp-coop-test.firebasestorage.app',
        messagingSenderId: '472242813268',
        appId: '1:472242813268:web:4e7b4650015fd473d4f0c1',
        measurementId: 'G-RGEPGD1T9T',
      }

      const app = initializeApp(firebaseConfig)
      const analytics = getAnalytics(app)
      const db = getFirestore(app, 'bettercallus')
      const auth = getAuth(app)

      window.firebaseApp = app
      window.firebaseAnalytics = analytics
      window.firebaseDb = db
      window.firebaseAuth = auth

      const markLoggedOut = () => {
        localStorage.removeItem('pm-logged-in')
        localStorage.removeItem('pm-user-id')
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.currentUser = user
          localStorage.setItem('pm-logged-in', 'true')
          localStorage.setItem('pm-user-id', user.uid)
          if (user.email) {
            localStorage.setItem('pm-user-email', user.email)
          }
          if (user.displayName) {
            localStorage.setItem('pm-user-name', user.displayName)
          }
          window.dispatchEvent(new CustomEvent('pm-user-ready', { detail: { user } }))
        } else {
          window.currentUser = null
          markLoggedOut()
          if (localStorage.getItem('pm-logged-in') !== 'true') {
            window.location.replace('login.html')
          }
        }
      })

      console.log('Firebase initialized in editor with database: bettercallus')
    </script>
    <script>
      window.EDITOR_CONFIG = {
        templateKey: 'ad',
        initialVariants: ['ad'],
        newSlideVariant: 'ad',
      }
    </script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'ui-sans-serif', 'system-ui'],
            },
            colors: {
              emerald: {
                950: '#042f2e',
              },
            },
            boxShadow: {
              glow: '0 20px 60px -25px rgba(16, 185, 129, 0.45)',
            },
          },
        },
      }
    </script>
    <style>
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top left, rgba(16, 185, 129, 0.16), transparent 55%),
          radial-gradient(circle at top right, rgba(56, 189, 248, 0.15), transparent 45%),
          radial-gradient(circle at bottom, rgba(6, 95, 70, 0.15), transparent 60%);
        z-index: -2;
      }
      .category-panel {
        animation: fade-in 160ms ease;
      }
      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(-4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-emerald-50 text-slate-900 antialiased selection:bg-emerald-200/60 selection:text-emerald-950">
    <div class="relative">
      <div class="pointer-events-none absolute inset-0">
        <div class="absolute -left-32 top-24 h-72 w-72 rounded-full bg-emerald-400/20 blur-3xl"></div>
        <div class="absolute right-0 top-0 h-96 w-96 rounded-full bg-sky-300/20 blur-[140px]"></div>
        <div class="absolute -bottom-16 left-1/2 h-64 w-[26rem] -translate-x-1/2 rounded-full bg-emerald-500/10 blur-[120px]"></div>
      </div>

      <header class="sticky top-0 z-30 border-b border-white/60 bg-white/90 backdrop-blur-xl shadow-sm">
        <div class="mx-auto flex w-full max-w-7xl items-center justify-between pl-6 pr-0 py-4">
          <div class="flex items-center gap-3 -ml-24">
            <a href="templates.html" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-500 shadow-sm transition hover:-translate-y-0.5 hover:border-emerald-300 hover:text-emerald-600">
              ← Templates
            </a>
            <div class="flex items-center gap-2">
              <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" class="h-8 w-auto" />
              <span class="text-xs font-semibold uppercase tracking-[0.32em] text-slate-500">Presentation Lab</span>
            </div>
          </div>
          <div class="flex items-center gap-6 ml-auto">
            <div class="flex items-center gap-3">
              <div id="presence-avatars" class="flex -space-x-2"></div>
              <span id="presence-status" class="text-[0.65rem] font-medium uppercase tracking-[0.28em] text-slate-400">Live collaborators</span>
            </div>
            <div class="flex items-center gap-2 rounded-full border border-white/60 bg-white/80 px-3 py-1.5 text-xs text-slate-500 shadow-inner shadow-white/40">
              <span id="autosave-dot" class="inline-flex h-2 w-2 rounded-full bg-emerald-500"></span>
              <span id="autosave-status">Saved just now</span>
            </div>
            <div class="relative">
              <button id="version-toggle" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-slate-500 shadow-sm transition hover:-translate-y-0.5 hover:border-emerald-300 hover:text-emerald-600">
                Versions ▾
              </button>
              <div id="version-menu" class="absolute right-0 z-40 mt-2 w-56 hidden flex-col gap-1 rounded-2xl border border-slate-200 bg-white/95 p-2 text-sm shadow-xl shadow-slate-900/10">
                <p class="px-2 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-slate-400">History</p>
                <div id="version-list" class="flex flex-col gap-1"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="border-t border-white/70 bg-white/80 backdrop-blur">
          <div class="mx-auto flex w-full max-w-7xl items-center gap-2 pl-6 pr-0">
            <nav class="flex flex-1 items-center gap-1 py-2">
              <button data-category="text" class="category-tab group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 transition hover:bg-emerald-500/10 hover:text-emerald-600 focus-visible:outline focus-visible:outline-emerald-400">
                <span class="h-1.5 w-1.5 rounded-full bg-slate-300 transition group-hover:bg-emerald-500"></span>
                Text
              </button>
              <button data-category="shape" class="category-tab group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 transition hover:bg-emerald-500/10 hover:text-emerald-600 focus-visible:outline focus-visible:outline-emerald-400">
                <span class="h-1.5 w-1.5 rounded-full bg-slate-300 transition group-hover:bg-emerald-500"></span>
                Shape
              </button>
              <button data-category="image" class="category-tab group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 transition hover:bg-emerald-500/10 hover:text-emerald-600 focus-visible:outline focus-visible:outline-emerald-400">
                <span class="h-1.5 w-1.5 rounded-full bg-slate-300 transition group-hover:bg-emerald-500"></span>
                Image
              </button>
              <button data-category="media" class="category-tab group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 transition hover:bg-emerald-500/10 hover:text-emerald-600 focus-visible:outline focus-visible:outline-emerald-400">
                <span class="h-1.5 w-1.5 rounded-full bg-slate-300 transition group-hover:bg-emerald-500"></span>
                Media
              </button>
              <button data-category="arrange" class="category-tab group inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500 transition hover:bg-emerald-500/10 hover:text-emerald-600 focus-visible:outline focus-visible:outline-emerald-400">
                <span class="h-1.5 w-1.5 rounded-full bg-slate-300 transition group-hover:bg-emerald-500"></span>
                Arrange
              </button>
            </nav>
            <div class="flex items-center gap-2 py-2 ml-auto">
              <button class="rounded-full border border-emerald-200/70 bg-emerald-500 px-4 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-white shadow-md shadow-emerald-500/30 transition hover:-translate-y-0.5 hover:bg-emerald-400">
                Present
              </button>
              <button class="rounded-full border border-slate-200 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-slate-600 transition hover:-translate-y-0.5 hover:border-emerald-300 hover:text-emerald-600">
                Share
              </button>
            </div>
          </div>
          <div id="category-panel" class="category-panel hidden border-t border-white/60 bg-white/92 backdrop-blur-xl">
            <div class="mx-auto flex w-full max-w-7xl items-center justify-between gap-6 px-6 py-4 text-sm text-slate-600" data-panel-content></div>
          </div>
        </div>
      </header>

      <main class="mx-auto flex w-full max-w-[1500px] gap-6 px-4 pb-16 pt-6">
        <aside class="sticky top-32 h-[calc(100vh-8rem)] w-48 flex-shrink-0 rounded-3xl border border-white/70 bg-white/80 p-3 shadow-xl shadow-emerald-500/10 backdrop-blur">
          <div class="flex items-center justify-between px-2 pb-3">
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Slides</p>
            <button id="btn-add-slide" class="inline-flex h-7 w-7 items-center justify-center rounded-full border border-emerald-200 bg-emerald-500/90 text-white shadow-sm transition hover:bg-emerald-400" title="Add slide">+</button>
          </div>
          <div id="slides-list" class="space-y-2 overflow-y-auto pr-1">
            <!-- slides rendered here -->
          </div>
        </aside>

        <section class="flex flex-1 flex-col gap-4">
          <div class="rounded-3xl border border-white/60 bg-white/80 px-6 py-4 shadow-lg shadow-emerald-500/10 backdrop-blur">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-600">Presentation title</p>
                <h1 id="deck-title" contenteditable="true" class="mt-1 text-lg font-semibold text-slate-700 outline-none focus:text-emerald-600">New executive presentation</h1>
              </div>
              <div class="flex items-center gap-3">
                <div class="flex items-center gap-2 rounded-full border border-slate-200/80 bg-white/70 px-3 py-1 text-xs text-slate-500 shadow-inner">
                  <span class="inline-flex h-2 w-2 rounded-full bg-emerald-500"></span>
                  Slide <span id="slide-index-label" class="font-semibold text-slate-700">1</span>/<span id="slide-total-label">1</span>
                </div>
              </div>
            </div>
          </div>

          <div class="relative flex-1 rounded-[28px] bg-white/80 p-6 shadow-[0_30px_120px_-60px_rgba(15,23,42,0.45)] backdrop-blur">
            <div id="stage-stack" class="relative flex h-full flex-col gap-8 overflow-y-auto rounded-[22px] p-6 pr-4">
              <!-- slides rendered here -->
            </div>
          </div>

        </section>

        <aside class="sticky top-32 flex h-[calc(100vh-8rem)] w-56 flex-shrink-0 flex-col gap-3 rounded-3xl border border-white/70 bg-white/80 p-4 shadow-xl shadow-emerald-500/10 backdrop-blur">
          <div>
            <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Properties</p>
            <p class="mt-1 text-sm font-semibold text-slate-700">Smart suggestions</p>
          </div>
          <div class="flex flex-1 flex-col gap-3 overflow-y-auto text-sm text-slate-600">
            <div class="rounded-2xl border border-slate-200/80 bg-white/90 p-4 shadow-inner">
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-500">Layout tips</p>
              <ul class="mt-3 space-y-2 text-xs text-slate-500">
                <li>Align headline within safe area.</li>
                <li>Balance visuals across thirds.</li>
                <li>Keep body text under 5 lines.</li>
              </ul>
            </div>
            <div class="rounded-2xl border border-slate-200/80 bg-white/90 p-4 shadow-inner">
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-500">Theme accents</p>
              <div class="mt-3 flex items-center gap-2">
                <span class="h-7 w-7 rounded-lg bg-emerald-500/90 shadow-sm"></span>
                <span class="h-7 w-7 rounded-lg bg-sky-500/80 shadow-sm"></span>
                <span class="h-7 w-7 rounded-lg bg-slate-900/80 shadow-sm"></span>
                <span class="h-7 w-7 rounded-lg bg-emerald-100 shadow-sm"></span>
              </div>
            </div>
            <div class="rounded-2xl border border-slate-200/80 bg-white/90 p-4 shadow-inner">
              <p class="text-xs font-semibold uppercase tracking-[0.25em] text-emerald-500">Upcoming</p>
              <p class="mt-2 text-xs">Element-level controls will appear here as you start designing.</p>
            </div>
          </div>
        </aside>
      </main>
    </div>

    <script>
      const panelContent = document.querySelector('[data-panel-content]')
      const panelShell = document.getElementById('category-panel')
      const categoryTabs = document.querySelectorAll('.category-tab')

      const CATEGORY_CONTENT = {
        text: [
          { label: 'Font', control: '<select class="w-36 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"><option>Inter</option><option>Arial</option><option>Georgia</option><option>Poppins</option><option>IBM Plex Sans</option></select>' },
          { label: 'Size', control: '<input type="number" value="28" min="8" max="120" class="w-20 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" />' },
          { label: 'Weight', control: '<div class="flex gap-2"><button class="toolbar-chip" data-weight="400">Regular</button><button class="toolbar-chip active" data-weight="600">Bold</button><button class="toolbar-chip" data-weight="300">Light</button></div>' },
          { label: 'Color', control: '<input type="color" value="#0f766e" class="h-9 w-12 rounded-xl border border-slate-200 bg-white p-1" />' },
          { label: 'Align', control: '<div class="flex gap-2"><button class="toolbar-icon" title="Align left">⟸</button><button class="toolbar-icon" title="Align center">⇔</button><button class="toolbar-icon" title="Align right">⟹</button></div>' },
        ],
        shape: [
          { label: 'Library', control: '<div class="flex gap-2 flex-wrap max-w-xs"><button class="shape-pill">Rectangle</button><button class="shape-pill">Circle</button><button class="shape-pill">Triangle</button><button class="shape-pill">Diamond</button><button class="shape-pill">Arrow</button><button class="shape-pill">Line</button></div>' },
          { label: 'Fill', control: '<input type="color" value="#10b981" class="h-9 w-12 rounded-xl border border-slate-200 bg-white p-1" />' },
          { label: 'Stroke', control: '<div class="flex items-center gap-2"><input type="color" value="#0f172a" class="h-9 w-12 rounded-xl border border-slate-200 bg-white p-1" /><input type="number" value="2" min="0" max="12" class="w-16 rounded-xl border border-slate-200 bg-white px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" /></div>' },
        ],
        image: [
          { label: 'Source', control: '<div class="flex gap-2"><button class="rounded-xl border border-emerald-200 bg-emerald-500/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-white">Upload</button><button class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-xs font-semibold uppercase tracking-[0.25em] text-slate-500 hover:border-emerald-300 hover:text-emerald-600">Browse stock</button></div>' },
          { label: 'Adjust', control: '<div class="flex gap-3 text-xs uppercase tracking-[0.25em] text-slate-500"><span>Brightness</span><span>Contrast</span><span>Blur</span><span>Shadow</span></div>' },
          { label: 'Mask', control: '<div class="flex gap-2"><button class="shape-pill">Rounded</button><button class="shape-pill">Circle</button><button class="shape-pill">Diagonal</button></div>' },
        ],
        media: [
          { label: 'Insert', control: '<div class="flex gap-2 flex-wrap max-w-xs"><button class="shape-pill">Video</button><button class="shape-pill">Audio</button><button class="shape-pill">Lottie</button><button class="shape-pill">Chart</button><button class="shape-pill">Data Table</button></div>' },
          { label: 'Embed', control: '<input type="url" placeholder="Paste link" class="w-56 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400" />' },
        ],
        arrange: [
          { label: 'Order', control: '<div class="flex gap-2"><button class="shape-pill">Bring forward</button><button class="shape-pill">Send back</button><button class="shape-pill">Front</button><button class="shape-pill">Back</button></div>' },
          { label: 'Align', control: '<div class="flex gap-2"><button class="shape-pill">Left</button><button class="shape-pill">Center</button><button class="shape-pill">Right</button><button class="shape-pill">Top</button><button class="shape-pill">Middle</button><button class="shape-pill">Bottom</button></div>' },
          { label: 'Distribute', control: '<div class="flex gap-2"><button class="shape-pill">Horizontal</button><button class="shape-pill">Vertical</button></div>' },
        ],
      }

      const SLIDE_VARIANTS = {
        blank: {
          title: 'Blank slide',
          description: 'Start from scratch with a clean canvas.',
          stageHtml: `
            <div class="absolute inset-0 flex flex-col items-center justify-center bg-white">
              <div class="rounded-2xl border border-dashed border-slate-300 px-10 py-6 text-sm font-medium text-slate-400">Blank slide</div>
            </div>
          `,
          previewHtml: `
            <div class="absolute inset-0 rounded-lg bg-white"></div>
            <div class="absolute inset-0 flex items-center justify-center">
              <div class="rounded-lg border border-dashed border-slate-200 px-4 py-1.5 text-[0.55rem] font-medium text-slate-400">Blank</div>
            </div>
          `,
        },
        ad: {
          title: 'AD template',
          description: 'Aramco Digital branding with highlights and metrics.',
          stageHtml: `
            <div class="absolute inset-0 flex flex-col bg-white">
              <div class="flex items-center px-10 pt-8">
                <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" class="h-12 w-auto" />
              </div>
              <div class="flex-1 px-10 py-6">
                <div class="h-full w-full rounded-3xl border-2 border-dashed border-emerald-200/70 bg-white/80"></div>
              </div>
              <div class="h-2.5 w-full bg-gradient-to-r from-emerald-500 via-teal-400 to-sky-500"></div>
            </div>
          `,
          previewHtml: `
            <div class="absolute inset-0 rounded-lg bg-white"></div>
            <div class="absolute inset-x-0 top-2 flex items-center gap-1 px-2">
              <span class="inline-flex h-2.5 w-9 rounded-full bg-emerald-500/80"></span>
              <span class="inline-flex h-2 w-2 rounded-full bg-slate-200"></span>
            </div>
            <div class="absolute inset-x-0 top-6 px-2">
              <div class="h-14 w-full rounded-2xl border border-dashed border-emerald-200/70 bg-white/70"></div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 h-1.5 bg-gradient-to-r from-emerald-500 via-teal-400 to-sky-500"></div>
          `,
        },
        ai: {
          title: 'AI template',
          description: 'Futuristic insights with gradient overlays and metrics.',
          stageHtml: `
            <div class="absolute inset-0 overflow-hidden rounded-[14px]">
              <div class="absolute inset-0 bg-slate-950"></div>
              <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/40 via-slate-900/70 to-emerald-500/40"></div>
              <div class="absolute -top-10 -left-10 h-48 w-48 rounded-full bg-emerald-500/20 blur-3xl"></div>
              <div class="absolute -bottom-16 right-0 h-56 w-56 rounded-full bg-indigo-500/30 blur-3xl"></div>
              <div class="relative flex h-full flex-col justify-between p-10 text-white">
                <div class="flex items-start justify-between gap-6">
                  <div>
                    <p class="text-xs uppercase tracking-[0.4em] text-emerald-300">AI Insights</p>
                    <h2 class="mt-3 text-3xl font-semibold tracking-tight">Unlocking operational intelligence</h2>
                    <p class="mt-3 max-w-xl text-sm text-slate-200">Real-time analytics powering proactive decisions across energy, supply chain, and sustainability programs.</p>
                  </div>
                  <div class="flex gap-4">
                    <div class="rounded-2xl border border-white/20 bg-white/10 px-4 py-3 text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-200">Lead time</p>
                      <p class="text-2xl font-semibold">-27%</p>
                    </div>
                    <div class="rounded-2xl border border-emerald-300/20 bg-emerald-400/10 px-4 py-3 text-right">
                      <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-200">Accuracy</p>
                      <p class="text-2xl font-semibold">94%</p>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-4 text-sm">
                  <div class="rounded-2xl border border-white/15 bg-white/5 p-4">
                    <p class="text-xs uppercase tracking-[0.3em] text-emerald-200">Predict</p>
                    <p class="mt-2 text-lg font-semibold">Demand shifts</p>
                    <p class="mt-3 text-xs text-slate-200">Forecast 6 weeks ahead with adaptive AI models.</p>
                  </div>
                  <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <p class="text-xs uppercase tracking-[0.3em] text-sky-200">Automate</p>
                    <p class="mt-2 text-lg font-semibold">Core workflows</p>
                    <p class="mt-3 text-xs text-slate-200">Automated insights delivered directly to teams.</p>
                  </div>
                  <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
                    <p class="text-xs uppercase tracking-[0.3em] text-indigo-200">Scale</p>
                    <p class="mt-2 text-lg font-semibold">Intelligence</p>
                    <p class="mt-3 text-xs text-slate-200">Deploy safely across the enterprise in weeks.</p>
                  </div>
                </div>
              </div>
            </div>
          `,
          previewHtml: `
            <div class="absolute inset-0 rounded-lg bg-gradient-to-br from-indigo-600 via-slate-900 to-emerald-500"></div>
            <div class="absolute inset-0 opacity-30">
              <div class="absolute -top-3 left-2 h-8 w-8 rounded-full bg-emerald-400 blur-xl"></div>
              <div class="absolute bottom-1 right-1 h-9 w-9 rounded-full bg-indigo-500 blur-xl"></div>
            </div>
            <div class="absolute inset-0 flex flex-col justify-between p-2 text-[0.55rem] text-white">
              <div>
                <div class="h-2 w-20 rounded bg-white/40"></div>
                <div class="mt-1 h-1.5 w-16 rounded bg-white/30"></div>
              </div>
              <div class="grid grid-cols-3 gap-1 text-[0.5rem]">
                <span class="rounded border border-white/30 bg-white/10 px-1 py-0.5 text-center">Predict</span>
                <span class="rounded border border-white/20 bg-white/10 px-1 py-0.5 text-center">Automate</span>
                <span class="rounded border border-white/20 bg-white/10 px-1 py-0.5 text-center">Scale</span>
              </div>
            </div>
          `,
        },
      }

      let slideSequence = 0

      function createSlideFromVariant(variantKey = 'blank') {
        const variant = SLIDE_VARIANTS[variantKey] || SLIDE_VARIANTS.blank
        slideSequence += 1
        return {
          id: `slide-${slideSequence}`,
          variant: variantKey,
          title: variant.title,
          description: variant.description,
          stageHtml: variant.stageHtml,
          previewHtml: variant.previewHtml,
          notes: '',
          notesOpen: false,
        }
      }

      function getSlideStageHtml(slide = {}) {
        return slide.stageHtml || SLIDE_VARIANTS.blank.stageHtml
      }

      function getSlidePreviewHtml(slide = {}) {
        return slide.previewHtml || SLIDE_VARIANTS.blank.previewHtml
      }

      const EDITOR_CONFIG = window.EDITOR_CONFIG || {}
      const forcedTemplateKey = typeof EDITOR_CONFIG.templateKey === 'string' ? EDITOR_CONFIG.templateKey.toLowerCase() : ''
      const forcedSubject = typeof EDITOR_CONFIG.aiSubject === 'string' ? EDITOR_CONFIG.aiSubject.trim() : ''
      const forcedSlideCount = Number.isFinite(EDITOR_CONFIG.aiSlideCount) ? Number(EDITOR_CONFIG.aiSlideCount) : null
      const forcedInitialVariants = Array.isArray(EDITOR_CONFIG.initialVariants) && EDITOR_CONFIG.initialVariants.length
        ? EDITOR_CONFIG.initialVariants.map((variant) => String(variant).toLowerCase())
        : null
      const defaultNewSlideVariant = typeof EDITOR_CONFIG.newSlideVariant === 'string' && EDITOR_CONFIG.newSlideVariant.trim().length
        ? EDITOR_CONFIG.newSlideVariant.trim().toLowerCase()
        : 'blank'

      const urlParams = new URLSearchParams(window.location.search)

      function getActiveTemplateKey() {
        const templateKeyFromUrl = (urlParams.get('template') || '').toLowerCase()
        return forcedTemplateKey || templateKeyFromUrl
      }

      function resolveInitialSlideVariants() {
        if (forcedInitialVariants) {
          return [...forcedInitialVariants]
        }
        const templateKey = getActiveTemplateKey()
        if (templateKey === 'ai') {
          return ['ai', 'ad', 'blank']
        }
        if (templateKey === 'gradient' || templateKey === 'ad') {
          return ['ad', 'blank', 'ai']
        }
        return ['blank', 'ad', 'ai']
      }

      function renderPanel(category) {
        const items = CATEGORY_CONTENT[category]
        if (!items) return
        panelContent.innerHTML = items
          .map(
            (item) => `
              <div class="flex flex-col gap-1.5">
                <span class="text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-slate-400">${item.label}</span>
                ${item.control}
              </div>
            `
          )
          .join('')
      }

      let activeCategory = null

      categoryTabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const category = tab.dataset.category
          const isActive = activeCategory === category

          categoryTabs.forEach((button) => {
            button.classList.toggle('bg-emerald-500/10', button.dataset.category === category && !isActive)
            button.classList.toggle('text-emerald-600', button.dataset.category === category && !isActive)
            button.classList.toggle('ring-1', button.dataset.category === category && !isActive)
            button.classList.toggle('ring-emerald-500/40', button.dataset.category === category && !isActive)
          })

          if (isActive) {
            panelShell.classList.add('hidden')
            activeCategory = null
            return
          }

          renderPanel(category)
          panelShell.classList.remove('hidden')
          activeCategory = category
        })
      })

      document.addEventListener('click', (event) => {
        if (
          !panelShell.contains(event.target) &&
          !Array.from(categoryTabs).some((button) => button.contains(event.target))
        ) {
          panelShell.classList.add('hidden')
          activeCategory = null
          categoryTabs.forEach((button) => {
            button.classList.remove('bg-emerald-500/10', 'text-emerald-600', 'ring-1', 'ring-emerald-500/40')
          })
        }
      })

      const slidesList = document.getElementById('slides-list')
      const slideIndexLabel = document.getElementById('slide-index-label')
      const slideTotalLabel = document.getElementById('slide-total-label')
      const addSlideBtn = document.getElementById('btn-add-slide')
      const stageStack = document.getElementById('stage-stack')
      const autosaveStatus = document.getElementById('autosave-status')
      const autosaveDot = document.getElementById('autosave-dot')
      const versionToggle = document.getElementById('version-toggle')
      const versionMenu = document.getElementById('version-menu')
      const versionList = document.getElementById('version-list')
      const presenceAvatars = document.getElementById('presence-avatars')
      const presenceStatus = document.getElementById('presence-status')
      const deckTitle = document.getElementById('deck-title')

      const MAX_NOTES_LENGTH = 1000

      const DEFAULT_COLLABORATORS = []

      let currentUserCollaborator = null
      let activeCollaborators = []

      function deriveDisplayName(rawName = '', email = '') {
        if (rawName && rawName.trim().length) {
          return rawName.trim()
        }
        if (email && email.includes('@')) {
          return email
            .split('@')[0]
            .split(/[.\-_]+/)
            .filter(Boolean)
            .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase())
            .join(' ')
        }
        return 'Guest User'
      }

      function deriveInitials(name = '', email = '') {
        const fallback = email ? email.split('@')[0] || '' : ''
        const source = name && name.trim().length ? name : fallback
        if (!source.trim().length) {
          return 'ME'
        }
        const parts = source
          .replace(/[^A-Za-z0-9\s]/g, ' ')
          .trim()
          .split(/\s+/)
          .filter(Boolean)
        if (!parts.length) {
          return (source.replace(/[^A-Za-z0-9]/g, '').slice(0, 2) || 'ME').toUpperCase()
        }
        if (parts.length === 1) {
          return parts[0].slice(0, 2).toUpperCase()
        }
        return `${parts[0][0]}${parts[parts.length - 1][0]}`.toUpperCase()
      }

      function setCurrentUserCollaborator({ name = '', email = '' } = {}) {
        const displayName = deriveDisplayName(name, email)
        const initials = deriveInitials(displayName, email)
        currentUserCollaborator = {
          id: 'me',
          name: displayName,
          email,
          initials,
          role: 'editing',
          color: 'bg-emerald-500',
          presence: 'Editing',
        }
        activeCollaborators = [currentUserCollaborator]
        renderCollaborators()
      }

      function hydrateCollaboratorFromStorage() {
        try {
          const storedName = localStorage.getItem('pm-user-name') || ''
          const storedEmail = localStorage.getItem('pm-user-email') || ''
          if (storedName || storedEmail) {
            setCurrentUserCollaborator({ name: storedName, email: storedEmail })
          }
        } catch (error) {
          console.warn('Unable to hydrate collaborator from storage:', error)
        }
      }

      let autosaveTimer = null
      let autosaveContext = null
      let lastSavedAt = new Date()
      const versions = []

      const templateKey = getActiveTemplateKey()
      const aiSubjectParam = forcedSubject || (urlParams.get('subject') || '').trim()
      const requestedSlideCount = forcedSlideCount ?? parseInt(urlParams.get('slides') || '', 10)

      const initialSlideVariants = resolveInitialSlideVariants()
      const initialSlides = initialSlideVariants.map((variant) => createSlideFromVariant(variant))

      if (aiSubjectParam) {
        const aiSlide = initialSlides.find((slide) => slide.variant === 'ai')
        if (aiSlide) {
          aiSlide.description = `Focus: ${aiSubjectParam}`
        }
      }

      if (templateKey === 'ai' && Number.isFinite(requestedSlideCount)) {
        const constrainedCount = Math.min(Math.max(requestedSlideCount, 3), 12)
        while (initialSlides.length < constrainedCount) {
          initialSlides.push(createSlideFromVariant('blank'))
        }
      }

      const state = {
        slides: initialSlides,
        current: 0,
      }

      hydrateCollaboratorFromStorage()

      if (window.currentUser) {
        const existingUser = window.currentUser
        setCurrentUserCollaborator({
          name: existingUser.displayName || localStorage.getItem('pm-user-name') || '',
          email: existingUser.email || localStorage.getItem('pm-user-email') || '',
        })
      }

      window.addEventListener('pm-user-ready', (event) => {
        const user = event.detail?.user
        if (!user) return
        setCurrentUserCollaborator({
          name: user.displayName || localStorage.getItem('pm-user-name') || '',
          email: user.email || localStorage.getItem('pm-user-email') || '',
        })
      })

      function renderCollaborators() {
        if (!presenceAvatars) return
        const collaborators = activeCollaborators.filter(Boolean)
        if (!collaborators.length) {
          presenceAvatars.innerHTML = ''
          if (presenceStatus) {
            presenceStatus.textContent = 'Waiting for collaborator'
          }
          return
        }
        presenceAvatars.innerHTML = collaborators
          .map(
            (member) => `
            <span
              class="relative inline-flex h-8 w-8 items-center justify-center rounded-full border-2 border-white text-[0.7rem] font-semibold text-white ${member.color}"
              title="${member.email || member.name || member.initials}"
            >
              ${member.initials}
              <span class="absolute -bottom-1 right-0 inline-flex h-2 w-2 rounded-full ${
                member.role === 'editing'
                  ? 'bg-emerald-400'
                  : member.role === 'design'
                    ? 'bg-sky-400'
                    : 'bg-slate-300'
              }"></span>
            </span>
          `
          )
          .join('')
        if (presenceStatus) {
          const count = collaborators.length
          presenceStatus.textContent = count === 1 ? '1 collaborating' : `${count} collaborating`
        }
      }

      function formatRelativeTime(date) {
        if (!date) return 'just now'
        const diff = Math.floor((Date.now() - date.getTime()) / 1000)
        if (diff < 5) return 'just now'
        if (diff < 60) return `${diff}s ago`
        const minutes = Math.floor(diff / 60)
        if (minutes < 60) return `${minutes}m ago`
        const hours = Math.floor(minutes / 60)
        if (hours < 24) return `${hours}h ago`
        return date.toLocaleDateString()
      }

      function addVersion(reason, timestamp) {
        versions.unshift({
          id: `ver-${timestamp.getTime()}`,
          reason,
          timestamp,
          label: timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        })
        if (versions.length > 8) versions.pop()
        renderVersionList()
      }

      function renderVersionList() {
        if (!versionList) return
        if (!versions.length) {
          versionList.innerHTML = `<p class="px-2 py-2 text-[0.65rem] uppercase tracking-[0.28em] text-slate-400">No versions yet</p>`
          return
        }
        versionList.innerHTML = versions
          .map(
            (version) => `
              <button data-version="${version.id}" class="flex flex-col gap-0.5 rounded-xl border border-transparent px-3 py-2 text-left text-xs text-slate-600 transition hover:border-emerald-200 hover:bg-emerald-50/80">
                <span class="text-[0.7rem] font-semibold text-slate-700">${version.label}</span>
                <span class="text-[0.6rem] uppercase tracking-[0.25em] text-slate-400">${version.reason}</span>
              </button>
            `
          )
          .join('')
      }

      function setAutosaveState(state) {
        if (!autosaveStatus || !autosaveDot) return
        if (state === 'saving') {
          autosaveStatus.textContent = 'Saving…'
          autosaveDot.className = 'inline-flex h-2 w-2 rounded-full bg-amber-400 animate-pulse'
        } else {
          autosaveStatus.textContent = `Saved ${formatRelativeTime(lastSavedAt)}`
          autosaveDot.className = 'inline-flex h-2 w-2 rounded-full bg-emerald-500'
        }
      }

      function scheduleAutosave({ reason = 'Updated presentation', context = null } = {}) {
        if (autosaveTimer) {
          clearTimeout(autosaveTimer)
        }
        autosaveContext = context
        setAutosaveState('saving')
        autosaveTimer = setTimeout(() => {
          lastSavedAt = new Date()
          setAutosaveState('saved')
          addVersion(reason, lastSavedAt)
          autosaveContext = null
        }, 900)
      }

      function escapeHtml(text = '') {
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;')
      }

      function renderSlides() {
        slideTotalLabel.textContent = state.slides.length
        slideIndexLabel.textContent = state.current + 1

        slidesList.innerHTML = state.slides
          .map(
            (slide, index) => `
              <button
                data-slide="${slide.id}"
                class="group flex w-full flex-col gap-2 rounded-xl border ${
                  index === state.current
                    ? 'border-emerald-400/70 bg-emerald-50/60 shadow-lg shadow-emerald-500/15'
                    : 'border-slate-200/80 bg-white shadow-sm'
                } p-2.5 text-left transition hover:-translate-y-1 hover:border-emerald-300 hover:bg-emerald-50/70"
              >
                <div class="flex items-center justify-between text-[0.6rem] font-semibold uppercase tracking-[0.28em] text-slate-400">
                  <span>Slide ${String(index + 1).padStart(2, '0')}</span>
                </div>
                <div class="relative aspect-[16/10] w-full overflow-hidden rounded-lg border border-slate-200 bg-white shadow-[0_6px_12px_-10px_rgba(15,23,42,0.45)]">
                  ${getSlidePreviewHtml(slide)}
                </div>
                <div class="flex flex-col gap-1 px-0.5">
                  <h4 class="text-[0.7rem] font-semibold text-slate-700 line-clamp-2">${escapeHtml(slide.title || 'Blank slide')}</h4>
                  <p class="text-[0.55rem] text-slate-400 line-clamp-3">${escapeHtml(slide.description || '')}</p>
                </div>
              </button>
            `
          )
          .join('')

        renderStageStack()
      }

      slidesList.addEventListener('click', (event) => {
        const button = event.target.closest('[data-slide]')
        if (!button) return
        const slideId = button.dataset.slide
        const nextIndex = state.slides.findIndex((slide) => slide.id === slideId)
        if (nextIndex === -1) return
        state.current = nextIndex
        renderSlides()
      })

      addSlideBtn.addEventListener('click', () => {
        const index = state.slides.length
        state.slides.push(createSlideFromVariant(defaultNewSlideVariant))
        state.current = state.slides.length - 1
        renderSlides()
        scheduleAutosave({ reason: 'Added slide', context: 'structure' })
      })

      function renderStageStack() {
        if (!stageStack) return
        const totalSlides = state.slides.length
        stageStack.innerHTML = state.slides
          .map(
            (slide, index) => `
              <article
                data-stack-slide="${slide.id}"
                class="group relative w-full rounded-[18px] border ${
                  index === state.current
                    ? 'border-emerald-300 bg-white shadow-[0_40px_120px_-60px_rgba(16,185,129,0.55)]'
                    : 'border-slate-200/70 bg-white shadow-[0_30px_90px_-70px_rgba(15,23,42,0.28)]'
                } p-4 transition hover:-translate-y-1 hover:border-emerald-200"
              >
                <div class="relative overflow-hidden rounded-[14px] bg-white shadow-[0_18px_60px_-50px_rgba(15,23,42,0.35)] transition group-hover:shadow-[0_22px_70px_-40px_rgba(16,185,129,0.45)]">
                  <div class="relative aspect-[16/9] w-full overflow-hidden">
                    <div class="absolute inset-0 bg-white"></div>
                    ${getSlideStageHtml(slide)}
                  </div>
                </div>
                <span class="pointer-events-none absolute right-8 top-6 rounded-full border border-slate-200 bg-white/80 px-3 py-1 text-[0.55rem] font-semibold uppercase tracking-[0.32em] text-slate-400 opacity-0 transition group-hover:opacity-70">
                  Click to focus
                </span>
                <div class="mt-3 flex items-center justify-between px-2 text-[0.6rem] font-semibold uppercase tracking-[0.28em] text-slate-400">
                  <span>Slide ${String(index + 1).padStart(2, '0')}</span>
                  <div class="flex items-center gap-2">
                    ${
                      slide.notes && slide.notes.trim().length
                        ? '<span class="rounded-full border border-emerald-200 bg-emerald-50 px-2 py-0.5 text-[0.55rem] font-semibold uppercase tracking-[0.3em] text-emerald-500">Notes</span>'
                        : ''
                    }
                    <span>${totalSlides} total</span>
                  </div>
                </div>
                <div class="mt-3 rounded-2xl border border-slate-200/80 bg-white/90 p-4 shadow-inner">
                  <div class="flex items-center justify-between">
                    <button data-notes-toggle="${slide.id}" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.25em] text-slate-500 transition hover:border-emerald-300 hover:text-emerald-600">
                      ${slide.notesOpen ? 'Hide notes' : slide.notes && slide.notes.trim().length ? 'Edit notes' : 'Add notes'}
                    </button>
                    <span class="text-[0.6rem] uppercase tracking-[0.25em] text-slate-400">${slide.notes.trim().length ? 'Private' : 'No notes yet'}</span>
                  </div>
                  <div class="${slide.notesOpen ? 'mt-3 flex flex-col gap-2' : 'hidden'}">
                    <textarea
                      data-notes-input="${slide.id}"
                      rows="5"
                      class="w-full resize-none rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm outline-none transition focus:border-emerald-400 focus:ring-2 focus:ring-emerald-200"
                      maxlength="${MAX_NOTES_LENGTH}"
                      placeholder="Type presenter notes for this slide…"
                    >${escapeHtml(slide.notes)}</textarea>
                    <div data-notes-count="${slide.id}" class="flex items-center justify-between text-[0.6rem] uppercase tracking-[0.22em] text-slate-400">
                      <span>Visible only to presenters</span>
                      <span>${(slide.notes || '').length} / ${MAX_NOTES_LENGTH}</span>
                    </div>
                  </div>
                </div>
              </article>
            `
          )
          .join('')
      }

      stageStack?.addEventListener('click', (event) => {
        const toggle = event.target.closest('[data-notes-toggle]')
        if (toggle) {
          event.stopPropagation()
          const slideId = toggle.dataset.notesToggle
          const slide = state.slides.find((entry) => entry.id === slideId)
          if (!slide) return
          slide.notesOpen = !slide.notesOpen
          renderSlides()
          const article = stageStack.querySelector(`[data-stack-slide="${slideId}"]`)
          article?.scrollIntoView({ behavior: 'smooth', block: 'start' })
          return
        }

        const article = event.target.closest('[data-stack-slide]')
        if (!article) return
        const slideId = article.dataset.stackSlide
        const nextIndex = state.slides.findIndex((slide) => slide.id === slideId)
        if (nextIndex === -1) return
        state.current = nextIndex
        renderSlides()
        article.scrollIntoView({ behavior: 'smooth', block: 'center' })
      })

      stageStack?.addEventListener(
        'blur',
        (event) => {
          if (event.target.matches('textarea[data-notes-input]')) {
            renderSlides()
          }
        },
        true
      )

      stageStack?.addEventListener('input', (event) => {
        const textarea = event.target.closest('textarea[data-notes-input]')
        if (!textarea) return
        const slideId = textarea.dataset.notesInput
        const slideIndex = state.slides.findIndex((entry) => entry.id === slideId)
        if (slideIndex === -1) return
        const slide = state.slides[slideIndex]
        if (!slide) return
        if (textarea.value.length > MAX_NOTES_LENGTH) {
          textarea.value = textarea.value.slice(0, MAX_NOTES_LENGTH)
        }
        slide.notes = textarea.value
        const counterWrap = stageStack.querySelector(`[data-notes-count="${slideId}"]`)
        if (counterWrap) {
          const valueEl = counterWrap.querySelector('span:last-child')
          if (valueEl) {
            valueEl.textContent = `${slide.notes.length} / ${MAX_NOTES_LENGTH}`
          }
        }
        scheduleAutosave({ reason: `Updated notes for slide ${slideIndex + 1}`, context: 'notes' })
      })

      // Utility classes for panel buttons
      const style = document.createElement('style')
      style.textContent = `
        .toolbar-chip {
          @apply rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-[0.25em] text-slate-500 shadow-sm shadow-white/60 transition hover:border-emerald-400 hover:text-emerald-600;
        }
        .toolbar-chip.active {
          @apply border-emerald-400 bg-emerald-500/10 text-emerald-600;
        }
        .toolbar-icon {
          @apply inline-flex h-8 w-8 items-center justify-center rounded-full border border-slate-200 bg-white text-xs font-semibold text-slate-500 shadow-sm transition hover:border-emerald-400 hover:text-emerald-600;
        }
        .shape-pill {
          @apply rounded-full border border-slate-200 bg-white/90 px-3 py-1.5 text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-slate-500 shadow-sm transition hover:border-emerald-400 hover:text-emerald-600;
        }
      `
      versionToggle?.addEventListener('click', (event) => {
        event.stopPropagation()
        versionMenu?.classList.toggle('hidden')
      })

      versionList?.addEventListener('click', (event) => {
        const button = event.target.closest('[data-version]')
        if (!button) return
        const version = versions.find((entry) => entry.id === button.dataset.version)
        versionMenu?.classList.add('hidden')
        if (version) {
          window.alert(`Version restore coming soon.\nSaved at ${version.label} – ${version.reason}.`)
        }
      })

      document.addEventListener('click', (event) => {
        if (!versionMenu || versionMenu.classList.contains('hidden')) return
        if (event.target === versionToggle) return
        if (versionMenu.contains(event.target)) return
        versionMenu.classList.add('hidden')
      })

      deckTitle?.addEventListener('input', () => {
        scheduleAutosave({ reason: 'Updated presentation title', context: 'title' })
      })

      document.head.appendChild(style)

      renderCollaborators()
      setAutosaveState('saved')
      addVersion('Initial snapshot', lastSavedAt)
      renderSlides()
    </script>
  </body>
</html>


