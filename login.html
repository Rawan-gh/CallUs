<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Presentation Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyDPzRqV-_hGNedZoeGNtorLTGWTBMmqdkc",
        authDomain: "prj-adc-gcp-coop-test.firebaseapp.com",
        projectId: "prj-adc-gcp-coop-test",
        storageBucket: "prj-adc-gcp-coop-test.firebasestorage.app",
        messagingSenderId: "472242813268",
        appId: "1:472242813268:web:4e7b4650015fd473d4f0c1",
        measurementId: "G-RGEPGD1T9T"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app, 'bettercallus');
      const auth = getAuth(app);
      
      // Make available globally
      window.firebaseApp = app;
      window.firebaseAnalytics = analytics;
      window.firebaseDb = db;
      window.firebaseAuth = auth;
      console.log('Firebase initialized in login with database: bettercallus');
    </script>
  </head>
  <body class="bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900 antialiased font-sans">
    <div class="relative min-h-screen flex flex-col">
      <div class="pointer-events-none absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -left-32 h-96 w-96 rounded-full bg-emerald-400/20 blur-3xl"></div>
        <div class="absolute top-10 right-0 h-72 w-72 rounded-full bg-sky-400/20 blur-3xl"></div>
      </div>
      <header class="relative z-10 border-b border-white/60 bg-white/90 backdrop-blur">
        <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-4">
          <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:50px;" />
          <p class="hidden sm:block text-xs uppercase tracking-[0.3em] text-emerald-600">Secure access</p>
        </div>
      </header>

      <main class="relative z-10 flex-1 flex items-center justify-center px-4 py-12">
        <div class="w-full max-w-md space-y-6 rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-xl shadow-emerald-500/10 backdrop-blur">
          <div class="space-y-2 text-center">
            <h1 class="text-2xl font-semibold tracking-tight">Sign in to Presentation Maker</h1>
            <p class="text-sm text-slate-500">Access templates and continue your decks.</p>
          </div>
          <form class="space-y-4" onsubmit="handleLogin(event)">
            <div>
              <label class="block text-sm font-medium text-slate-700" for="email">Email</label>
              <input id="email" type="text" required class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="you@aramcodigital.com" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700" for="password">Password</label>
              <input id="password" type="password" required class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="••••••••" />
            </div>
            <button type="submit" class="w-full inline-flex items-center justify-center rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 transition hover:-translate-y-0.5 hover:bg-emerald-500">Sign in</button>
            <a href="index.html" class="w-full inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-emerald-400 hover:text-emerald-600">Back to home</a>
          </form>
          <p class="text-xs text-slate-500 text-center">Having trouble? Contact the communications team.</p>
        </div>
      </main>

      <footer class="relative z-10 border-t border-white/60 bg-white/80 backdrop-blur">
        <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-4 text-xs text-slate-400">
          <span>Rawan • Hadeel • Renad</span>
          <span>© <span id="year"></span> Presentation Maker · Dhahran</span>
        </div>
      </footer>
    </div>

    <script type="module">
      import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      import { doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

      function formatNameFromEmail(emailValue) {
        if (!emailValue) return null
        const localPart = emailValue.split('@')[0] || ''
        if (!localPart) return null

        return localPart
          .split(/[.\-_]+/)
          .filter(Boolean)
          .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase())
          .join(' ')
      }

      async function handleLogin(event) {
        event.preventDefault()
        const emailInput = document.getElementById('email')
        const passwordInput = document.getElementById('password')
        const email = emailInput.value.trim()
        const password = passwordInput.value
        const submitBtn = event.target.querySelector('button[type="submit"]')
        
        if (!email || !password) {
          alert('Please enter both email and password')
          return
        }

        // Disable button and show loading
        submitBtn.disabled = true
        submitBtn.textContent = 'Signing in...'

        try {
          const auth = window.firebaseAuth
          const db = window.firebaseDb
          
          let userCredential
          let isNewUser = false

          // Try to sign in first
          try {
            userCredential = await signInWithEmailAndPassword(auth, email, password)
          } catch (signInError) {
            // If user doesn't exist, create new account
            if (signInError.code === 'auth/user-not-found') {
              userCredential = await createUserWithEmailAndPassword(auth, email, password)
              isNewUser = true
            } else {
              throw signInError
            }
          }

          const user = userCredential.user
          const formattedName = formatNameFromEmail(email)

          // Save user data to Firestore
          const userRef = doc(db, 'users', user.uid)
          
          // Check if user document already exists
          const userDoc = await getDoc(userRef)
          const userExists = userDoc.exists()
          
          const userData = {
            email: user.email,
            displayName: formattedName || user.email.split('@')[0],
            lastLogin: serverTimestamp(),
            updatedAt: serverTimestamp()
          }

          // If user exists, preserve createdAt; if new, set createdAt
          if (isNewUser || !userExists) {
            userData.createdAt = serverTimestamp()
            await setDoc(userRef, userData)
            console.log('New user account created in Firestore')
          } else {
            // Update existing user's lastLogin, preserve createdAt
            await setDoc(userRef, {
              ...userData,
              createdAt: userDoc.data().createdAt // Preserve original creation time
            }, { merge: true })
            console.log('User signed in, updated Firestore')
          }

          // Store user info in localStorage for quick access
          localStorage.setItem('pm-logged-in', 'true')
          localStorage.setItem('pm-user-id', user.uid)
          localStorage.setItem('pm-user-email', user.email)
          if (formattedName) {
            localStorage.setItem('pm-user-name', formattedName)
          }

          // Redirect to templates
          window.location.href = 'templates.html'
        } catch (error) {
          console.error('Authentication error:', error)
          let errorMessage = 'Sign in failed. Please try again.'
          
          if (error.code === 'auth/weak-password') {
            errorMessage = 'Password should be at least 6 characters.'
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Invalid email address.'
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Incorrect password.'
          } else if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'This email is already registered. Please sign in instead.'
          }
          
          alert(errorMessage)
          submitBtn.disabled = false
          submitBtn.textContent = 'Sign in'
        }
      }

      // Make handleLogin available globally
      window.handleLogin = handleLogin
      document.getElementById('year').textContent = new Date().getFullYear()
    </script>
  </body>
</html>


