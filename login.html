<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Presentation Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
      import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
      
      const firebaseConfig = {
        apiKey: "AIzaSyDPzRqV-_hGNedZoeGNtorLTGWTBMmqdkc",
        authDomain: "prj-adc-gcp-coop-test.firebaseapp.com",
        projectId: "prj-adc-gcp-coop-test",
        storageBucket: "prj-adc-gcp-coop-test.firebasestorage.app",
        messagingSenderId: "472242813268",
        appId: "1:472242813268:web:4e7b4650015fd473d4f0c1",
        measurementId: "G-RGEPGD1T9T"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app, 'bettercallus');
      const auth = getAuth(app);
      
      // Make available globally
      window.firebaseApp = app;
      window.firebaseAnalytics = analytics;
      window.firebaseDb = db;
      window.firebaseAuth = auth;
      console.log('Firebase initialized in login with database: bettercallus');
    </script>
  </head>
  <body class="bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900 antialiased font-sans">
    <div class="relative min-h-screen flex flex-col">
      <div class="pointer-events-none absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -left-32 h-96 w-96 rounded-full bg-emerald-400/20 blur-3xl"></div>
        <div class="absolute top-10 right-0 h-72 w-72 rounded-full bg-sky-400/20 blur-3xl"></div>
      </div>
      <header class="relative z-10 border-b border-white/60 bg-white/90 backdrop-blur">
        <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-4">
          <img src="assets/aramco-digital-logo.png" alt="Aramco Digital" style="width:auto; height:50px;" />
          <p class="hidden sm:block text-xs uppercase tracking-[0.3em] text-emerald-600">Secure access</p>
        </div>
      </header>

      <main class="relative z-10 flex-1 flex items-center justify-center px-4 py-12">
        <div class="w-full max-w-md space-y-6 rounded-3xl border border-slate-200 bg-white/80 p-8 shadow-xl shadow-emerald-500/10 backdrop-blur">
          <div class="space-y-4 text-center">
            <div class="space-y-2">
              <h1 class="text-2xl font-semibold tracking-tight" data-auth-title>Sign in to Presentation Maker</h1>
              <p class="text-sm text-slate-500" data-auth-subtitle>Access templates and continue your decks.</p>
            </div>
            <div class="inline-flex w-full max-w-sm overflow-hidden rounded-full border border-emerald-200 bg-white p-1 text-sm shadow-sm">
              <button type="button" data-auth-toggle="sign-in" class="flex-1 rounded-full bg-emerald-600 px-4 py-2 font-semibold text-white shadow transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-500" aria-pressed="true">Sign in</button>
              <button type="button" data-auth-toggle="sign-up" class="flex-1 rounded-full px-4 py-2 font-semibold text-emerald-600 transition hover:text-emerald-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-500" aria-pressed="false">Create account</button>
            </div>
          </div>
          <div class="mt-4 hidden rounded-xl border px-4 py-3 text-sm" data-auth-message role="alert">
            <div class="flex items-start gap-2">
              <span class="mt-1 h-2 w-2 rounded-full" data-auth-message-indicator></span>
              <span class="text-left" data-auth-message-text></span>
            </div>
          </div>
          <form class="space-y-4" data-auth-form onsubmit="handleLogin(event)">
            <div>
              <label class="block text-sm font-medium text-slate-700" for="email">Email</label>
              <input id="email" type="text" required class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="you@aramcodigital.com" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700" for="password">Password</label>
              <div class="mt-1 relative">
                <input id="password" type="password" required class="w-full rounded-md border border-slate-300 px-3 py-2 pr-10 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="••••••••" />
                <button type="button" class="absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 hover:text-emerald-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white" data-password-toggle aria-label="Show password" title="Show password">
                  <span class="sr-only">Toggle password visibility</span>
                  <svg data-eye-open xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12C3.75 7.5 7.5 4.5 12 4.5s8.25 3 9.75 7.5c-1.5 4.5-5.25 7.5-9.75 7.5s-8.25-3-9.75-7.5Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z" />
                  </svg>
                  <svg data-eye-closed xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223C2.676 9.553 1.706 11.162 1.5 12c1.5 4.5 5.25 7.5 9.75 7.5 1.559 0 3.046-.33 4.406-.933M6.228 6.228C7.827 5.06 9.82 4.5 12 4.5c4.5 0 8.25 3 9.75 7.5-.331.993-.82 1.95-1.44 2.82M6.228 6.228 3 3m3.228 3.228 3.128 3.128m8.416 8.416L21 21m-3.228-3.228-3.128-3.128m0 0A3.75 3.75 0 0 0 9.75 9.75" />
                  </svg>
                </button>
              </div>
            </div>
            <button type="submit" data-auth-submit class="w-full inline-flex items-center justify-center rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-500/30 transition hover:-translate-y-0.5 hover:bg-emerald-500">Sign in</button>
            <a href="index.html" class="w-full inline-flex items-center justify-center rounded-full border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-600 shadow-sm transition hover:border-emerald-400 hover:text-emerald-600">Back to home</a>
          </form>
          <p class="text-xs text-slate-500 text-center">Having trouble? Contact the communications team.</p>
        </div>
      </main>

      <footer class="relative z-10 border-t border-white/60 bg-white/80 backdrop-blur">
        <div class="mx-auto flex max-w-5xl items-center justify-between px-4 py-4 text-xs text-slate-400">
          <span>Rawan • Hadeel • Renad</span>
          <span>© <span id="year"></span> Presentation Maker · Dhahran</span>
        </div>
      </footer>
    </div>

    <script type="module">
      import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'
      import { doc, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'

      const AUTH_COPY = {
        'sign-in': {
          title: 'Sign in to Presentation Maker',
          subtitle: 'Access templates and continue your decks.',
          submitLabel: 'Sign in',
          loadingLabel: 'Signing in...'
        },
        'sign-up': {
          title: 'Create your Presentation Maker account',
          subtitle: 'Securely store your presentations and pick up where you left off.',
          submitLabel: 'Create account',
          loadingLabel: 'Creating account...'
        }
      }

      const MESSAGE_VARIANTS = {
        info: {
          container: ['border-sky-200', 'bg-sky-50', 'text-sky-700'],
          indicator: 'bg-sky-500'
        },
        success: {
          container: ['border-emerald-200', 'bg-emerald-50', 'text-emerald-700'],
          indicator: 'bg-emerald-500'
        },
        warning: {
          container: ['border-amber-200', 'bg-amber-50', 'text-amber-700'],
          indicator: 'bg-amber-500'
        },
        error: {
          container: ['border-rose-200', 'bg-rose-50', 'text-rose-700'],
          indicator: 'bg-rose-500'
        }
      }

      const ALL_MESSAGE_CLASSES = Array.from(new Set(Object.values(MESSAGE_VARIANTS).flatMap((variant) => variant.container)))
      const ALL_INDICATOR_CLASSES = Array.from(new Set(Object.values(MESSAGE_VARIANTS).map((variant) => variant.indicator)))

      const aramcoEmailPattern = /^[^@]+@aramcodigital\.com$/i

      const form = document.querySelector('[data-auth-form]')
      const submitBtn = form?.querySelector('[data-auth-submit]')
      const toggleButtons = document.querySelectorAll('[data-auth-toggle]')
      const headingEl = document.querySelector('[data-auth-title]')
      const subtitleEl = document.querySelector('[data-auth-subtitle]')
      const messageContainer = document.querySelector('[data-auth-message]')
      const messageText = document.querySelector('[data-auth-message-text]')
      const messageIndicator = document.querySelector('[data-auth-message-indicator]')
      const emailInput = document.getElementById('email')
      const passwordInput = document.getElementById('password')

      const ACTIVE_TOGGLE_CLASSES = ['bg-emerald-600', 'text-white', 'shadow', 'shadow-emerald-500/20']
      const INACTIVE_TOGGLE_CLASSES = ['bg-transparent', 'text-emerald-600', 'hover:text-emerald-700']

      let authMode = 'sign-in'

      function formatNameFromEmail(emailValue) {
        if (!emailValue) return null
        const localPart = emailValue.split('@')[0] || ''
        if (!localPart) return null

        return localPart
          .split(/[.\-_]+/)
          .filter(Boolean)
          .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase())
          .join(' ')
      }

      function updateToggleState(mode) {
        toggleButtons.forEach((btn) => {
          const isActive = btn.dataset.authToggle === mode
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false')
          ACTIVE_TOGGLE_CLASSES.forEach((cls) => btn.classList.toggle(cls, isActive))
          INACTIVE_TOGGLE_CLASSES.forEach((cls) => btn.classList.toggle(cls, !isActive))
        })
      }

      function updateCopy(mode) {
        const copy = AUTH_COPY[mode]
        if (!copy) return
        if (headingEl) headingEl.textContent = copy.title
        if (subtitleEl) subtitleEl.textContent = copy.subtitle
        if (submitBtn) submitBtn.textContent = copy.submitLabel
      }

      function resetMessageStyles() {
        if (!messageContainer) return
        messageContainer.classList.remove(...ALL_MESSAGE_CLASSES)
        if (messageIndicator) {
          messageIndicator.classList.remove(...ALL_INDICATOR_CLASSES)
        }
      }

      function hideMessage() {
        if (!messageContainer) return
        resetMessageStyles()
        messageContainer.classList.add('hidden')
        if (messageText) messageText.textContent = ''
      }

      function showMessage(text, variant = 'info') {
        if (!messageContainer || !messageText) return
        const config = MESSAGE_VARIANTS[variant] || MESSAGE_VARIANTS.info
        resetMessageStyles()
        messageContainer.classList.remove('hidden')
        messageContainer.classList.add(...config.container)
        messageText.textContent = text
        if (messageIndicator) {
          messageIndicator.classList.add(config.indicator)
        }
      }

      function setAuthMode(mode, options = {}) {
        if (mode !== 'sign-in' && mode !== 'sign-up') return
        authMode = mode
        updateCopy(mode)
        updateToggleState(mode)
        if (options.focusPassword && passwordInput) {
          passwordInput.focus()
        }
        if (options.clearPassword && passwordInput) {
          passwordInput.value = ''
        }
      }

      toggleButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const targetMode = btn.dataset.authToggle === 'sign-up' ? 'sign-up' : 'sign-in'
          setAuthMode(targetMode)
          hideMessage()
        })
      })

      async function handleLogin(event) {
        event.preventDefault()
        if (!form || !submitBtn || !emailInput || !passwordInput) {
          return
        }

        const email = emailInput.value.trim()
        const password = passwordInput.value

        if (!email || !password) {
          showMessage('Please enter both email and password.', 'warning')
          return
        }

        if (!aramcoEmailPattern.test(email)) {
          showMessage('Please use your @aramcodigital.com email address.', 'warning')
          return
        }

        hideMessage()

        const normalizedEmail = email.toLowerCase()
        const copy = AUTH_COPY[authMode] || AUTH_COPY['sign-in']
        const originalLabel = copy.submitLabel
        const loadingLabel = copy.loadingLabel

        submitBtn.disabled = true
        submitBtn.textContent = loadingLabel

        try {
          const auth = window.firebaseAuth
          const db = window.firebaseDb

          if (!auth || !db) {
            throw new Error('Firebase is not initialized')
          }

          let userCredential

          if (authMode === 'sign-in') {
            userCredential = await signInWithEmailAndPassword(auth, normalizedEmail, password)
          } else {
            userCredential = await createUserWithEmailAndPassword(auth, normalizedEmail, password)
          }

          const user = userCredential.user
          const formattedName = formatNameFromEmail(normalizedEmail)
          const userRef = doc(db, 'users', user.uid)
          const userDoc = await getDoc(userRef)
          const userExists = userDoc.exists()

          const userData = {
            email: user.email,
            displayName: formattedName || user.email.split('@')[0],
            lastLogin: serverTimestamp(),
            updatedAt: serverTimestamp()
          }

          if (!userExists) {
            userData.createdAt = serverTimestamp()
            await setDoc(userRef, userData)
          } else {
            await setDoc(
              userRef,
              {
                ...userData,
                createdAt: userDoc.data().createdAt || serverTimestamp()
              },
              { merge: true }
            )
          }

          localStorage.setItem('pm-logged-in', 'true')
          localStorage.setItem('pm-user-id', user.uid)
          localStorage.setItem('pm-user-email', user.email)
          if (formattedName) {
            localStorage.setItem('pm-user-name', formattedName)
          }

          window.location.href = 'templates.html'
        } catch (error) {
          console.error('Authentication error:', error)
          let message = `Sign in failed (${error.code ?? 'unknown-error'}). Please try again.`
          let variant = 'error'

          if (error.code === 'auth/user-not-found') {
            message = "We couldn't find an account for that email. Create one to get started."
            variant = 'info'
            setAuthMode('sign-up', { focusPassword: true, clearPassword: true })
          } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            message = 'Account found, but the password is incorrect. Please try again.'
            variant = 'warning'
            setAuthMode('sign-in', { focusPassword: true, clearPassword: true })
          } else if (error.code === 'auth/email-already-in-use') {
            message = 'This account already exists. Please sign in instead.'
            variant = 'info'
            setAuthMode('sign-in', { focusPassword: true, clearPassword: true })
          } else if (error.code === 'auth/weak-password') {
            message = 'Password should be at least 6 characters.'
            variant = 'warning'
          } else if (error.code === 'auth/invalid-email') {
            message = 'Invalid email address.'
            variant = 'warning'
          }

          showMessage(message, variant)
        } finally {
          submitBtn.disabled = false
          const resetCopy = AUTH_COPY[authMode] || AUTH_COPY['sign-in']
          submitBtn.textContent = resetCopy.submitLabel
        }
      }

      window.handleLogin = handleLogin

      setAuthMode('sign-in')
      document.getElementById('year').textContent = new Date().getFullYear()
    </script>
    <script>
      ;(() => {
        const passwordInput = document.getElementById('password')
        const toggleBtn = document.querySelector('[data-password-toggle]')
        if (!passwordInput || !toggleBtn) return

        const openIcon = toggleBtn.querySelector('[data-eye-open]')
        const closedIcon = toggleBtn.querySelector('[data-eye-closed]')

        const setVisibility = (visible) => {
          passwordInput.setAttribute('type', visible ? 'text' : 'password')
          if (openIcon) openIcon.classList.toggle('hidden', visible)
          if (closedIcon) closedIcon.classList.toggle('hidden', !visible)
          const label = visible ? 'Hide password' : 'Show password'
          toggleBtn.setAttribute('aria-label', label)
          toggleBtn.setAttribute('title', label)
        }

        setVisibility(false)

        toggleBtn.addEventListener('click', () => {
          const isCurrentlyVisible = passwordInput.getAttribute('type') === 'text'
          setVisibility(!isCurrentlyVisible)
          if (!isCurrentlyVisible) {
            passwordInput.focus()
          }
        })
      })()
    </script>
  </body>
</html>


