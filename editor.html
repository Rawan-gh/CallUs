<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentation Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            background: linear-gradient(135deg, #0891b2 0%, #06b6d4 50%, #22d3ee 100%);
            color: white;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 12px rgba(8, 145, 178, 0.2);
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 10px; }

        .header-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .header-btn:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
        .header-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .title-input {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 14px;
            padding: 9px 16px;
            border-radius: 8px;
            outline: none;
            min-width: 320px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .title-input::placeholder { color: rgba(255,255,255,0.7); }
        .title-input:focus { background: rgba(255,255,255,0.25); }

        .share-btn {
            background: white;
            color: #0891b2;
            padding: 9px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .share-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2); }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none;
            min-width: 220px;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown-menu.show { display: block; }

        .dropdown-item {
            padding: 14px 18px;
            cursor: pointer;
            color: #374151;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .dropdown-item:hover { background: #ecfeff; color: #0891b2; }

        .toolbar {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .tool-btn {
            padding: 9px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
        }

        .tool-btn:hover { background: #f9fafb; border-color: #0891b2; color: #0891b2; transform: translateY(-1px); }

        .tool-divider { width: 1px; height: 32px; background: #e5e7eb; margin: 0 6px; }

        select.tool-btn { padding: 8px 14px; }
        input[type="number"].tool-btn { width: 75px; padding: 8px 12px; }
        input[type="color"] { width: 42px; height: 38px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; }

        .container { display: flex; height: calc(100vh - 130px); }

        .sidebar {
            width: 200px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            padding: 16px 12px;
            gap: 12px;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
        }

        .sidebar-header {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 8px;
        }

        .sidebar-slide {
            width: 100%;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .sidebar-slide:hover {
            border-color: #0891b2;
            transform: translateX(-4px);
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.15);
        }

        .sidebar-slide.active {
            border-color: #0891b2;
            border-width: 3px;
            box-shadow: 0 4px 16px rgba(8, 145, 178, 0.25);
        }

        .sidebar-slide-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: white;
            position: relative;
            font-size: 8px;
        }

        .sidebar-slide-number {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }

        .sidebar-slide-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .sidebar-slide:hover .sidebar-slide-delete {
            display: flex;
        }

        .sidebar-add-slide {
            width: 100%;
            padding: 12px;
            background: #f9fafb;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s;
        }

        .sidebar-add-slide:hover {
            background: #ecfeff;
            border-color: #0891b2;
            color: #0891b2;
        }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #f0f9fb 100%);
            overflow: auto;
            position: relative;
        }

        .canvas-area::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 19px, #e5e7eb 19px, #e5e7eb 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #e5e7eb 19px, #e5e7eb 20px);
            opacity: 0.3;
            pointer-events: none;
        }

        .canvas-wrapper { transform-origin: center; transition: transform 0.3s; }

        .canvas {
            width: 960px;
            height: 540px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .guide-line {
            position: absolute;
            background: #0891b2;
            z-index: 9999;
            pointer-events: none;
        }

        .guide-line.horizontal {
            height: 1px;
            width: 100%;
            left: 0;
            box-shadow: 0 0 4px rgba(8, 145, 178, 0.5);
        }

        .guide-line.vertical {
            width: 1px;
            height: 100%;
            top: 0;
            box-shadow: 0 0 4px rgba(8, 145, 178, 0.5);
        }

        .snap-indicator {
            position: absolute;
            background: #10b981;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            z-index: 9998;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .bottom-bar {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .slides-section {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }

        .slide-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            overflow-x: auto;
            flex: 1;
            padding: 4px;
        }

        .slide-preview {
            min-width: 130px;
            height: 74px;
            border: 2px solid #94a3b8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            background: white;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .slide-preview:hover { border-color: #0891b2; transform: translateY(-2px); }
        .slide-preview.active { border-color: #0891b2; color: #0891b2; background: #ecfeff; box-shadow: 0 0 0 2px #0891b2; }

        .slide-number {
            position: absolute;
            bottom: 6px;
            left: 8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .slide-icon {
            font-size: 14px;
        }

        .slide-delete {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 5px;
            width: 22px;
            height: 22px;
            font-size: 14px;
            cursor: pointer;
            display: none;
        }

        .slide-preview:hover .slide-delete { display: flex; align-items: center; justify-content: center; }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            font-size: 18px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .control-btn:hover { background: #f9fafb; border-color: #0891b2; color: #0891b2; }

        .zoom-control { display: flex; align-items: center; gap: 14px; }
        .zoom-slider { width: 160px; }
        .zoom-value { font-size: 13px; font-weight: 600; color: #6b7280; min-width: 45px; }

        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
            transition: box-shadow 0.2s;
        }

        .canvas-element.selected { outline: 2px solid #0891b2; outline-offset: 2px; box-shadow: 0 4px 16px rgba(8, 145, 178, 0.2); }

        .resize-handle {
            position: absolute;
            width: 11px;
            height: 11px;
            background: white;
            border: 2px solid #0891b2;
            border-radius: 50%;
            display: none;
            box-shadow: 0 2px 6px rgba(8, 145, 178, 0.3);
        }

        .canvas-element.selected .resize-handle { display: block; }
        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .text-element {
            padding: 14px;
            min-width: 100px;
            outline: none;
            cursor: text;
            line-height: 1.6;
            border-radius: 4px;
        }
        
        .text-element:not(:focus) { cursor: move; }

        .shape-element { border: 2px solid #0891b2; }
        .image-element { background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 4px; }

        table.table-element { border-collapse: collapse; background: white; }
        table.table-element td { border: 1px solid #e5e7eb; padding: 10px; min-width: 90px; min-height: 35px; }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 6px 0;
            display: none;
            z-index: 1000;
            min-width: 180px;
        }

        .context-menu-item { padding: 11px 18px; cursor: pointer; font-size: 13px; font-weight: 500; color: #374151; }
        .context-menu-item:hover { background: #ecfeff; color: #0891b2; }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: white;
            padding: 28px;
            border-radius: 16px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #1f2937; }
        .modal-body { margin-bottom: 24px; }
        .modal-footer { display: flex; gap: 12px; justify-content: flex-end; }

        .btn { padding: 11px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .btn-primary { background: #0891b2; color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 10px; font-size: 13px; font-weight: 600; color: #374151; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; }
        
        .color-swatch {
            width: 100%;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .color-swatch:hover {
            transform: scale(1.05);
            border-color: #0891b2;
            box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
        }
        
        /* Presentation Mode */
        .present-mode {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .present-mode.active { display: flex; }
        
        .present-slide {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .present-canvas {
            max-width: 90vw;
            max-height: 90vh;
            background: white;
            box-shadow: 0 20px 80px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .present-controls {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 16px 32px;
            border-radius: 50px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .present-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .present-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }
        
        .present-counter {
            color: white;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        
        /* Slide Transitions */
        .slide-transition-fade {
            animation: fadeIn 0.5s ease;
        }
        
        .slide-transition-slide {
            animation: slideIn 0.5s ease;
        }
        
        .slide-transition-zoom {
            animation: zoomIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Element Animations */
        .animate-fadeIn {
            animation: elementFadeIn 1s ease;
        }
        
        .animate-slideInLeft {
            animation: slideInLeft 1s ease;
        }
        
        .animate-slideInRight {
            animation: slideInRight 1s ease;
        }
        
        .animate-slideInUp {
            animation: slideInUp 1s ease;
        }
        
        .animate-bounce {
            animation: bounce 1s ease;
        }
        
        @keyframes elementFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="header-btn" onclick="app.save()">Save</button>
            <button class="header-btn" onclick="app.load()">Load</button>
            <button class="header-btn" onclick="app.exportPDF()">Export PDF</button>
            <button class="header-btn" onclick="app.undo()" id="undoBtn" disabled>Undo</button>
            <button class="header-btn" onclick="app.redo()" id="redoBtn" disabled>Redo</button>
        </div>
        <div class="header-right">
            <input type="text" class="title-input" id="title" placeholder="Untitled Presentation" />
            <div style="position: relative;">
                <button class="share-btn" onclick="app.toggleShare()">Share</button>
                <div class="dropdown-menu" id="shareMenu">
                    <div class="dropdown-item" onclick="app.shareEmail()">Send via Email</div>
                    <div class="dropdown-item" onclick="app.download()">Download to Device</div>
                    <div class="dropdown-item" onclick="app.shareLink()">Generate Share Link</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="app.addText()">Text</button>
        <button class="tool-btn" onclick="app.showShapes()">Shape</button>
        <button class="tool-btn" onclick="app.addImage()">Image</button>
        <button class="tool-btn" onclick="app.showTable()">Table</button>
        
        <div class="tool-divider"></div>
        
        <select class="tool-btn" id="font" onchange="app.changeFont()">
            <option>Arial</option>
            <option>Helvetica</option>
            <option>Times New Roman</option>
            <option>Georgia</option>
            <option>Courier New</option>
        </select>
        
        <input type="number" class="tool-btn" id="size" value="16" min="8" max="200" onchange="app.changeSize()" />
        
        <select class="tool-btn" id="weight" onchange="app.changeWeight()">
            <option value="300">Light</option>
            <option value="400" selected>Regular</option>
            <option value="700">Bold</option>
        </select>
        
        <input type="color" id="color" value="#000000" onchange="app.changeColor()" />
        <input type="color" id="bg" value="#ffffff" onchange="app.changeBg()" />
        
        <div class="tool-divider"></div>
        
        <button class="tool-btn" onclick="app.align('left')">Left</button>
        <button class="tool-btn" onclick="app.align('center')">Center</button>
        <button class="tool-btn" onclick="app.align('right')">Right</button>
        
        <div class="tool-divider"></div>
        
        <button class="tool-btn" onclick="app.copyStyle()">Copy Style</button>
        <button class="tool-btn" onclick="app.pasteStyle()">Paste Style</button>
        
        <div class="tool-divider"></div>
        
        <button class="tool-btn" onclick="app.setBgColor()">Background</button>
        <button class="tool-btn" onclick="app.addShadow()">Shadow</button>
        <button class="tool-btn" onclick="app.showAnimations()">Animate</button>
        
        <div class="tool-divider"></div>
        
        <button class="tool-btn" onclick="app.forward()">Forward</button>
        <button class="tool-btn" onclick="app.backward()">Backward</button>
        
        <div class="tool-divider"></div>
        
        <button class="tool-btn" onclick="app.presentMode()" style="background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); color: white; font-weight: 600;">▶ Present</button>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebarSlides">
            <div class="sidebar-header">Slides</div>
        </div>

        <div class="canvas-area">
            <div class="canvas-wrapper" id="wrapper">
                <div class="canvas" id="canvas"></div>
                <button class="add-slide-btn" onclick="app.addSlide()">
                    <span style="font-size: 24px;">+</span>
                    <span>Add New Slide</span>
                </button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <div class="slides-section">
            <div class="slide-controls" id="slides"></div>
            <button class="control-btn" onclick="app.showSlideOptions()">▼</button>
        </div>
        <div class="zoom-control">
            <input type="range" class="zoom-slider" min="25" max="200" value="100" oninput="app.zoom(this.value)">
            <span class="zoom-value" id="zoom">100%</span>
        </div>
    </div>

    <div class="context-menu" id="menu">
        <div class="context-menu-item" onclick="app.duplicate()">Duplicate (Ctrl+D)</div>
        <div class="context-menu-item" onclick="app.deleteEl()">Delete (Del)</div>
        <div class="context-menu-item" onclick="app.copyStyle()">Copy Style</div>
        <div class="context-menu-item" onclick="app.pasteStyle()">Paste Style</div>
        <div class="context-menu-item" onclick="app.forward()">Bring Forward</div>
        <div class="context-menu-item" onclick="app.backward()">Send Backward</div>
    </div>

    <div class="modal" id="bgModal">
        <div class="modal-content">
            <div class="modal-header">Choose Background</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Solid Colors:</label>
                    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="color-swatch" style="background: #ffffff;" onclick="app.applyBg('#ffffff')"></div>
                        <div class="color-swatch" style="background: #f3f4f6;" onclick="app.applyBg('#f3f4f6')"></div>
                        <div class="color-swatch" style="background: #1f2937;" onclick="app.applyBg('#1f2937')"></div>
                        <div class="color-swatch" style="background: #ef4444;" onclick="app.applyBg('#ef4444')"></div>
                        <div class="color-swatch" style="background: #f59e0b;" onclick="app.applyBg('#f59e0b')"></div>
                        <div class="color-swatch" style="background: #10b981;" onclick="app.applyBg('#10b981')"></div>
                        <div class="color-swatch" style="background: #3b82f6;" onclick="app.applyBg('#3b82f6')"></div>
                        <div class="color-swatch" style="background: #8b5cf6;" onclick="app.applyBg('#8b5cf6')"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gradients:</label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div class="color-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="app.applyBg('linear-gradient(135deg, #667eea 0%, #764ba2 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" onclick="app.applyBg('linear-gradient(135deg, #f093fb 0%, #f5576c 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);" onclick="app.applyBg('linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);" onclick="app.applyBg('linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="app.applyBg('linear-gradient(135deg, #fa709a 0%, #fee140 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);" onclick="app.applyBg('linear-gradient(135deg, #30cfd0 0%, #330867 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);" onclick="app.applyBg('linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)')"></div>
                        <div class="color-swatch" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);" onclick="app.applyBg('linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)')"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="app.uploadBgImage()">Upload Image</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('bgModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="animModal">
        <div class="modal-content">
            <div class="modal-header">Choose Animation</div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                    <button class="tool-btn" onclick="app.applyAnimation('none')" style="justify-content: flex-start; padding: 16px;">
                        <strong>No Animation</strong>
                    </button>
                    <button class="tool-btn" onclick="app.applyAnimation('fadeIn')" style="justify-content: flex-start; padding: 16px;">
                        <strong>Fade In</strong> - Element fades in smoothly
                    </button>
                    <button class="tool-btn" onclick="app.applyAnimation('slideInLeft')" style="justify-content: flex-start; padding: 16px;">
                        <strong>Slide In Left</strong> - Slides from left side
                    </button>
                    <button class="tool-btn" onclick="app.applyAnimation('slideInRight')" style="justify-content: flex-start; padding: 16px;">
                        <strong>Slide In Right</strong> - Slides from right side
                    </button>
                    <button class="tool-btn" onclick="app.applyAnimation('slideInUp')" style="justify-content: flex-start; padding: 16px;">
                        <strong>Slide In Up</strong> - Slides from bottom
                    </button>
                    <button class="tool-btn" onclick="app.applyAnimation('bounce')" style="justify-content: flex-start; padding: 16px;">
                        <strong>Bounce</strong> - Bouncing effect
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('animModal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="shapeModal">
        <div class="modal-content">
            <div class="modal-header">Select Shape</div>
            <div class="modal-body" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <button class="tool-btn" onclick="app.addShape('rect')">Rectangle</button>
                <button class="tool-btn" onclick="app.addShape('circle')">Circle</button>
                <button class="tool-btn" onclick="app.addShape('triangle')">Triangle</button>
                <button class="tool-btn" onclick="app.addShape('line')">Line</button>
                <button class="tool-btn" onclick="app.addShape('arrow')">Arrow</button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('shapeModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="tableModal">
        <div class="modal-content">
            <div class="modal-header">Create Table</div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Rows:</label>
                    <input type="number" id="rows" value="3" min="1" max="20" />
                </div>
                <div class="form-group">
                    <label>Columns:</label>
                    <input type="number" id="cols" value="3" min="1" max="10" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModal('tableModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.createTable()">Create</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            data: [{ id: 1, els: [], bg: '#ffffff', transition: 'fade' }],
            curr: 0,
            sel: null,
            drag: false,
            resize: false,
            handle: null,
            sx: 0, sy: 0, sw: 0, sh: 0, sl: 0, st: 0,
            hist: [],
            idx: -1,
            ctr: 0,
            snapThreshold: 8,
            guides: [],
            copiedStyle: null,
            presenting: false,
            presentSlide: 0,

            init() {
                this.renderSlides();
                this.renderSidebarSlides();
                this.loadCanvas();
                const saved = localStorage.getItem('pres');
                if (saved) {
                    const d = JSON.parse(saved);
                    this.data = d.slides;
                    document.getElementById('title').value = d.title || '';
                    this.renderSlides();
                    this.renderSidebarSlides();
                    this.loadCanvas();
                }
                this.saveState();
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.share-btn')) {
                        document.getElementById('shareMenu').classList.remove('show');
                    }
                    if (!e.target.closest('.context-menu')) {
                        document.getElementById('menu').style.display = 'none';
                    }
                });
                
                document.addEventListener('mousemove', (e) => this.onMove(e));
                document.addEventListener('mouseup', () => {
                    if (this.drag || this.resize) {
                        this.saveState();
                        this.clearGuides();
                    }
                    this.drag = false;
                    this.resize = false;
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'd') {
                            e.preventDefault();
                            this.duplicate();
                        }
                    }
                    if (e.key === 'Delete' && this.sel) {
                        this.deleteEl();
                    }
                    if (e.key === 'Escape') {
                        if (this.sel) {
                            this.sel.classList.remove('selected');
                            this.sel = null;
                        }
                    }
                });
                
                document.getElementById('canvas').addEventListener('click', (e) => {
                    if (e.target === document.getElementById('canvas') && this.sel) {
                        this.sel.classList.remove('selected');
                        this.sel = null;
                    }
                });
            },

            saveState() {
                const s = { data: JSON.parse(JSON.stringify(this.data)), curr: this.curr };
                this.hist = this.hist.slice(0, this.idx + 1);
                this.hist.push(s);
                this.idx++;
                if (this.hist.length > 50) {
                    this.hist.shift();
                    this.idx--;
                }
                document.getElementById('undoBtn').disabled = this.idx <= 0;
                document.getElementById('redoBtn').disabled = this.idx >= this.hist.length - 1;
            },

            undo() {
                if (this.idx > 0) {
                    this.idx--;
                    const s = this.hist[this.idx];
                    this.data = JSON.parse(JSON.stringify(s.data));
                    this.curr = s.curr;
                    this.renderSlides();
                    this.loadCanvas();
                    document.getElementById('undoBtn').disabled = this.idx <= 0;
                    document.getElementById('redoBtn').disabled = this.idx >= this.hist.length - 1;
                }
            },

            redo() {
                if (this.idx < this.hist.length - 1) {
                    this.idx++;
                    const s = this.hist[this.idx];
                    this.data = JSON.parse(JSON.stringify(s.data));
                    this.curr = s.curr;
                    this.renderSlides();
                    this.loadCanvas();
                    document.getElementById('undoBtn').disabled = this.idx <= 0;
                    document.getElementById('redoBtn').disabled = this.idx >= this.hist.length - 1;
                }
            },

            addText() {
                const el = {
                    id: ++this.ctr,
                    type: 'text',
                    text: 'Double-click to edit',
                    x: 100, y: 100, w: 250, h: 60,
                    font: 'Arial', size: 20, weight: 400,
                    color: '#000000', bg: 'transparent', align: 'left'
                };
                this.data[this.curr].els.push(el);
                this.saveState();
                this.loadCanvas();
            },

            showShapes() {
                document.getElementById('shapeModal').classList.add('show');
            },

            addShape(type) {
                this.closeModal('shapeModal');
                const el = {
                    id: ++this.ctr,
                    type: 'shape',
                    shape: type,
                    x: 150, y: 150, w: 150, h: 150,
                    border: '#0891b2', thick: 2, bg: 'transparent'
                };
                this.data[this.curr].els.push(el);
                this.saveState();
                this.loadCanvas();
            },

            addImage() {
                const inp = document.createElement('input');
                inp.type = 'file';
                inp.accept = 'image/*';
                inp.onchange = (e) => {
                    const f = e.target.files[0];
                    if (f) {
                        const r = new FileReader();
                        r.onload = (ev) => {
                            const el = {
                                id: ++this.ctr,
                                type: 'img',
                                src: ev.target.result,
                                x: 100, y: 100, w: 300, h: 300
                            };
                            this.data[this.curr].els.push(el);
                            this.saveState();
                            this.loadCanvas();
                        };
                        r.readAsDataURL(f);
                    }
                };
                inp.click();
            },

            showTable() {
                document.getElementById('tableModal').classList.add('show');
            },

            createTable() {
                const r = parseInt(document.getElementById('rows').value);
                const c = parseInt(document.getElementById('cols').value);
                this.closeModal('tableModal');
                const el = {
                    id: ++this.ctr,
                    type: 'table',
                    rows: r, cols: c,
                    x: 100, y: 100,
                    cw: 100, ch: 40,
                    data: Array(r).fill().map(() => Array(c).fill(''))
                };
                this.data[this.curr].els.push(el);
                this.saveState();
                this.loadCanvas();
            },

            loadCanvas() {
                const can = document.getElementById('canvas');
                can.innerHTML = '';
                can.style.backgroundColor = this.data[this.curr].bg || '#ffffff';
                
                this.data[this.curr].els.forEach(el => {
                    const div = this.createEl(el);
                    can.appendChild(div);
                });
            },

            createEl(el) {
                const d = document.createElement('div');
                d.className = 'canvas-element';
                d.dataset.id = el.id;
                d.style.left = el.x + 'px';
                d.style.top = el.y + 'px';
                d.style.width = el.w + 'px';
                d.style.height = el.h + 'px';

                if (el.type === 'text') {
                    d.className += ' text-element';
                    d.contentEditable = true;
                    d.textContent = el.text;
                    d.style.fontSize = el.size + 'px';
                    d.style.fontFamily = el.font;
                    d.style.fontWeight = el.weight;
                    d.style.color = el.color;
                    d.style.backgroundColor = el.bg;
                    d.style.textAlign = el.align;
                    d.style.whiteSpace = 'pre-wrap';
                    d.style.wordWrap = 'break-word';
                    
                    d.addEventListener('blur', () => {
                        el.text = d.textContent;
                        this.saveState();
                    });
                    
                    d.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        d.focus();
                        const range = document.createRange();
                        range.selectNodeContents(d);
                        const sel = window.getSelection();
                        sel.removeAllRanges();
                        sel.addRange(range);
                    });
                    
                    d.addEventListener('focus', () => {
                        d.dataset.editing = 'true';
                    });
                    
                    d.addEventListener('blur', () => {
                        delete d.dataset.editing;
                    });
                    if (el.shadow) {
                        d.style.boxShadow = el.shadow;
                    }
                } else if (el.type === 'shape') {
                    d.className += ' shape-element';
                    d.style.borderColor = el.border;
                    d.style.borderWidth = el.thick + 'px';
                    d.style.borderStyle = 'solid';
                    d.style.backgroundColor = el.bg;
                    
                    if (el.shape === 'circle') {
                        d.style.borderRadius = '50%';
                    } else if (el.shape === 'triangle') {
                        d.style.width = '0';
                        d.style.height = '0';
                        d.style.borderLeft = (el.w/2) + 'px solid transparent';
                        d.style.borderRight = (el.w/2) + 'px solid transparent';
                        d.style.borderBottom = el.h + 'px solid ' + el.border;
                        d.style.backgroundColor = 'transparent';
                        d.style.borderTop = 'none';
                    } else if (el.shape === 'line') {
                        d.style.height = el.thick + 'px';
                        d.style.backgroundColor = el.border;
                        d.style.border = 'none';
                    } else if (el.shape === 'arrow') {
                        d.style.height = el.thick + 'px';
                        d.style.backgroundColor = el.border;
                        d.style.border = 'none';
                        d.innerHTML = '<div style="position:absolute;right:-10px;top:-' + (5+el.thick/2) + 'px;width:0;height:0;border-left:10px solid ' + el.border + ';border-top:5px solid transparent;border-bottom:5px solid transparent;"></div>';
                    }
                } else if (el.type === 'img') {
                    d.className += ' image-element';
                    d.style.backgroundImage = `url(${el.src})`;
                } else if (el.type === 'table') {
                    const t = document.createElement('table');
                    t.className = 'table-element';
                    for (let i = 0; i < el.rows; i++) {
                        const tr = document.createElement('tr');
                        for (let j = 0; j < el.cols; j++) {
                            const td = document.createElement('td');
                            td.contentEditable = true;
                            td.textContent = el.data[i][j];
                            td.style.width = el.cw + 'px';
                            td.style.height = el.ch + 'px';
                            td.addEventListener('blur', () => {
                                el.data[i][j] = td.textContent;
                                this.saveState();
                            });
                            tr.appendChild(td);
                        }
                        t.appendChild(tr);
                    }
                    d.appendChild(t);
                }

                ['nw', 'ne', 'sw', 'se'].forEach(p => {
                    const h = document.createElement('div');
                    h.className = 'resize-handle ' + p;
                    h.addEventListener('mousedown', (e) => this.startResize(e, d, p));
                    d.appendChild(h);
                });

                d.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    this.startDrag(e, d);
                });
                
                d.addEventListener('contextmenu', (e) => this.showMenu(e, d));

                return d;
            },

            startDrag(e, d) {
                if (e.target.classList.contains('resize-handle')) return;
                
                const isText = d.classList.contains('text-element');
                const isEditing = d.dataset.editing === 'true';
                
                if (isEditing) return;
                
                if (this.sel && this.sel !== d) {
                    this.sel.classList.remove('selected');
                }
                
                this.sel = d;
                this.sel.classList.add('selected');
                
                if (isText && e.detail === 2) return;
                
                this.drag = true;
                this.sx = e.offsetX;
                this.sy = e.offsetY;
            },

            startResize(e, d, p) {
                e.stopPropagation();
                if (this.sel) this.sel.classList.remove('selected');
                this.sel = d;
                this.sel.classList.add('selected');
                this.resize = true;
                this.handle = p;
                this.sx = e.clientX;
                this.sy = e.clientY;
                this.sw = d.offsetWidth;
                this.sh = d.offsetHeight;
                this.sl = d.offsetLeft;
                this.st = d.offsetTop;
                e.preventDefault();
            },

            onMove(e) {
                if (this.drag && this.sel) {
                    const cr = document.getElementById('canvas').getBoundingClientRect();
                    let nl = e.clientX - cr.left - this.sx;
                    let nt = e.clientY - cr.top - this.sy;
                    
                    const maxL = cr.width - this.sel.offsetWidth;
                    const maxT = cr.height - this.sel.offsetHeight;
                    
                    // Clear old guides
                    this.clearGuides();
                    
                    // Smart snapping
                    const snapResult = this.getSnapPosition(nl, nt, this.sel.offsetWidth, this.sel.offsetHeight);
                    nl = snapResult.x;
                    nt = snapResult.y;
                    
                    // Draw guides
                    snapResult.guides.forEach(guide => this.drawGuide(guide));
                    
                    this.sel.style.left = Math.max(0, Math.min(nl, maxL)) + 'px';
                    this.sel.style.top = Math.max(0, Math.min(nt, maxT)) + 'px';
                    
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el) {
                        el.x = parseInt(this.sel.style.left);
                        el.y = parseInt(this.sel.style.top);
                    }
                } else if (this.resize && this.sel) {
                    const dx = e.clientX - this.sx;
                    const dy = e.clientY - this.sy;
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    
                    if (this.handle === 'se') {
                        const nw = Math.max(50, this.sw + dx);
                        const nh = Math.max(50, this.sh + dy);
                        this.sel.style.width = nw + 'px';
                        this.sel.style.height = nh + 'px';
                        if (el) { el.w = nw; el.h = nh; }
                    } else if (this.handle === 'sw') {
                        const nw = Math.max(50, this.sw - dx);
                        const nh = Math.max(50, this.sh + dy);
                        this.sel.style.width = nw + 'px';
                        this.sel.style.height = nh + 'px';
                        this.sel.style.left = (this.sl + dx) + 'px';
                        if (el) { el.w = nw; el.h = nh; el.x = parseInt(this.sel.style.left); }
                    } else if (this.handle === 'ne') {
                        const nw = Math.max(50, this.sw + dx);
                        const nh = Math.max(50, this.sh - dy);
                        this.sel.style.width = nw + 'px';
                        this.sel.style.height = nh + 'px';
                        this.sel.style.top = (this.st + dy) + 'px';
                        if (el) { el.w = nw; el.h = nh; el.y = parseInt(this.sel.style.top); }
                    } else if (this.handle === 'nw') {
                        const nw = Math.max(50, this.sw - dx);
                        const nh = Math.max(50, this.sh - dy);
                        this.sel.style.width = nw + 'px';
                        this.sel.style.height = nh + 'px';
                        this.sel.style.left = (this.sl + dx) + 'px';
                        this.sel.style.top = (this.st + dy) + 'px';
                        if (el) { el.w = nw; el.h = nh; el.x = parseInt(this.sel.style.left); el.y = parseInt(this.sel.style.top); }
                    }
                }
            },

            getSnapPosition(x, y, w, h) {
                const canvas = document.getElementById('canvas');
                const canvasW = 960;
                const canvasH = 540;
                const threshold = this.snapThreshold;
                const guides = [];
                
                let snapX = x;
                let snapY = y;
                
                // Canvas center lines
                const centerX = canvasW / 2;
                const centerY = canvasH / 2;
                const elCenterX = x + w / 2;
                const elCenterY = y + h / 2;
                
                // Snap to canvas center
                if (Math.abs(elCenterX - centerX) < threshold) {
                    snapX = centerX - w / 2;
                    guides.push({ type: 'vertical', pos: centerX });
                }
                if (Math.abs(elCenterY - centerY) < threshold) {
                    snapY = centerY - h / 2;
                    guides.push({ type: 'horizontal', pos: centerY });
                }
                
                // Snap to edges
                if (Math.abs(x) < threshold) {
                    snapX = 0;
                    guides.push({ type: 'vertical', pos: 0 });
                }
                if (Math.abs(y) < threshold) {
                    snapY = 0;
                    guides.push({ type: 'horizontal', pos: 0 });
                }
                if (Math.abs(x + w - canvasW) < threshold) {
                    snapX = canvasW - w;
                    guides.push({ type: 'vertical', pos: canvasW });
                }
                if (Math.abs(y + h - canvasH) < threshold) {
                    snapY = canvasH - h;
                    guides.push({ type: 'horizontal', pos: canvasH });
                }
                
                // Snap to other elements
                this.data[this.curr].els.forEach(el => {
                    if (this.sel && el.id == this.sel.dataset.id) return;
                    
                    const ex = el.x;
                    const ey = el.y;
                    const ew = el.w;
                    const eh = el.h;
                    
                    // Left edges align
                    if (Math.abs(x - ex) < threshold) {
                        snapX = ex;
                        guides.push({ type: 'vertical', pos: ex });
                    }
                    // Right edges align
                    if (Math.abs((x + w) - (ex + ew)) < threshold) {
                        snapX = ex + ew - w;
                        guides.push({ type: 'vertical', pos: ex + ew });
                    }
                    // Top edges align
                    if (Math.abs(y - ey) < threshold) {
                        snapY = ey;
                        guides.push({ type: 'horizontal', pos: ey });
                    }
                    // Bottom edges align
                    if (Math.abs((y + h) - (ey + eh)) < threshold) {
                        snapY = ey + eh - h;
                        guides.push({ type: 'horizontal', pos: ey + eh });
                    }
                    
                    // Center alignment with other elements
                    const elOtherCenterX = ex + ew / 2;
                    const elOtherCenterY = ey + eh / 2;
                    
                    if (Math.abs(elCenterX - elOtherCenterX) < threshold) {
                        snapX = elOtherCenterX - w / 2;
                        guides.push({ type: 'vertical', pos: elOtherCenterX });
                    }
                    if (Math.abs(elCenterY - elOtherCenterY) < threshold) {
                        snapY = elOtherCenterY - h / 2;
                        guides.push({ type: 'horizontal', pos: elOtherCenterY });
                    }
                });
                
                // Grid snapping (20px grid)
                const gridSize = 20;
                const gridSnapX = Math.round(x / gridSize) * gridSize;
                const gridSnapY = Math.round(y / gridSize) * gridSize;
                
                if (Math.abs(x - gridSnapX) < threshold && guides.length === 0) {
                    snapX = gridSnapX;
                }
                if (Math.abs(y - gridSnapY) < threshold && guides.length === 0) {
                    snapY = gridSnapY;
                }
                
                return { x: snapX, y: snapY, guides };
            },

            drawGuide(guide) {
                const canvas = document.getElementById('canvas');
                const line = document.createElement('div');
                line.className = 'guide-line ' + guide.type;
                
                if (guide.type === 'horizontal') {
                    line.style.top = guide.pos + 'px';
                } else {
                    line.style.left = guide.pos + 'px';
                }
                
                canvas.appendChild(line);
                this.guides.push(line);
                
                // Auto remove after 1 second
                setTimeout(() => {
                    if (line.parentNode) line.remove();
                }, 1000);
            },

            clearGuides() {
                this.guides.forEach(g => {
                    if (g.parentNode) g.remove();
                });
                this.guides = [];
            },

            showMenu(e, d) {
                e.preventDefault();
                if (this.sel) this.sel.classList.remove('selected');
                this.sel = d;
                this.sel.classList.add('selected');
                const m = document.getElementById('menu');
                m.style.display = 'block';
                m.style.left = e.clientX + 'px';
                m.style.top = e.clientY + 'px';
            },

            duplicate() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el) {
                        const dup = JSON.parse(JSON.stringify(el));
                        dup.id = ++this.ctr;
                        dup.x += 20;
                        dup.y += 20;
                        this.data[this.curr].els.push(dup);
                        this.saveState();
                        this.loadCanvas();
                    }
                }
            },

            deleteEl() {
                if (this.sel) {
                    this.data[this.curr].els = this.data[this.curr].els.filter(e => e.id != this.sel.dataset.id);
                    this.sel = null;
                    this.saveState();
                    this.loadCanvas();
                }
            },

            forward() {
                if (this.sel) this.sel.style.zIndex = 1000;
            },

            backward() {
                if (this.sel) this.sel.style.zIndex = 1;
            },

            changeFont() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el && el.type === 'text') {
                        el.font = document.getElementById('font').value;
                        this.sel.style.fontFamily = el.font;
                        this.saveState();
                    }
                }
            },

            changeSize() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el && el.type === 'text') {
                        el.size = parseInt(document.getElementById('size').value);
                        this.sel.style.fontSize = el.size + 'px';
                        this.saveState();
                    }
                }
            },

            changeWeight() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el && el.type === 'text') {
                        el.weight = parseInt(document.getElementById('weight').value);
                        this.sel.style.fontWeight = el.weight;
                        this.saveState();
                    }
                }
            },

            changeColor() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el) {
                        if (el.type === 'text') {
                            el.color = document.getElementById('color').value;
                            this.sel.style.color = el.color;
                        } else if (el.type === 'shape') {
                            el.border = document.getElementById('color').value;
                            this.sel.style.borderColor = el.border;
                        }
                        this.saveState();
                    }
                }
            },

            changeBg() {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el) {
                        el.bg = document.getElementById('bg').value;
                        this.sel.style.backgroundColor = el.bg;
                        this.saveState();
                    }
                }
            },

            align(dir) {
                if (this.sel) {
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el && el.type === 'text') {
                        el.align = dir;
                        this.sel.style.textAlign = dir;
                        this.saveState();
                    }
                }
            },

            zoom(v) {
                document.getElementById('zoom').textContent = v + '%';
                document.getElementById('wrapper').style.transform = `scale(${v / 100})`;
            },

            addSlide() {
                this.data.push({ id: this.data.length + 1, els: [], bg: '#ffffff', transition: 'fade' });
                this.curr = this.data.length - 1;
                this.saveState();
                this.renderSlides();
                this.renderSidebarSlides();
                this.loadCanvas();
            },

            selectSlide(i) {
                this.curr = i;
                this.renderSlides();
                this.renderSidebarSlides();
                this.loadCanvas();
            },

            deleteSlide(i) {
                if (this.data.length > 1) {
                    this.data.splice(i, 1);
                    if (this.curr >= this.data.length) this.curr = this.data.length - 1;
                    this.saveState();
                    this.renderSlides();
                    this.renderSidebarSlides();
                    this.loadCanvas();
                }
            },

            renderSidebarSlides() {
                const sidebar = document.getElementById('sidebarSlides');
                const header = sidebar.querySelector('.sidebar-header');
                sidebar.innerHTML = '';
                sidebar.appendChild(header);
                
                this.data.forEach((slide, i) => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = 'sidebar-slide' + (i === this.curr ? ' active' : '');
                    slideDiv.onclick = () => this.selectSlide(i);
                    
                    const preview = document.createElement('div');
                    preview.className = 'sidebar-slide-preview';
                    preview.style.background = slide.bg || '#ffffff';
                    
                    if (slide.bg && slide.bg.startsWith('url(')) {
                        preview.style.backgroundImage = slide.bg;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                    }
                    
                    // Render mini elements
                    slide.els.forEach(el => {
                        const miniEl = document.createElement('div');
                        miniEl.style.position = 'absolute';
                        miniEl.style.left = (el.x / 960 * 100) + '%';
                        miniEl.style.top = (el.y / 540 * 100) + '%';
                        miniEl.style.width = (el.w / 960 * 100) + '%';
                        miniEl.style.height = (el.h / 540 * 100) + '%';
                        
                        if (el.type === 'text') {
                            miniEl.style.background = el.bg || 'transparent';
                            miniEl.style.border = '1px solid #e5e7eb';
                        } else if (el.type === 'shape') {
                            miniEl.style.background = el.bg || 'transparent';
                            miniEl.style.border = '1px solid ' + (el.border || '#0891b2');
                            if (el.shape === 'circle') {
                                miniEl.style.borderRadius = '50%';
                            }
                        } else if (el.type === 'img') {
                            miniEl.style.backgroundImage = `url(${el.src})`;
                            miniEl.style.backgroundSize = 'cover';
                        }
                        
                        preview.appendChild(miniEl);
                    });
                    
                    const number = document.createElement('div');
                    number.className = 'sidebar-slide-number';
                    number.textContent = i + 1;
                    preview.appendChild(number);
                    
                    if (this.data.length > 1) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'sidebar-slide-delete';
                        deleteBtn.textContent = '×';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.deleteSlide(i);
                        };
                        preview.appendChild(deleteBtn);
                    }
                    
                    slideDiv.appendChild(preview);
                    sidebar.appendChild(slideDiv);
                });
                
                // Add new slide button
                const addBtn = document.createElement('div');
                addBtn.className = 'sidebar-add-slide';
                addBtn.innerHTML = '<span style="font-size: 18px;">+</span> New Slide';
                addBtn.onclick = () => this.addSlide();
                sidebar.appendChild(addBtn);
            },

            renderSlides() {
                const cont = document.getElementById('slides');
                cont.innerHTML = '';
                this.data.forEach((s, i) => {
                    const div = document.createElement('div');
                    div.className = 'slide-preview' + (i === this.curr ? ' active' : '');
                    div.onclick = () => this.selectSlide(i);
                    
                    const num = document.createElement('div');
                    num.className = 'slide-number';
                    num.innerHTML = '<span class="slide-icon">🗐</span> ' + (i + 1);
                    div.appendChild(num);
                    
                    if (this.data.length > 1) {
                        const del = document.createElement('button');
                        del.className = 'slide-delete';
                        del.textContent = '×';
                        del.onclick = (e) => {
                            e.stopPropagation();
                            this.deleteSlide(i);
                        };
                        div.appendChild(del);
                    }
                    
                    cont.appendChild(div);
                });
            },

            save() {
                const d = {
                    title: document.getElementById('title').value,
                    slides: this.data
                };
                localStorage.setItem('pres', JSON.stringify(d));
                alert('✅ Presentation saved successfully!');
            },

            load() {
                const saved = localStorage.getItem('pres');
                if (saved) {
                    const d = JSON.parse(saved);
                    this.data = d.slides;
                    document.getElementById('title').value = d.title || '';
                    this.curr = 0;
                    this.renderSlides();
                    this.loadCanvas();
                    this.saveState();
                    alert('✅ Presentation loaded successfully!');
                } else {
                    alert('❌ No saved presentation found!');
                }
            },

            async exportPDF() {
                alert('📄 Generating PDF... This may take a moment.');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape', 'px', [960, 540]);
                
                for (let i = 0; i < this.data.length; i++) {
                    this.curr = i;
                    this.loadCanvas();
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const canvas = await html2canvas(document.getElementById('canvas'), {
                        scale: 2,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    if (i > 0) pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, 0, 960, 540);
                }
                
                const title = document.getElementById('title').value || 'presentation';
                pdf.save(title + '.pdf');
                alert('✅ PDF exported successfully!');
            },

            toggleShare() {
                document.getElementById('shareMenu').classList.toggle('show');
            },

            shareEmail() {
                const title = document.getElementById('title').value || 'Presentation';
                const subject = encodeURIComponent(title);
                const body = encodeURIComponent('Check out my presentation!');
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            },

            download() {
                const d = {
                    title: document.getElementById('title').value,
                    slides: this.data
                };
                const blob = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (d.title || 'presentation') + '.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('✅ Presentation downloaded to your device!');
            },

            shareLink() {
                const d = {
                    title: document.getElementById('title').value,
                    slides: this.data
                };
                const encoded = btoa(JSON.stringify(d));
                const link = window.location.origin + window.location.pathname + '?data=' + encoded;
                
                navigator.clipboard.writeText(link).then(() => {
                    alert('✅ Share link copied to clipboard!\n\n' + link);
                }).catch(() => {
                    prompt('Copy this link to share:', link);
                });
            },

            showSlideOptions() {
                alert('Slide options menu');
            },

            startSelectionBox(e) {
                const canvas = document.getElementById('canvas');
                const rect = canvas.getBoundingClientRect();
                
                this.selectionStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                
                this.selectionBox = document.createElement('div');
                this.selectionBox.className = 'selection-box';
                this.selectionBox.style.left = this.selectionStart.x + 'px';
                this.selectionBox.style.top = this.selectionStart.y + 'px';
                this.selectionBox.style.width = '0px';
                this.selectionBox.style.height = '0px';
                canvas.appendChild(this.selectionBox);
                
                let hasMoved = false;
                
                const onMove = (e) => {
                    if (!this.selectionBox) return;
                    
                    hasMoved = true;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const w = Math.abs(x - this.selectionStart.x);
                    const h = Math.abs(y - this.selectionStart.y);
                    const l = Math.min(x, this.selectionStart.x);
                    const t = Math.min(y, this.selectionStart.y);
                    
                    this.selectionBox.style.left = l + 'px';
                    this.selectionBox.style.top = t + 'px';
                    this.selectionBox.style.width = w + 'px';
                    this.selectionBox.style.height = h + 'px';
                };
                
                const onUp = () => {
                    if (!this.selectionBox) {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                        return;
                    }
                    
                    if (hasMoved && parseInt(this.selectionBox.style.width) > 5) {
                        const boxRect = {
                            left: parseFloat(this.selectionBox.style.left),
                            top: parseFloat(this.selectionBox.style.top),
                            right: parseFloat(this.selectionBox.style.left) + parseFloat(this.selectionBox.style.width),
                            bottom: parseFloat(this.selectionBox.style.top) + parseFloat(this.selectionBox.style.height)
                        };
                        
                        document.querySelectorAll('.canvas-element').forEach(el => {
                            const elRect = {
                                left: parseFloat(el.style.left),
                                top: parseFloat(el.style.top),
                                right: parseFloat(el.style.left) + el.offsetWidth,
                                bottom: parseFloat(el.style.top) + el.offsetHeight
                            };
                            
                            if (this.intersectsBox(boxRect, elRect)) {
                                if (!this.multiSel.includes(el)) {
                                    this.multiSel.push(el);
                                    el.classList.add('multi-selected');
                                }
                            }
                        });
                    }
                    
                    if (this.selectionBox && this.selectionBox.parentNode) {
                        this.selectionBox.remove();
                    }
                    this.selectionBox = null;
                    
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            },

            intersectsBox(rect1, rect2) {
                return !(rect1.right < rect2.left || 
                         rect1.left > rect2.right || 
                         rect1.bottom < rect2.top || 
                         rect1.top > rect2.bottom);
            },

            intersects(rect1, rect2) {
                return !(rect1.right < rect2.left || 
                         rect1.left > rect2.right || 
                         rect1.bottom < rect2.top || 
                         rect1.top > rect2.bottom);
            },

            intersectsBox(rect1, rect2) {
                return !(rect1.right < rect2.left || 
                         rect1.left > rect2.right || 
                         rect1.bottom < rect2.top || 
                         rect1.top > rect2.bottom);
            },

            selectAll() {
                this.clearSelection();
                document.querySelectorAll('.canvas-element').forEach(el => {
                    this.multiSel.push(el);
                    el.classList.add('multi-selected');
                });
            },

            clearSelection() {
                if (this.sel) {
                    this.sel.classList.remove('selected');
                    this.sel = null;
                }
                this.multiSel.forEach(el => el.classList.remove('multi-selected'));
                this.multiSel = [];
            },

            groupElements() {
                if (this.multiSel.length < 2) {
                    alert('⚠️ Select at least 2 elements to group');
                    return;
                }
                
                const ids = this.multiSel.map(el => parseInt(el.dataset.id));
                const elements = this.data[this.curr].els.filter(e => ids.includes(e.id));
                
                elements.forEach(el => el.grouped = true);
                this.saveState();
                alert('✅ Elements grouped! Use Ctrl+Shift+G to ungroup');
            },

            ungroupElements() {
                const ids = this.multiSel.length > 0 
                    ? this.multiSel.map(el => parseInt(el.dataset.id))
                    : this.sel ? [parseInt(this.sel.dataset.id)] : [];
                
                if (ids.length === 0) {
                    alert('⚠️ Select grouped elements first');
                    return;
                }
                
                this.data[this.curr].els.forEach(el => {
                    if (ids.includes(el.id)) el.grouped = false;
                });
                this.saveState();
                alert('✅ Elements ungrouped!');
            },

            copyStyle() {
                if (!this.sel) {
                    alert('⚠️ Select an element first');
                    return;
                }
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    this.copiedStyle = {
                        font: el.font,
                        size: el.size,
                        weight: el.weight,
                        color: el.color,
                        bg: el.bg,
                        align: el.align,
                        border: el.border,
                        thick: el.thick
                    };
                    alert('✅ Style copied! Select another element and click Paste Style');
                }
            },

            pasteStyle() {
                if (!this.copiedStyle) {
                    alert('⚠️ Copy a style first');
                    return;
                }
                
                if (!this.sel) {
                    alert('⚠️ Select target element');
                    return;
                }
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    if (el.type === 'text' && this.copiedStyle.font) {
                        el.font = this.copiedStyle.font;
                        el.size = this.copiedStyle.size;
                        el.weight = this.copiedStyle.weight;
                        el.color = this.copiedStyle.color;
                        el.bg = this.copiedStyle.bg;
                        el.align = this.copiedStyle.align;
                    }
                    if (el.type === 'shape' && this.copiedStyle.border) {
                        el.border = this.copiedStyle.border;
                        el.thick = this.copiedStyle.thick;
                        el.bg = this.copiedStyle.bg;
                    }
                }
                
                this.saveState();
                this.loadCanvas();
                alert('✅ Style applied!');
            },

            setBgColor() {
                document.getElementById('bgModal').classList.add('show');
            },

            applyBg(color) {
                this.data[this.curr].bg = color;
                const canvas = document.getElementById('canvas');
                canvas.style.background = color;
                canvas.style.backgroundImage = 'none';
                if (color.startsWith('linear-gradient')) {
                    canvas.style.background = color;
                }
                this.saveState();
                this.closeModal('bgModal');
            },

            uploadBgImage() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            this.data[this.curr].bg = `url(${ev.target.result})`;
                            const canvas = document.getElementById('canvas');
                            canvas.style.backgroundImage = this.data[this.curr].bg;
                            canvas.style.backgroundSize = 'cover';
                            canvas.style.backgroundPosition = 'center';
                            this.saveState();
                            this.closeModal('bgModal');
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },

            addShadow() {
                if (!this.sel) {
                    alert('⚠️ Select an element first');
                    return;
                }
                
                const shadow = prompt('Enter shadow (e.g., "0 4px 8px rgba(0,0,0,0.2)"):', '0 4px 12px rgba(0,0,0,0.15)');
                if (shadow) {
                    this.sel.style.boxShadow = shadow;
                    const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                    if (el) {
                        el.shadow = shadow;
                        this.saveState();
                    }
                }
            },

            showAnimations() {
                if (!this.sel) {
                    alert('⚠️ Select an element first');
                    return;
                }
                document.getElementById('animModal').classList.add('show');
            },

            applyAnimation(animation) {
                if (!this.sel) return;
                
                const el = this.data[this.curr].els.find(e => e.id == this.sel.dataset.id);
                if (el) {
                    el.animation = animation;
                    this.saveState();
                    this.closeModal('animModal');
                    alert(`✅ Animation "${animation}" applied! Preview in Presentation Mode`);
                }
            },

            presentMode() {
                this.presenting = true;
                this.presentSlide = 0;
                
                const presentDiv = document.createElement('div');
                presentDiv.className = 'present-mode active';
                presentDiv.innerHTML = `
                    <div class="present-slide">
                        <div class="present-canvas" id="presentCanvas"></div>
                    </div>
                    <div class="present-controls">
                        <button class="present-btn" onclick="app.prevPresentSlide()">◀</button>
                        <div class="present-counter"><span id="presentCounter">1 / ${this.data.length}</span></div>
                        <button class="present-btn" onclick="app.nextPresentSlide()">▶</button>
                        <button class="present-btn" onclick="app.exitPresent()">✕</button>
                    </div>
                `;
                document.body.appendChild(presentDiv);
                
                this.renderPresentSlide();
                
                document.addEventListener('keydown', this.presentKeyHandler = (e) => {
                    if (e.key === 'Escape') this.exitPresent();
                    if (e.key === 'ArrowRight' || e.key === ' ') this.nextPresentSlide();
                    if (e.key === 'ArrowLeft') this.prevPresentSlide();
                });
            },

            renderPresentSlide() {
                const canvas = document.getElementById('presentCanvas');
                if (!canvas) return;
                
                const slide = this.data[this.presentSlide];
                canvas.innerHTML = '';
                canvas.style.width = '960px';
                canvas.style.height = '540px';
                canvas.style.background = slide.bg || '#ffffff';
                canvas.style.position = 'relative';
                
                if (slide.bg && slide.bg.startsWith('url(')) {
                    canvas.style.backgroundImage = slide.bg;
                    canvas.style.backgroundSize = 'cover';
                    canvas.style.backgroundPosition = 'center';
                }
                
                const transition = slide.transition || 'fade';
                canvas.className = 'present-canvas slide-transition-' + transition;
                
                slide.els.forEach((el, index) => {
                    const div = this.createEl(el);
                    if (el.animation && el.animation !== 'none') {
                        setTimeout(() => {
                            div.classList.add('animate-' + el.animation);
                        }, index * 200);
                    }
                    canvas.appendChild(div);
                });
                
                document.getElementById('presentCounter').textContent = `${this.presentSlide + 1} / ${this.data.length}`;
            },

            nextPresentSlide() {
                if (this.presentSlide < this.data.length - 1) {
                    this.presentSlide++;
                    this.renderPresentSlide();
                }
            },

            prevPresentSlide() {
                if (this.presentSlide > 0) {
                    this.presentSlide--;
                    this.renderPresentSlide();
                }
            },

            exitPresent() {
                this.presenting = false;
                document.querySelector('.present-mode')?.remove();
                document.removeEventListener('keydown', this.presentKeyHandler);
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('show');
            }
        };

        window.onload = () => {
            app.init();
            
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('data');
            if (shared) {
                try {
                    const d = JSON.parse(atob(shared));
                    app.data = d.slides;
                    document.getElementById('title').value = d.title || '';
                    app.renderSlides();
                    app.loadCanvas();
                    app.saveState();
                } catch (e) {
                    console.error('Failed to load shared presentation');
                }
            }
        };
    </script>
</body>
</html>
                
